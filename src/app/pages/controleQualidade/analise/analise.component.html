<div class="menu">
    <ul nz-menu nzMode="horizontal" style="overflow-x: auto; white-space: nowrap; background-color:#f2f2f2;height: 40px;box-shadow: 2px 0 6px ; ">
        <li nz-menu-item nzMatchRouter="#">
            <a style="font-size: 13px;" routerLink="/welcome/controleQualidade/dashControle">Início</a>
        </li>
        <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-submenu nzTitle="Cadastros "  style="font-size: 13px; ">
            <ul>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/tipoEnsaio">Tipo de Ensaio</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/variavel">Variáveis de Ensaio</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/ensaio" >Ensaio</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/calculoEnsaio" >Cálculo de Ensaio</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/plano" >Plano de Análise</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/tipoAmostra" >Tipo de Amostra</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/produtoAmostra" >Produto de Amostra</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/garantia" >Garantias</a>
                </li>
            </ul>
        </li >
        <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;" routerLink="/welcome/controleQualidade/amostra">Amostras</a>
        </li>

        <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;" routerLink="/welcome/controleQualidade/ordem">Ordens de Serviço</a>
        </li>

        <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;">Banco de Análises</a>
        </li>

        <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;">Banco de Relatórios</a>
        </li>
    </ul>
</div>
<!-- Painel de Alertas de Rompimento -->
<div *ngIf="alertasRompimento.length > 0" class="alertas-rompimento-panel">
    <p-card class="mb-3">
        <ng-template #header>
            <div class="flex justify-content-between align-items-center p-3">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-exclamation-triangle text-orange-500"></i>
                    <span class="font-bold text-lg">Alertas de Rompimento</span>
                    <p-badge [value]="alertasRompimento.length" severity="warn"></p-badge>
                </div>
                <p-button 
                    icon="pi pi-times" 
                    severity="secondary" 
                    [text]="true"
                    size="small"
                    (click)="limparTodosAlertas()"
                    pTooltip="Limpar todos os alertas">
                </p-button>
            </div>
        </ng-template>
        <div class="grid">
            <div 
                *ngFor="let alerta of alertasRompimento" 
                class="col-12 md:col-6 lg:col-4 mb-2">
                <div 
                    class="p-3 border-round-md"
                    [ngClass]="{
                        'bg-red-50 border-red-200 border-1': alerta.tipo === 'vencido',
                        'bg-orange-50 border-orange-200 border-1': alerta.tipo === 'critico',
                        'bg-blue-50 border-blue-200 border-1': alerta.tipo === 'aviso'
                    }">
                    <div class="flex justify-content-between align-items-start mb-2">
                        <p-badge 
                            [value]="alerta.tipo.toUpperCase()" 
                            [severity]="alerta.tipo === 'vencido' ? 'danger' : alerta.tipo === 'critico' ? 'warn' : 'info'">
                        </p-badge>
                        <p-button 
                            icon="pi pi-times" 
                            [text]="true"
                            size="small"
                            (click)="removerAlerta(alerta.id)"
                            pTooltip="Remover alerta">
                        </p-button>
                    </div>
                    <p class="m-0 mb-2 font-semibold">{{ alerta.ensaio }}</p>
                    <p class="m-0 text-sm text-600">
                        <i class="pi pi-calendar mr-1"></i>
                        Rompimento: {{ alerta.dataRompimento }}
                    </p>
                    <p class="m-0 text-sm" 
                       [ngClass]="{
                         'text-red-600': alerta.tipo === 'vencido',
                         'text-orange-600': alerta.tipo === 'critico',
                         'text-blue-600': alerta.tipo === 'aviso'
                       }">
                        <i class="pi pi-clock mr-1"></i>
                        {{ alerta.diasRestantes < 0 ? 'Vencido há ' + Math.abs(alerta.diasRestantes) + ' dia(s)' :
                           alerta.diasRestantes === 0 ? 'Vence hoje!' :
                           'Vence em ' + alerta.diasRestantes + ' dia(s)' }}
                    </p>
                </div>
            </div>
        </div>
    </p-card>
</div>
<!-- CONTAINER -->
<div class="container">
    <!-- DETALHES DA AMOSTRA -->
    <div class="form-geral flex flex-column align-items-center" @swipeAnimation>
        <div class="step1 w-12 mt-3">
            <p-card class="card" *ngIf="analise">
                    <ng-template #header>
                        <div class="header flex flex-row justify-content-between gap-2 px-2">
                            <h2>Amostra</h2>
                            <h2>
                                Amostra N°: <b>{{ analise.amostra_detalhes?.numero }}</b>
                            </h2>
                        </div>
                    </ng-template>
                    <div class="flex flex-column w-12 lg:flex-row">
                        <div class="text-left w-4 ">
                            <p><b>Data de Coleta:</b> {{ analise.amostra_detalhes?.data_coleta | date:'dd/MM/yyyy' }}</p>
                            <p><b>Digitador:</b> {{ analise.amostra_detalhes?.digitador }}</p>
                            <p><b>Material:</b> {{ analise.amostra_detalhes?.material }}</p>
                        </div>
                        <div class="text-left w-4">
                            <p><b>Finalidade:</b> {{ analise.amostra_detalhes?.finalidade }}</p>
                            <p><b>Produto:</b> {{ analise.amostra_detalhes?.produto_amostra_detalhes?.nome }}</p>
                            <p><b>Data Entrada:</b> {{ analise.amostra_detalhes?.data_entrada  | date:'dd/MM/yyyy' }}</p>
                        </div>
                        <div class="text-left w-4">
                            <p><b>Fornecedor:</b> {{ analise.amostra_detalhes?.fornecedor }}</p>
                            <p><b>Local de Coleta:</b> {{ analise.amostra_detalhes?.local_coleta }}</p>
                            <p><b>Status:</b> {{ analise.amostra_detalhes?.status }}</p>
                        </div>    
                    </div>
                    <div class="flex flex-column lg:flex-row align-items-center w-full">
                        <div class="col-12 lg:col-4 flex justify-content-center lg:justify-content-start">
                            <p-button
                            class="w-full lg:w-auto"
                            label="Imagens"
                            [raised]="true"
                            severity="success"
                            icon="pi pi-image"
                            iconPos="right"
                            (onClick)="visualizarImagens(analise.amostra_detalhes?.id)">
                            </p-button>
                        </div>
                        <div class="col-12 lg:col-4 flex justify-content-center lg:justify-content-start">
                            <p-button
                            class="w-full lg:w-auto"
                            label="Garantias"
                            [raised]="true"
                            severity="warn"
                            icon="pi pi-shield"
                            iconPos="right"
                            (onClick)="consultarGarantia()">
                            </p-button>
                        </div>

                        <div class="text-left w-8"> 
                            <p-floatlabel variant="on"> 
                                <textarea 
                                    pTextarea 
                                    [value]="analise.amostra_detalhes?.observacoes" 
                                    id="on_label" 
                                    rows="5" 
                                    cols="30" 
                                    class="h-full w-full" 
                                    style="border-radius: 5px; background-color: #444959; color: white;" >
                                </textarea> 
                                <label for="in_label">Observações:</label> 
                            </p-floatlabel> 
                        </div>
                    </div>
                    <div *ngIf="analise.amostra_detalhes.material==='Argamassa'" class="flex flex-column mt-3 lg:flex-row w-full lg:justify-content-around">
                        <div class="flex flex-column w-5 gap-3">
                            <p-floatLabel variant="on"> 
                                <p-select
                                    variant="filled"
                                    inputId="float-label"
                                    [style]="{'width':'100%'}"
                                    [options]="metodosModelagem" 
                                    [(ngModel)]="analise.metodoModelagem"
                                    optionLabel="value"
                                    optionValue="value"
                                    [filter]="true" 
                                    filterBy="value"
                                    [showClear]="true"
                                    appendTo="body"
                                >
                                </p-select>
                                <label for="float-label">Método de Modelagem Ensaios LAB</label>
                            </p-floatLabel>
                             <p-floatLabel variant="on"> 
                                <p-select
                                    variant="filled"
                                    inputId="float-label"
                                    [style]="{'width':'100%'}"
                                    [options]="metodosModelagem" 
                                    [(ngModel)]="analise.metodoMuro"
                                    optionLabel="value"
                                    optionValue="value"
                                    [filter]="true" 
                                    filterBy="value"
                                    [showClear]="true"
                                    appendTo="body"
                                >
                                </p-select>
                                <label for="float-label">Método de Modelagem Aplicação no Muro</label>
                            </p-floatLabel>  
                        </div>
                        <div class="w-6">
                            <div class="text-left w-12"> 
                                <p-floatlabel variant="on"> 
                                    <textarea 
                                        pTextarea 
                                        [(ngModel)]="analise.observacoesMuro"
                                        id="on_label" 
                                        rows="5" 
                                        cols="30" 
                                        class="h-full w-full" 
                                        style="border-radius: 5px; background-color: #444959; color: white;" >
                                    </textarea> 
                                    <label for="in_label">Observações:Aplicação no Muro</label> 
                                </p-floatlabel> 
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-column mt-3 lg:flex-row w-full lg:justify-content-around">
                        
                    </div>
            </p-card>
        </div>
        <!-- TABELAS ENSAIOS E CALCULOS-->
        <div class="w-12 mt-4">
            <div *ngFor="let plano of analisesSimplificadas[0]?.planoDetalhes">
                <div class="step1 mb-5">    
                    <p-message severity="info" class="w-11">
                        Plano de Análise: <b> {{ plano.descricao }}</b>
                    </p-message>
                </div>    
                <!-- Tabela para cada ensaio fixo (fora dos cálculos) -->
                <div class="step1">     
                    <div class=" w-full flex justify-content-between align-items-center">
                        <h2 style="color: #ffffff">Ensaios Diretos</h2>
                        <div class="flex gap-2" *ngIf="podeEditarEnsaiosCalculos()">
                            <p-button 
                                icon="pi pi-plus" 
                                label="Adicionar Ensaio" 
                                severity="warn" 
                                [raised]="true" 
                                size="small"
                                (onClick)="abrirModalAdicionarEnsaios()" 
                                pTooltip="Adicionar novo ensaio à análise"
                                tooltipPosition="top"
                            >
                            </p-button>
                        </div>
                    </div>
                    <!--ENSAIOS-->        
                    <div>
                        <p-table
                            #dt1 
                            class="ensaio-table-spacing" 
                            [value]="plano.ensaio_detalhes"
                            [tableStyle]="{'min-width': '70rem'}"
                            [dataKey]="'id'"
                            [globalFilterFields]="['descricao','unidade','norma','valor','responsavel','numero_cadinho']"
                        >
                            <ng-template pTemplate="caption">
                                <div class="flex flex-row md: justify-content-end">
                                    <p-floatlabel variant="on">
                                        <p-iconfield>
                                            <p-inputicon class="pi pi-search" style="color: #1b91ff;" />
                                                <input 
                                                    variant="filled" 
                                                    [(ngModel)]="inputValue"
                                                    [style]="{'width':'100%'}" 
                                                    pInputText id="on_label"
                                                    autocomplete="off" 
                                                    type="text" 
                                                    (ngModelChange)="dt1.filterGlobal($event, 'contains')"
                                                />
                                        </p-iconfield>
                                        <label for="on_label" style="color: #1b91ff">Pesquisar</label>
                                    </p-floatlabel>
                                </div>
                            </ng-template>
                            <ng-template pTemplate="header">
                                <tr class="tabela">
                                    <th style="width: 5%;">
                                        <p-button
                                            [text]="true"
                                            [plain]="true"
                                            size="small"
                                            [icon]="todasExpandidas ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                            (click)="toggleTodasLinhas()"
                                            pTooltip="Expandir/Recolher todas as linhas">
                                        </p-button>
                                    </th>
                                    <!-- Drag handle header (móvel) -->
                                    <th style="width: 4%;"></th>
                                    <th style="width: 30%; text-align: left;" field="ensaio" display="menu">Ensaio</th>
                                    <th style="width: 35%; text-align: right;">Resultado</th>
                                    <th style="width: 15%; text-align: right;">Histórico</th>
                                    <th style="width: 15%; text-align: right;" *ngIf="podeEditarEnsaiosCalculos()">Ações</th>
                                </tr>
                            </ng-template>
                            <!-- Linha principal -->
                            <ng-template pTemplate="body" let-ensaio let-rowIndex="rowIndex">
                                <tr 
                                    class="row"
                                    [ngClass]="getClasseTipoEnsaio(ensaio)"
                                    [class.row-expanded]="ensaio.expanded" 
                                    draggable="true"
                                    (dragstart)="onDragStart($event, ensaio, rowIndex, plano)"
                                    (dragover)="onDragOver($event)"
                                    (drop)="onDrop($event, ensaio, rowIndex, plano)"
                                    style="cursor: grab;"
                                    [style.opacity]="ensaio.expanded ? '0.7' : '1'"
                                >        
                                    <td>
                                        <p-button
                                            [text]="true"
                                            [plain]="true"
                                            size="small"
                                            [icon]="ensaio.expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                            (click)="toggleEnsaioExpansion(ensaio)">
                                        </p-button>
                                    </td>
                                            <!-- Drag handle cell (móvel) -->
                                    <td>
                                        <span 
                                            class="pi pi-sort-alt" 
                                            style="cursor: move; font-size: 1.2em; color: #6c757d;"
                                            title="Arrastar para reordenar">
                                        </span>
                                    </td>
                                    <td>
                                        <div class="flex align-items-start justify-content-start gap-2">
                                            <i class="pi pi-file-edit text-primary"></i>
                                            <span class="font-bold text-lg">{{ ensaio.descricao }}</span>
                                            <span class="text-sm text-600 ml-2">({{ ensaio.unidade }})</span>
                                            <span class="text-sm text-600 ml-2" *ngIf="analise.amostra_detalhes?.material==='cal'">({{ ensaio.norma }})</span>
                                        </div>
                                    </td>
                                    <td style="text-align: end;">
                                        <div class="flex align-items-end justify-content-end">
                                            <span class="valor-result font-bold text-lg text-primary">
                                                {{ ensaioTemVariavelData(ensaio) ? (formatarDataExibicao(ensaio.valorTimestamp || ensaio.valor) || '—') : (ensaio.valor || 0) }}
                                            </span>
                                        </div>
                                        <div 
                                            *ngIf="ensaioTemVariavelData(ensaio) && ensaio.tipo_ensaio_detalhes?.nome !== 'Resistencia'" 
                                            class="text-xs text-500 mt-1"
                                        >
                                            {{ ensaioTemVariavelData(ensaio) ? 'Rompimento' : 'Resultado' }}
                                        </div>
                                    </td>
                                    <td style="text-align: end;">
                                        <p-button 
                                            icon="pi pi-history" 
                                            severity="success" 
                                            size="small" 
                                            [raised]="true"
                                            (onClick)="abrirDrawerResultadosEnsaios(ensaio)"
                                            [loading]="carregandoResultados && ensaioSelecionadoParaPesquisa?.descricao === ensaio.descricao"
                                            pTooltip="Ver resultados anteriores" 
                                            tooltipPosition="top"
                                        >
                                        </p-button>
                                    </td>
                                    <td *ngIf="podeEditarEnsaiosCalculos()" class="text-right">
                                        <p-button 
                                            icon="pi pi-trash" 
                                            severity="danger" 
                                            [raised]="true" 
                                            size="small"
                                            (onClick)="removerEnsaio(ensaio, plano)" 
                                            pTooltip="Remover ensaio"
                                            tooltipPosition="top"
                                        >
                                        </p-button>
                                    </td>
                                </tr>                    
                                <!-- Linha expandida (condicional) - Separada para não interferir no reordenamento -->
                                <tr *ngIf="ensaio.expanded" class="expanded-row">
                                    <td [attr.colspan]="podeEditarEnsaiosCalculos() ? 6 : 5" style="background-color: #2C323A; padding: 0;">
                                        <div class="p-3" style="background-color: #2C323A;">
                                            <div class="header flex justify-content-between align-items-center">
                                                <h2 class="text-2xl font-bold text-primary"><i class="pi pi-objects-column"></i> {{ ensaio.descricao }}
                                                </h2>
                                            </div>                                
                                            <div class="expanded-row flex flex-column w-12 lg:flex-row">
                                                <!-- Variáveis -->
                                                <div class="flex flex-column w-7">
                                                    <div class="flex  gap-1" *ngIf="ensaio.variavel_detalhes && ensaio.variavel_detalhes.length > 0">
                                                        <div class="flex flex-wrap w-12 gap-1">
                                                            <div 
                                                                class="flex flex-wrap"
                                                                *ngFor="let variavel of getVariaveisOrdenadas(ensaio.variavel_detalhes)"
                                                            >
                                                                <p-floatlabel variant="in">
                                                                    <!-- Input para data -->
                                                                    <p-datepicker 
                                                                        *ngIf="isVariavelTipoData(variavel)" 
                                                                        [showIcon]="true"
                                                                        variant="filled" 
                                                                        size="small" 
                                                                        [style]="{'width':'100%'}" 
                                                                        appendTo="body"
                                                                        id="variavel_{{variavel.id || variavel.nome}}" [(ngModel)]="variavel.valorData"
                                                                        (ngModelChange)="atualizarVariavelData(ensaio, variavel, $event)"
                                                                        dateFormat="dd/mm/yy"
                                                                        appendTo="body"
                                                                    >
                                                                    </p-datepicker>
                                                                    <!-- Input numérico (padrão) -->
                                                                    <p-inputnumber 
                                                                        *ngIf="!isVariavelTipoData(variavel)" 
                                                                        mode="decimal"
                                                                        [minFractionDigits]="2" 
                                                                        [maxFractionDigits]="8" 
                                                                        variant="filled" 
                                                                        size="large"
                                                                        [style]="{'width':'100%'}" id="variavel_{{variavel.id || variavel.nome}}"
                                                                        showButtons="false" [(ngModel)]="variavel.valor"
                                                                        (ngModelChange)="atualizarVariavelEnsaio(ensaio, variavel, $event)" 
                                                                    />
                                                                    <label for="variavel_{{variavel.id || variavel.nome}}">
                                                                        {{ getVariavelDisplayName(variavel, ensaio) }}
                                                                    </label>
                                                                </p-floatlabel>
                                                            </div>
                                                        </div>
                                                    </div>                   
                                                    <!-- Para ensaios simples (sem variavel_detalhes) -->
                                                    <div *ngIf="!ensaio.variavel_detalhes || ensaio.variavel_detalhes.length === 0">
                                                        <div class="flex flex-column">
                                                            <p-floatlabel variant="in">
                                                                <input
                                                                    variant="filled"
                                                                    pInputText
                                                                    showButtons="false"
                                                                    type="number"
                                                                    [(ngModel)]="ensaio.valor" 
                                                                    [style]="{'width':'30%'}"
                                                                    id="ensaio_valor_{{ensaio.id}}"
                                                                    (ngModelChange)="onValorEnsaioChange(ensaio, $event)"
                                                                />
                                                                <label>{{ ensaio.descricao }}</label>
                                                            </p-floatlabel>
                                                        </div>
                                                    </div>
                                                    <div class="flex flex-row justify-content-start w-12">
                                                        <div 
                                                            class="resultado flex flex-column mt-3 w-6 justify-content-end"
                                                            [ngClass]="{ negativo: (+ensaio.valor || 0) < 0 }"
                                                           
                                                        >
                                                            <div class="bg-gray-50 border-round mt-2 text-center">
                                                                <label class="text-sm font-medium">Resultado</label>
                                                            </div>
                                                            <div class="bg-gray-50 border-round mt-2 text-center">
                                                                <span 
                                                                    class="text-2xl font-bold text-primary resultado-valor"
                                                                >
                                                                    {{ ensaioTemVariavelData(ensaio) ? (formatarDataExibicao(ensaio.valorTimestamp || ensaio.valor) || '—') : (ensaio.valor || 0) }}
                                                                </span>
                                                                <span class="ml-2 text-lg text-600">{{ ensaio.unidade }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex flex-column w-5">
                                                    <div   
                                                        class="flex flex-column gap-1 w-12 lg:flex-row" 
                                                    >
                                                        <!-- Técnico -->
                                                        <div class="w-6">
                                                            <p-floatLabel variant="in">
                                                                <p-select 
                                                                    [style]="{'width':'100%'}"
                                                                    [options]="responsaveis" 
                                                                    optionLabel="value"
                                                                    optionValue="value" 
                                                                    [(ngModel)]="ensaio.responsavel" 
                                                                    appendTo="body" 
                                                                    [filter]="true"
                                                                    filterBy="value" 
                                                                    [showClear]="true"
                                                                >
                                                                </p-select>
                                                                <label for="float-label">Selecione o Responsável</label>
                                                            </p-floatLabel>
                                                        </div>
                                                        <!-- Nº Cadinho -->
                                                        <div class="w-6"  *ngIf="ensaio.descricao.includes('PF - Perda ao Fogo') || ensaio.descricao.includes('Ri + SiO₂')">
                                                            <p-floatLabel variant="in">
                                                                <p-inputnumber 
                                                                    [(ngModel)]="ensaio.numero_cadinho" 
                                                                    [showButtons]="true" 
                                                                    [min]="1"
                                                                    [max]="9999" 
                                                                    mode="decimal" 
                                                                    [useGrouping]="false"
                                                                    [size]="'small' " 
                                                                >
                                                                </p-inputnumber>
                                                                <label for="float-label">Nº Cadinho</label>
                                                            </p-floatLabel>
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-2 mt-5 w-6">
                                                        <p-button 
                                                            icon="pi pi-book" 
                                                            severity="warn" 
                                                            [raised]="true" 
                                                            size="small"
                                                            (click)="ensaioSelecionado = ensaio; popoverDetalhes.toggle($event)"
                                                            pTooltip="Ver detalhes técnicos do ensaio" 
                                                            tooltipPosition="top"
                                                        >
                                                        </p-button>
                                                        <p-button 
                                                            severity="success" 
                                                            pTooltip="Alterar ordem das variáveis" 
                                                            tooltipPosition="top"
                                                            size="small" 
                                                            [raised]="true" 
                                                            icon="pi pi-arrows-v"
                                                            (click)="abrirModalOrdemVariaveis(ensaio)"
                                                        >
                                                        </p-button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div> 
                    <!-- Popover para detalhes do ensaio -->
                    <p-popover #popoverDetalhes>
                        <ng-template #content>
                            <div 
                                class="p-3" 
                                style="min-width: 500px;" 
                                *ngIf="ensaioSelecionado"
                            >
                                <div class="header w-full text-left mb-3">
                                    <h2>Detalhes do Ensaio: {{ ensaioSelecionado.descricao }}</h2>
                                </div>
                                
                                <!-- Informações do ensaio -->
                                <div class="flex flex-column gap-3">
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">ID do Ensaio</label>
                                        <span class="text-lg">{{ ensaioSelecionado.id }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Descrição</label>
                                        <span class="text-lg">{{ ensaioSelecionado.descricao }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Tipo de Ensaio</label>
                                        <span class="text-lg">{{ ensaioSelecionado.tipo_ensaio_detalhes?.nome || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Unidade</label>
                                        <span class="text-lg">{{ ensaioSelecionado.unidade || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Tempo Previsto</label>
                                        <span class="text-lg">{{ ensaioSelecionado.tempo_previsto || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Fórmula do Ensaio</label>
                                        <p-floatlabel variant="on">
                                            <p-iconfield>
                                                <p-inputicon class="pi pi-calculator" />
                                                <input 
                                                    variant="filled" 
                                                    [style]="{'width':'100%'}" 
                                                    pInputText
                                                    id="funcao_ensaio_{{ensaioSelecionado.id}}" 
                                                    autocomplete="off"
                                                    [(ngModel)]="ensaioSelecionado.funcao" 
                                                    type="text" 
                                                    readonly 
                                                />
                                            </p-iconfield>
                                            <label for="funcao_ensaio_{{ensaioSelecionado.id}}">Fórmula</label>
                                        </p-floatlabel>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Variável Técnica</label>
                                        <span class="text-lg">{{ ensaioSelecionado.tecnica || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Valor Atual</label>
                                        <span class="text-2xl font-bold text-primary">
                                            {{ ensaioTemVariavelData(ensaioSelecionado) ? (formatarDataExibicao(ensaioSelecionado?.valorTimestamp || ensaioSelecionado?.valor) || '—') : (ensaioSelecionado?.valor || 0) }}
                                            <span class="text-lg text-600 ml-2">{{ ensaioSelecionado.unidade }}</span>
                                        </span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Responsável</label>
                                        <span class="text-lg">{{ ensaioSelecionado.responsavel || 'Não atribuído' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Nº do Cadinho</label>
                                        <span class="text-lg">{{ ensaioSelecionado.numero_cadinho || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Quantidade de Variáveis</label>
                                        <span class="text-lg">{{ ensaioSelecionado.variavel_detalhes?.length || 0 }} variável(is)</span>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </p-popover>                  
                </div>
                <!-- Tabela de Cálculos -->
                <div class="step1 mt-5">
                    <div class="header w-full flex justify-content-between align-items-center">
                        <h2 style="color: #ffffff">Cálculos</h2>
                        <div class="flex gap-2" *ngIf="podeEditarEnsaiosCalculos()">
                            <p-button 
                                icon="pi pi-plus" 
                                label="Adicionar Cálculo" 
                                severity="warn" 
                                [raised]="true" 
                                size="small"
                                (onClick)="abrirModalAdicionarCalculos()" 
                                pTooltip="Adicionar novo cálculo à análise"
                                tooltipPosition="top"
                            >
                            </p-button>
                        </div>
                    </div> 
                    <div class="tabela-ensaio-wrap">
                        <p-table
                            #tabelaCalculos 
                            class="ensaio-table-spacing" 
                            [value]="plano.calculo_ensaio_detalhes"
                            [tableStyle]="{'min-width': '70rem'}" 
                            [dataKey]="'id'"
                            [globalFilterFields]="['descricao','unidade','resultado','responsavel','digitador','ensaios_detalhes.descricao']"
                        >
                            <ng-template pTemplate="caption">
                                <div class="flex flex-row md: justify-content-end">
                                    <p-floatlabel variant="on">
                                        <p-iconfield>
                                            <p-inputicon class="pi pi-search" style="color: #1b91ff;" />
                                            <input
                                                variant="filled"
                                                [(ngModel)]="inputCalculos"
                                                [style]="{'width':'100%'}"
                                                pInputText id="calc_search"
                                                autocomplete="off"
                                                type="text"
                                                (ngModelChange)="tabelaCalculos.filterGlobal($event, 'contains')"
                                            />
                                        </p-iconfield>
                                        <label for="calc_search" style="color: #1b91ff">Pesquisar cálculos</label>
                                    </p-floatlabel>
                                </div>
                            </ng-template>
                            <ng-template pTemplate="header">
                                <tr class="tabela">
                                    <th style="width: 5%;">
                                        <p-button 
                                            [text]="true" 
                                            [plain]="true" 
                                            size="small"
                                            [icon]="todasCalculosExpandidas ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                            (click)="toggleTodasCalculos()" pTooltip="Expandir/Recolher todos os cálculos">
                                        </p-button>
                                    </th>
                                    <!-- Drag handle header para cálculos -->
                                    <th style="width: 4%;"></th>
                                    <th style="width: 30%; text-align: left;">Cálculo</th>
                                    <th style="width: 35%; text-align: right;">Resultado</th>
                                    <th style="width: 15%; text-align: right;">Histórico</th>
                                    <th style="width: 15%; text-align: right;" *ngIf="podeEditarEnsaiosCalculos()">Ações</th>
                                </tr>
                            </ng-template>               
                            <!-- Linha principal do cálculo -->
                            <ng-template pTemplate="body" let-calc let-rowIndex="rowIndex">
                                <tr 
                                    class="row" 
                                    draggable="true" 
                                    (dragstart)="onDragStartCalculo($event, calc, rowIndex, plano)"
                                    (dragover)="onDragOver($event)" (drop)="onDropCalculo($event, calc, rowIndex, plano)"
                                    style="cursor: grab;" [style.opacity]="calc.expanded ? '0.7' : '1'"
                                >
                                    <td>
                                        <p-button 
                                            [text]="true" 
                                            [plain]="true" 
                                            size="small"
                                            [icon]="calc.expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                            (click)="toggleCalculoExpansion(calc)">
                                        </p-button>
                                    </td>
                                    <!-- Drag handle cell for cálculos -->
                                    <td>
                                        <span 
                                            class="pi pi-sort-alt" 
                                            style="cursor: move; font-size: 1.2em; color: #6c757d;"
                                            title="Arrastar para reordenar"
                                        >
                                        </span>
                                    </td>
                                    <td>
                                        <div class="flex align-items-start justify-content-start gap-2">
                                            <i class="pi pi-calculator text-primary"></i>
                                            <span class="font-bold text-lg">{{ calc.descricao }}</span>
                                            <span class="text-sm text-600 ml-2">({{ calc.unidade }})</span>
                                        </div>
                                    </td>
                                    <td style="text-align: end;">
                                        <div class="flex align-items-end justify-content-end gap-2">
                                            <span class="valor-result font-bold text-lg text-primary">
                                                {{ calcResultadoEhData(calc) ? formatarDataExibicao(calc.resultado) : (typeof calc.resultado === 'number' ? formatForDisplay(calc.resultado) : (calc.resultado || 0)) }}
                                            </span>
                                            <span class="text-sm text-600" *ngIf="calc.unidade">
                                                {{ calc.unidade }}
                                            </span>
                                        </div>
                                    </td>
                                    <td style="text-align: end;">
                                        <p-button 
                                            icon="pi pi-history" 
                                            severity="success" 
                                            size="small" 
                                            [raised]="true"
                                            (onClick)="abrirDrawerResultados(calc, plano)"
                                            [loading]="carregandoResultados && calculoSelecionadoParaPesquisa?.descricao === calc.descricao"
                                            pTooltip="Ver resultados anteriores" 
                                            tooltipPosition="top"
                                        >
                                        </p-button>
                                    </td>
                                    <td *ngIf="podeEditarEnsaiosCalculos()" class="text-right">
                                        <p-button 
                                            icon="pi pi-trash" 
                                            severity="danger" 
                                            [raised]="true" 
                                            size="small"
                                            (onClick)="removerCalculo(calc, plano)" 
                                            pTooltip="Remover cálculo" 
                                            tooltipPosition="top"
                                        >
                                        </p-button>
                                    </td>
                                </tr>
                                <!-- Linha expandida do cálculo (condicional) - Separada para não interferir no reordenamento -->
                                <tr *ngIf="calc.expanded" class="expanded-row">
                                    <td 
                                        [attr.colspan]="podeEditarEnsaiosCalculos() ? 6 : 5"
                                        style="background-color: #2C323A; padding: 0;"
                                    >
                                        <div class="p-3">
                                            <div class="header flex justify-content-between align-items-center">
                                                <h2 style="color: #ffffff">Ensaios pertencentes ao Cálculo: <b>{{ calc.descricao }}</b></h2>
                                            </div>
                                            <div class="flex flex-column lg:flex-row lg:w-12">
                                                <div class="flex flex-column w-12">
                                                    <div 
                                                        class="flex flex-column gap-3"
                                                        *ngIf="calc.ensaios_detalhes && calc.ensaios_detalhes.length > 0"
                                                    >
                                                        <div class="flex w-12 justify-content-end">
                                                            <p-floatlabel variant="on">
                                                                <p-iconfield>
                                                                    <p-inputicon class="pi pi-search" style="color: #1b91ff;" />
                                                                    <input
                                                                        variant="filled"
                                                                        [(ngModel)]="calc._filtroEnsaios"
                                                                        [style]="{'width':'20rem'}"
                                                                        pInputText id="calc_ensaio_search_{{calc.id}}"
                                                                        autocomplete="off"
                                                                        type="text"
                                                                    />
                                                                </p-iconfield>
                                                                <label for="calc_ensaio_search_{{calc.id}}" style="color: #1b91ff">Pesquisar ensaios</label>
                                                            </p-floatlabel>
                                                        </div>
                                                        <div 
                                                            class="flex flex-column w-12 border-500 surface-overlay border-2 border-round-lg p-2 mb-2"
                                                            *ngFor="let ensaio of getEnsaiosFiltrados(calc); let i = index" 
                                                            draggable="true"
                                                            (dragstart)="onDragStartEnsaioInterno($event, ensaio, i, calc, plano)"
                                                            (dragover)="onDragOver($event)"
                                                            (drop)="onDropEnsaioInterno($event, ensaio, i, calc, plano)"

                                                        >
                                                            <div class="align-items-center gap-2">
                                                                <div class="flex align-items-center gap-2">
                                                                    <i class="pi pi-flask text-primary"></i>
                                                                    <span class="font-bold">{{ ensaio.descricao }}</span>
                                                                </div>
                                                                <span 
                                                                    class="pi pi-sort-alt"
                                                                    style="cursor: move; font-size: 1.1em; color: #6c757d;"
                                                                    title="Arrastar para reordenar"
                                                                >
                                                                </span>
                                                            </div>
                                                            <!-- Variáveis do ensaio (se houver) -->
                                                            <div 
                                                                class="mt-2 ml-3"
                                                                *ngIf="ensaio.variavel_detalhes || ensaio.variavel_detalhes.length"
                                                            >
                                                                <div class="flex flex-column w-12 lg:flex-row">
                                                                    <div class="flex flex-column w-8 gap-1">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <div 
                                                                                class="flex flex-row"
                                                                                *ngFor="let variavel of getVariaveisOrdenadas(ensaio.variavel_detalhes)"
                                                                            >
                                                                                <p-floatlabel variant="in">
                                                                                    <p-datepicker 
                                                                                        *ngIf="isVariavelTipoData(variavel)"
                                                                                        [showIcon]="true"
                                                                                        [(ngModel)]="variavel.valorData"
                                                                                        (ngModelChange)="atualizarVariavelEnsaioDentroCalculo(plano, ensaio, variavel, $event)"
                                                                                        dateFormat="dd/mm/yy" [showIcon]="true"
                                                                                        inputId="variavel_{{variavel.id || variavel.nome}}"
                                                                                        [style]="{'width':'100%'}"
                                                                                        appendTo="body"
                                                                                    >
                                                                                    </p-datepicker>
                                                                                    <input 
                                                                                        *ngIf="!isVariavelTipoData(variavel)"
                                                                                        pInputText
                                                                                        type="number"
                                                                                        variant="filled"
                                                                                        size="small" 
                                                                                        [style]="{'width':'100%'}"
                                                                                        id="variavel_{{variavel.id || variavel.nome}}"
                                                                                        showButtons="false" 
                                                                                        [(ngModel)]="variavel.valor"
                                                                                        (ngModelChange)="atualizarVariavelEnsaio(ensaio, variavel, $event)" 
                                                                                    />
                                                                                    <label
                                                                                        for="variavel_{{variavel.id || variavel.nome}}">
                                                                                        {{ getVariavelDisplayName(variavel, ensaio) }}
                                                                                    </label>
                                                                                </p-floatlabel>
                                                                            </div>
                                                                        </div>
                                                                        <div 
                                                                            class="resultado flex flex-column mt-3 w-6 justify-content-end"
                                                                            [ngClass]="{ negativo: (+ensaio.valor || 0) < 0 }"
                                                                            
                                                                        >
                                                                            <div class="bg-gray-50 border-round mt-2 text-center">
                                                                                <label class="text-sm font-medium">Resultado </label>
                                                                                <label class="text-sm font-medium" *ngIf="ensaio.descricao.toLowerCase()==='data moldagem'">Data Rompimento</label>
                                                                            </div>
                                                                            <div class="bg-gray-50 border-round mt-2 text-center">
                                                                                <span class="text-2xl font-bold text-primary">
                                                                                   {{ ensaioTemVariavelData(ensaio) || ensaio.tipo_ensaio_detalhes.nome=== 'data' && !ensaio.descricao.toLowerCase().includes('variação') ? (formatarDataExibicao(ensaio.valorTimestamp || ensaio.valor) || '—') :  ensaio.valor || 0 }}
                                                                                </span>
                                                                                <span class="ml-2 text-lg text-600">{{ ensaio.unidade }}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>           
                                                                    <div class="flex flex-column w-4">
                                                                        <div class="flex flex-column w-12 gap-1">
                                                                            <div class="w-10">
                                                                                <p-floatLabel variant="in">
                                                                                    <p-select 
                                                                                        [style]="{'width':'100%'}"
                                                                                        [options]="responsaveis" optionLabel="value"
                                                                                        inputId="label"
                                                                                        optionValue="value"
                                                                                        [(ngModel)]="ensaio.responsavel"
                                                                                        (ngModelChange)="onResponsavelEnsaioDentroCalculoChange(plano, ensaio, $event)"
                                                                                        appendTo="body" [filter]="true" filterBy="value"
                                                                                        [showClear]="true">
                                                                                    </p-select>
                                                                                    <label for="label">Responsável</label>
                                                                                </p-floatLabel>
                                                                            </div>
                                                                            <div class="w-2" *ngIf="ensaio.descricao.includes('PF - Perda ao Fogo') || ensaio.descricao.includes('Ri + SiO₂')">
                                                                                <p-floatLabel variant="in">
                                                                                    <p-inputnumber 
                                                                                        [(ngModel)]="ensaio.numero_cadinho"
                                                                                        (ngModelChange)="onNumeroCadinhoDentroCalculoChange(plano, ensaio, $event)"
                                                                                        [showButtons]="true" [min]="1" [max]="9999"
                                                                                        mode="decimal" [useGrouping]="false" size="small"
                                                                                        [style]="{'width':'100%'}"
                                                                                    >
                                                                                    </p-inputnumber>
                                                                                    <label>Nº Cadinho</label>
                                                                                </p-floatLabel>
                                                                            </div>
                                                                        </div>
                                                                        <div class="flex flex-column w-12  lg:flex-row">
                                                                            <div class="flex gap-1 mt-2 w-4">
                                                                                <p-button 
                                                                                    icon="pi pi-book" 
                                                                                    severity="warn"
                                                                                    [raised]="true" size="small"
                                                                                    (click)="ensaioSelecionado = ensaio; popoverDetalhes.toggle($event)"
                                                                                    pTooltip="Ver detalhes técnicos do ensaio"
                                                                                    tooltipPosition="top"
                                                                                >
                                                                                </p-button>
                                                                                <p-button 
                                                                                    severity="success"
                                                                                    pTooltip="Alterar ordem das variáveis"
                                                                                    tooltipPosition="top" size="small" [raised]="true"
                                                                                    icon="pi pi-arrows-v"
                                                                                    (click)="abrirModalOrdemVariaveis(ensaio)"
                                                                                >
                                                                                </p-button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                class="flex flex-column lg:flex-row w-12 align-items-end   border-3  border-round-lg"
                                                style="background-color: #444959; color: #ffffff;"
                                            >
                                                <div class="w-1 m-3">
                                                    <p-button 
                                                        icon="pi pi-book" 
                                                        severity="warn" 
                                                        [raised]="true" 
                                                        size="small"
                                                        (click)="calculoSelecionado = calc; popoverDetalhesCalculo.toggle($event)"
                                                        pTooltip="Ver detalhes técnicos do cálculo"
                                                    >
                                                    </p-button>
                                                </div>
                                                <!-- Responsável -->
                                                <div class="w-3 m-3">
                                                    <p-floatLabel variant="in">
                                                        <p-select 
                                                            variant="filled" 
                                                            [style]="{'width':'100%'}" 
                                                            [options]="responsaveis"
                                                            optionLabel="value" 
                                                            optionValue="value" 
                                                            [(ngModel)]="calc.responsavel"
                                                            appendTo="body" 
                                                            [filter]="true" 
                                                            filterBy="value" 
                                                            [showClear]="true"
                                                        >
                                                        </p-select>
                                                        <label for="float-label">Selecione o Responsável</label>
                                                    </p-floatLabel>
                                                </div>
                                                <!-- Resultado -->
                                                <div 
                                                    class="resultado flex flex-column  w-8 justify-content-end m-3"
                                                    [ngClass]="{ negativo: (+calc.resultado || 0) < 0 }"
                                                >   
                                                    <div class="bg-gray-50 border-round mt-2 text-center" *ngIf="calc.descricao && calc.descricao.toLowerCase().includes('dimensional')">
                                                        <label class="text-sm font-medium">Data de Desmoldagem</label>
                                                    </div>
                                                    <div class="bg-gray-50 border-round mt-2 text-center" *ngIf="calc.descricao && calc.descricao.toLowerCase().includes('ensaio')">
                                                        <label class="text-sm font-medium">Data de Rompimento Prevista</label>
                                                    </div>
                                                    <div class="bg-gray-50 border-round mt-2 text-center" *ngIf="!calc.descricao && !calc.descricao.toLowerCase().includes('ensaio')">
                                                        <label class="text-sm font-medium">Resultado Final do Cálculo</label>
                                                    </div>
                                                    <div class="bg-gray-50 border-round mt-2 text-center">
                                                            <span class="text-2xl font-bold text-primary">
                                                                {{ calcResultadoEhData(calc) ? formatarDataExibicao(calc.resultado) : (typeof calc.resultado === 'number' ? formatForDisplay(calc.resultado) : (calc.resultado || 0)) }}
                                                            </span>
                                                        <span class="ml-2 text-lg text-600">{{ calc.unidade }}</span>
                                                    </div>
                
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                    <!-- Popover para detalhes do cálculo -->
                    <p-popover #popoverDetalhesCalculo>
                        <ng-template #content>
                            <div 
                                class="p-3" 
                                style="min-width: 500px;" 
                                *ngIf="calculoSelecionado"
                            >
                                <div class="header w-full text-left mb-3">
                                    <h2>Detalhes do Cálculo: {{ calculoSelecionado.descricao }}</h2>
                                </div>
                                
                                <!-- Informações do cálculo -->
                                <div class="flex flex-column gap-3">
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">ID do Cálculo</label>
                                        <span class="text-lg">{{ calculoSelecionado.id }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Descrição</label>
                                        <span class="text-lg">{{ calculoSelecionado.descricao }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Unidade</label>
                                        <span class="text-lg">{{ calculoSelecionado.unidade || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Fórmula de Cálculo</label>
                                        <p-floatlabel variant="on">
                                            <p-iconfield>
                                                <p-inputicon class="pi pi-calculator" />
                                                <input 
                                                    variant="filled" 
                                                    [style]="{'width':'100%'}" 
                                                    pInputText
                                                    id="funcao_calculo_{{calculoSelecionado.id}}" 
                                                    autocomplete="off"
                                                    [(ngModel)]="calculoSelecionado.funcao" 
                                                    type="text" 
                                                    readonly 
                                                />
                                            </p-iconfield>
                                            <label for="funcao_calculo_{{calculoSelecionado.id}}">Fórmula</label>
                                        </p-floatlabel>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Resultado Atual</label>
                                        <span class="text-2xl font-bold text-primary">
                                            {{ calculoSelecionado.resultado || 0 }}
                                            <span class="text-lg text-600 ml-2">{{ calculoSelecionado.unidade }}</span>
                                        </span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Responsável</label>
                                        <span class="text-lg">{{ calculoSelecionado.responsavel || 'Não atribuído' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Digitador</label>
                                        <span class="text-lg">{{ calculoSelecionado.digitador || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Quantidade de Ensaios</label>
                                        <span class="text-lg">{{ calculoSelecionado.ensaios_detalhes?.length || 0 }} ensaio(s)</span>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </p-popover>       
                </div>
            </div>
        </div>    
        <div class="step1 flex justify-content-between align-items-center w-12 mt-3 mb-5">
  
            <div>
                <p-menu 
                    #menu 
                    [model]="menuArgamassa" 
                    popup="true" 
                    styleClass="menu-up">
                </p-menu>

                <p-button 
                label="Ações Argamassa"
                icon="pi pi-chevron-up"
                (click)="menu.toggle($event)"
                severity="info"
                ></p-button>
            </div>

            <div>
                <p-button 
                [label]="hasUnsavedChanges ? 'Salvar Resultados *' : 'Salvar Resultados'" 
                [severity]="hasUnsavedChanges ? 'warn' : 'success'" 
                icon="pi pi-check" 
                iconPos="right" 
                [raised]="true"
                size="large" 
                (onClick)="salvarAnaliseResultados()" 
                [pTooltip]="hasUnsavedChanges ? 'Há alterações não salvas' : 'Salvar análise'" 
                ></p-button>
            </div>

        </div>
            
    </div>
</div>

<!------------------------------------ Resultados Anteriores Calculos ---------------------------------------------------->
<p-drawer [visible]="drawerResultadosVisivel" [modal]="true" [dismissible]="true" position="top"
    [style]="{ width: '100%',height: '50%' }">
    <div *ngIf="carregandoResultados" class="text-center p-4">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
        <p>Carregando histórico...</p>
    </div>
    <div *ngIf="!carregandoResultados && resultadosAnteriores.length > 0">
        <div class="header w-full text-left">
            Resultados Anteriores <h2><b>{{ calculoSelecionadoParaPesquisa?.descricao }}</b></h2>
        </div>
        <p-table [value]="resultadosAnteriores" [scrollable]="true" scrollHeight="400px" class="tabela">
            <ng-template pTemplate="header">
                <tr>
                    <th>Data</th>
                    <th>Amostra</th>
                    <th>Resultado</th>
                    <th>Ensaios/Valores</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-resultado>
                <tr class="row">
                    <td>{{ resultado.dataFormatada }}</td>
                    <td>{{ resultado.amostraNumero }}</td>
                    <td><strong>{{ resultado.resultadoCalculo }}</strong></td>
                    <td>
                        <div *ngFor="let ensaio of resultado.ensaiosUtilizados" style="margin-bottom: 5px;">
                            <span class="ensaio-item">
                                {{ ensaio.descricao }}: <strong>{{ ensaio.valor }}</strong>
                            </span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>    
    </div>
    <div 
        *ngIf="!carregandoResultados && resultadosAnteriores.length === 0" 
        class="text-center p-4"
    >
        <i class="pi pi-info-circle" style="font-size: 2rem; color: #2196F3;"></i>
        <p>Nenhum resultado anterior encontrado para este cálculo.</p>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Fechar" icon="pi pi-times" (onClick)="fecharDrawerResultados()">
        </p-button>
    </ng-template>
</p-drawer>
<!-- Resultados Anteriores Ensaios -->
<p-drawer 
    [visible]="drawerResultadosEnsaioVisivel" 
    [modal]="true" 
    [dismissible]="true" 
    position="top"
    [style]="{ width: '100%', height: '50%' }"
>
    <div *ngIf="carregandoResultados" class="text-center p-4">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
        <p>Carregando histórico...</p>
    </div>
    <div *ngIf="!carregandoResultados && resultadosAnteriores.length > 0">
        <div class="header w-full text-left">
            Resultados Anteriores <h2><b>{{ ensaioSelecionadoParaPesquisa?.descricao }}</b></h2>
        </div>       
        <p-table 
            [value]="resultadosAnteriores" 
            [scrollable]="true" 
            scrollHeight="400px" 
            class="tabela"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th>Data</th>
                    <th>Amostra</th>
                    <th>Resultado</th>
                    <th>Responsável</th>
                    <th>Digitador</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-resultado>
                <tr class="row">
                    <td>{{ resultado.dataFormatada }}</td>
                    <td>{{ resultado.amostraNumero }}</td>
                    <td>
                        <div *ngFor="let ensaio of resultado.ensaiosUtilizados" style="margin-bottom: 5px;">
                            <span class="ensaio-item">
                                <strong>{{ ensaio.valor }}</strong>
                            </span>
                        </div>
                    </td>
                    <td>{{ resultado.responsavel }}</td>
                    <td>{{ resultado.digitador}}</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    <div *ngIf="!carregandoResultados && resultadosAnteriores.length === 0" class="text-center p-4">
        <i class="pi pi-info-circle" style="font-size: 2rem; color: #2196F3;"></i>
        <p>Nenhum resultado anterior encontrado para este cálculo.</p>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Fechar" icon="pi pi-times" (onClick)="fecharDrawerResultadosEnsaios()">
        </p-button>
    </ng-template>
</p-drawer>
<!-- Resultados Anteriores Imagens -->
<p-drawer 
  header="Imagens da Amostra" 
  [(visible)]="modalImagensVisible" 
  position="right" 
  [style]="{ width: '80vw' }"
>
  <div *ngIf="amostraImagensSelecionada" class="mb-4">
    <h3>Amostra: {{ amostraImagensSelecionada.numero }}</h3>
    <p><strong>Material:</strong> {{ amostraImagensSelecionada.material }}</p>
    <p><strong>Data de Coleta:</strong> {{ amostraImagensSelecionada.data_coleta | date:'dd/MM/yyyy' }}</p>
  </div>
  <div *ngIf="imagensAmostra.length > 0" class="image-viewer">
    <!-- Navegação de imagens -->
    <div class="flex justify-content-between align-items-center mb-3">
      <p-button 
        icon="pi pi-chevron-left" 
        [disabled]="imagemAtualIndex === 0"
        (onClick)="imagemAnterior()"
        [rounded]="true">
      </p-button>
      <span class="text-lg font-semibold">
        {{ imagemAtualIndex + 1 }} de {{ imagensAmostra.length }}
      </span>
      <p-button 
        icon="pi pi-chevron-right" 
        [disabled]="imagemAtualIndex === imagensAmostra.length - 1"
        (onClick)="proximaImagem()"
        [rounded]="true">
      </p-button>
    </div>
    <!-- Imagem principal -->
    <div class="text-center mb-4">
      <img 
        [src]="imagensAmostra[imagemAtualIndex]?.image" 
        [alt]="imagensAmostra[imagemAtualIndex]?.descricao || 'Imagem da amostra'"
        style="max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);"
      />
    </div>
    <!-- Informações da imagem -->
    <div class="bg-gray-50 p-3 border-round mb-4">
        <p><strong>Descrição:</strong> {{ imagensAmostra[imagemAtualIndex]?.descricao || 'Sem descrição' }}</p>
        <p><strong>Data do Upload:</strong> {{ imagensAmostra[imagemAtualIndex]?.data_upload | date:'dd/MM/yyyy HH:mm' }}</p>
        <div class="bg-gray-50 p-3 border-round mb-4">
            <div class="w-full mb-3">
                <p-floatLabel variant="on">
                    <input 
                        pInputText 
                        [(ngModel)]="imagensAmostra[imagemAtualIndex].descricao" 
                        type="text" 
                        id="edit-descricao"
                        [style]="{'width':'100%'}" 
                        autocomplete="off" 
                        variant="filled"
                        (ngModelChange)="onDescricaoChange(imagensAmostra[imagemAtualIndex])"
                    />
                    <label for="edit-descricao">Descrição da imagem</label>
                </p-floatLabel>
            </div>
            <p><strong>Data do Upload:</strong> {{ imagensAmostra[imagemAtualIndex]?.data_upload | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
    </div>
    <!-- Ações da imagem -->
    <div class="flex justify-content-center gap-2 mb-4">
      <p-button 
        label="Download" 
        icon="pi pi-download" 
        severity="success"
        (onClick)="downloadImagem(imagensAmostra[imagemAtualIndex])">
      </p-button>
      
      <p-button 
        label="Deletar" 
        icon="pi pi-trash" 
        severity="danger"
        (onClick)="deletarImagem(imagensAmostra[imagemAtualIndex].id)">
      </p-button>
    </div>
    <!-- Thumbnails (miniaturas) -->
    <div class="flex flex-wrap gap-2 justify-content-center" *ngIf="imagensAmostra.length > 1">
      <div 
        *ngFor="let imagem of imagensAmostra; let i = index"
        class="cursor-pointer border-2 border-round overflow-hidden"
        [class.border-success]="i === imagemAtualIndex"
        [class.border-gray-300]="i !== imagemAtualIndex"
        (click)="irParaImagem(i)"
        style="width: 80px; height: 80px;">
        <img 
          [src]="imagem.image" 
          [alt]="'Miniatura ' + (i + 1)"
          style="width: 100%; height: 100%; object-fit: cover;">
      </div>
    </div>
  </div>
  <!-- Mensagem quando não há imagens -->
  <div *ngIf="imagensAmostra.length === 0" class="text-center p-5">
    <i class="pi pi-images text-6xl text-gray-400 mb-3"></i>
    <p class="text-xl text-gray-600">Esta amostra não possui imagens anexadas.</p>
  </div>
</p-drawer>
<!-- ============================= MODAIS PARA ADICIONAR ENSAIOS E CÁLCULOS ============================= -->
<!-- Modal para Adicionar Ensaios -->
<p-dialog 
  [(visible)]="modalAdicionarEnsaioVisible" 
  [modal]="true" 
  [closable]="true" 
  [resizable]="false"
  [style]="{ width: '70vw' }"
  (onHide)="fecharModalAdicionarEnsaios()"
  >
    <p-card class="card">
        <ng-template #header>
            <div class="header w-full text-left">
                <h2>Adicionar Ensaios</h2>
                <p>Selecione os ensaios que deseja adicionar à análise:</p>
            </div>
        </ng-template>
        <div class="p-4">            
            <p-table 
                #dtEnsaios
                [value]="getEnsaiosDisponiveis()"
                selectionMode="multiple" 
                [(selection)]="ensaiosSelecionadosParaAdicionar"
                [paginator]="true"
                [responsive]="true"
                [rows]="10"
                [globalFilterFields]="['descricao', 'tipo_ensaio_detalhes.nome']"
            >
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between align-items-center">
                        <span class="p-input-icon-left">
                            <p-iconfield>
                                <p-inputicon styleClass="pi pi-search" />
                                <input 
                                    pInputText 
                                    type="text" 
                                    placeholder="Pesquisar ensaios..."
                                    #searchInputEnsaios
                                    (input)="dtEnsaios.filterGlobal(searchInputEnsaios.value, 'contains')" 
                                />
                            </p-iconfield>
                        </span>
                    </div>
                </ng-template>     
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem;">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th>Descrição</th>
                        <th>Tipo</th>
                        <th>Tempo Previsto</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-ensaio>
                    <tr>
                    <td>
                        <p-tableCheckbox [value]="ensaio"></p-tableCheckbox>
                    </td>
                    <td>{{ ensaio.descricao }}</td>
                    <td>{{ ensaio.tipo_ensaio_detalhes?.nome || 'N/A' }}</td>
                    <td>{{ ensaio.tempo_previsto || 'N/A' }}</td>
                    </tr>
                </ng-template> 
                <ng-template pTemplate="emptymessage">
                    <tr>
                    <td colspan="5" class="text-center p-4">
                        <i class="pi pi-info-circle text-2xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">Nenhum ensaio disponível para adicionar.</p>
                    </td>
                    </tr>
                </ng-template>
            </p-table>      
            <div class="flex justify-content-end gap-2 mt-4">
                <p-button 
                    label="Cancelar" 
                    icon="pi pi-times" 
                    severity="secondary" 
                    (onClick)="fecharModalAdicionarEnsaios()">
                </p-button>
                <p-button 
                    label="Adicionar" 
                    icon="pi pi-plus" 
                    severity="success"
                    (onClick)="adicionarEnsaios()"
                    [disabled]="!ensaiosSelecionadosParaAdicionar.length">
                </p-button>
            </div>
        </div>
    </p-card>    
</p-dialog>
<!-- Modal para Adicionar Cálculos -->
<p-dialog 
  [(visible)]="modalAdicionarCalculoVisible" 
  [modal]="true" 
  [closable]="true" 
  [resizable]="false"
  [style]="{ width: '70vw' }"
 >
    <p-card class="card">
        <ng-template #header>
            <div class="header w-full text-left">
                <h2>Adicionar Cálculos</h2>
                Selecione os cálculos que deseja adicionar à análise:
            </div>
        </ng-template>
        <div class="p-4">
            <p-table 
                #dtCalculos
                [value]="getCalculosDisponiveis()" 
                selectionMode="multiple" 
                [(selection)]="calculosSelecionadosParaAdicionar"
                [paginator]="true" 
                [rows]="10"
                [globalFilterFields]="['descricao', 'funcao']"
            >
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between align-items-center">
                        <span class="p-input-icon-left">
                            <p-iconfield>
                                <p-inputicon styleClass="pi pi-search" />
                                <input 
                                pInputText 
                                type="text" 
                                placeholder="Pesquisar cálculos..."
                                #searchInputCalculos
                                (input)="dtCalculos.filterGlobal(searchInputCalculos.value, 'contains')" />
                            </p-iconfield>
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                    <th style="width: 3rem;">
                        <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                    </th>
                    <th>Descrição</th>
                    <th>Função</th>
                    <th>Responsável</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-calculo>
                    <tr>
                    <td>
                        <p-tableCheckbox [value]="calculo"></p-tableCheckbox>
                    </td>
                    <td>{{ calculo.descricao }}</td>
                    <td>
                        <span class="font-mono text-sm">{{ calculo.funcao }}</span>
                    </td>
                    <td>{{ calculo.responsavel || 'N/A' }}</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                    <td colspan="4" class="text-center p-4">
                        <i class="pi pi-info-circle text-2xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">Nenhum cálculo disponível para adicionar.</p>
                    </td>
                    </tr>
                </ng-template>
            </p-table>
            <div class="flex justify-content-end gap-2 mt-4">
                <p-button 
                    label="Cancelar" 
                    icon="pi pi-times" 
                    severity="secondary" 
                    >
                </p-button>
                <p-button 
                    label="Adicionar" 
                    icon="pi pi-plus" 
                    severity="success"
                    (onClick)="adicionarCalculos()"
                    [disabled]="!calculosSelecionadosParaAdicionar.length">
                </p-button>
            </div>
        </div>
    </p-card>    
</p-dialog>
<!-- Componentes necessários para confirmações e notificações -->
<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
<!-- Modal ou seção para configurar ordem -->
<p-dialog [(visible)]="modalOrdemVariaveisVisible" header="Ordenar Variáveis">
  <div *ngFor="let variavel of ensaioSelecionado?.variavel_detalhes; let i = index">
    <div class="flex align-items-center gap-2 mb-2">
        <p-inputnumber 
            [(ngModel)]="variavel.ordem" 
            [min]="1" 
            [max]="ensaioSelecionado.variavel_detalhes.length"
            showButtons="true"
            (ngModelChange)="atualizarOrdemVariavel(variavel, $event)">
        </p-inputnumber>
        <span>{{ variavel.nome }}</span>
        <!-- Botões para mover para cima/baixo -->
        <p-button icon="pi pi-arrow-up" size="small" 
            [disabled]="i === 0"
            (onClick)="moverVariavelPara('cima', i)">
        </p-button>
        <p-button icon="pi pi-arrow-down" size="small"
            [disabled]="i === ensaioSelecionado.variavel_detalhes.length - 1"
            (onClick)="moverVariavelPara('baixo', i)">
        </p-button>
    </div>
  </div>
</p-dialog>

<!------------ Modal para visualizar garantias de produto -------------------->
<p-drawer 
    [(visible)]="modalGarantiasVisible" 
    header="Garantias do Produto"
    [modal]="true" 
    [dismissible]="true"   
    position="top"
    [style]="{ width: '100%', height: '50%' }"
>
    <p-table 
        [value]="garantias" 
        [paginator]="true" 
        [rows]="10" 
        [scrollable]="true" 
        scrollHeight="400px"
        class="tabela"
    >
        <ng-template pTemplate="header">
            <tr>
                <th>Requisito</th>
                <th>Norma</th>
                <th>Classe</th>
                <th>Especificação</th>
                <th>Mínimo</th>
                <th>Máximo</th>
                <th>Unidade</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-garantia>
            <tr>
                <td>{{ garantia.requisito }}</td>
                <td>{{ garantia.norma }}</td>
                <td>{{ garantia.classe }}</td>
                <td>{{ garantia.especificacao }}</td>
                <td>{{ garantia.minimo }}</td>
                <td>{{ garantia.maximo }}</td>
                <td>{{ garantia.unidade }}</td>
            </tr>
        </ng-template>
    </p-table>
    <ng-template pTemplate="footer">
        <p-button label="Fechar" icon="pi pi-times" (onClick)="fecharDrawerGarantias()">
        </p-button>
    </ng-template>
</p-drawer>






<!-- SUbstrato Mpa -->
<p-drawer 
    [(visible)]="modalDadosLaudoSubstrato" 
    position="full" >

        <div class="containerInterno w-12">
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-substrato">
                        <ng-template #header>
                            <div class="header-substrato w-full text-center">
                                <b>Determinação da resistência potencial de aderência a tração ao substrato</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                <p-table [value]="linhasSubstrato" stripedRows>
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Nº</th>
                                            <th>Diâmetro mm</th>
                                            <th>Área mm²</th>
                                            <th>Espessura mm</th>
                                            <th>Subst</th>
                                            <th>Junta</th>
                                            <th>Carga kgf</th>
                                            <th>RESIST. Mpa</th>
                                            <th>Validação</th>
                                            <th>(A) Sub</th>
                                            <th>(B) Sub/Arga</th>
                                            <th>(C) Rup Arga</th>
                                            <th>(D) Arga Cola</th>
                                            <th>(E) Colar pastilha</th>
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                        <tr>
                                            <td>{{ linha.numero }}</td>
                                            <td><input pInputText [(ngModel)]="linha.diametro" type="number"/></td>
                                            <td><input pInputText [(ngModel)]="linha.area" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="linha.espessura" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="linha.subst" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="linha.junta" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="linha.carga" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="linha.resist" type="number" step="0.01" /></td>
                                            <td><input pInputText [(ngModel)]="linha.validacao" type="text" /></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.sub" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.subArga" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.rupArga" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.argaCola" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.colarPastilha" type="number" /></td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar e ir para tração superficial" 
                                severity="warn"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar e ir para tração superficial"
                                (onClick)="salvarSubstrato(analise)"
                            />
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>
    </div>
    
</p-drawer>

<!-- superficial -->
<p-drawer 
    [(visible)]="modalDadosLaudoSuperficial" 
    position="full" >
    <p-toast />
    <p-confirmDialog />
        <div class="containerInterno w-12">
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-superficial">
                        <ng-template #header>
                            <div class="header-superficial w-full text-center">
                                <b>Determinação da resistência potencial de aderência a tração superficial</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                <p-table 
                                    [value]="linhasSuperficial" 
                                    stripedRows
                                >
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Nº</th>
                                            <th>Diâmetro mm</th>
                                            <th>Área mm²</th>
                                            <th>Espessura mm</th>
                                            <th>Subst</th>
                                            <th>Junta</th>
                                            <th>Carga kgf</th>
                                            <th>RESIST. Mpa</th>
                                            <th>Validação</th>
                                            <th>(A) Sub</th>
                                            <th>(B) Sub/Arga</th>
                                            <th>(C) Rup Arga</th>
                                            <th>(D) Arga Cola</th>
                                            <th>(E) Colar pastilha</th>
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-numero let-i="rowIndex">
                                        <tr>
                                            <td>{{ numero.numero }}</td>
                                            <td><input pInputText [(ngModel)]="numero.diametro" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.area" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.espessura" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.subst" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.junta" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.carga" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.resist" type="number" step="0.01" /></td>
                                            <td><input pInputText [(ngModel)]="numero.validacao" type="text" /></td>
                                            <td><input pInputText [(ngModel)]="numero.rupturas.sub" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.rupturas.subArga" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.rupturas.rupArga" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.rupturas.argaCola" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="numero.rupturas.colarPastilha" type="number" /></td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar tração superficial" 
                                (onClick)="salvarSuperficial(analise)"
                                severity="info"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar tração superficial"
                            />
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>
    </div>
    
</p-drawer>

<!-- retacao -->
<p-drawer 
    [(visible)]="modalDadosLaudoRetacao" 
    position="full" >
    <p-toast />
    <p-confirmDialog />
        <div class="containerInterno w-12">
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-superficial">
                        <ng-template #header>
                            <div class="header-retacao w-full text-center">
                                <b>Determinação da Variação Dimencional Linear (Retação/Expansão)</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                <p-table 
                                    [value]="linhasRetacao" 
                                    stripedRows
                                >
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Data</th>
                                            <th>Idade</th>
                                            <th>Média (mm/m)</th>
                                            <th>Desvio Máximo (mm/m)</th>
                                            
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-retacao let-i="rowIndex">
                                        <tr>
                                            <td><input pInputText  [(ngModel)]="retacao.data" type="date" /></td>
                                            <td><input pInputText [(ngModel)]="retacao.idade" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="retacao.media" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="retacao.desvio" type="number" /></td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar Variação Dimencional Linear" 
                                (onClick)="salvarRetacao(analise)"
                                severity="info"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar Variação Dimencional Linear"
                                [style]="{'background-color': 'rgb(108, 165, 42)', 'border-color': 'rgb(108, 165, 42)'}"
                            />
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>
    </div>
    
</p-drawer>

<!-- elasticidade -->
<p-drawer 
    [(visible)]="modalDadosLaudoElasticidade" 
    position="full" >
    <p-toast />
    <p-confirmDialog />
        <div class="containerInterno w-12">
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-superficial">
                        <ng-template #header>
                            <div class="header-elasticidade w-full text-center">
                                <b>Módulo de Elasticidade Dinâmico</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                <p-table 
                                    [value]="linhasElasticidade" 
                                    stripedRows
                                >
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Individual</th>
                                            <th>Média (Mpa)</th>
                                            <th>Desvio Padrão (%)</th>
                                            
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-elasticidade let-i="rowIndex">
                                        <tr>
                                            <td><input pInputText [(ngModel)]="elasticidade.individual" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="elasticidade.media" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="elasticidade.desvio_padrao" type="number" /></td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar Módulo de Elasticidade Dinâmico" 
                                (onClick)="salvarElasticidade(analise)"
                                severity="info"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar Módulo de Elasticidade Dinâmico"
                                [style]="{'background-color': ' rgb(182, 109, 32)', 'border-color': ' rgb(182, 109, 32)'}"
                            />
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>
    </div>
    
</p-drawer>

<!-- ruptura a flexao -->
<p-drawer 
    [(visible)]="modalDadosLaudoFlexao" 
    position="full" >
    <p-toast />
    <p-confirmDialog />
        <div class="containerInterno w-12">
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-superficial">
                        <ng-template #header>
                            <div class="header-flexao w-full text-center">
                                <b>Carga de Ruptura a Flexão</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                <p-table 
                                    [value]="linhasFlexao" 
                                    stripedRows
                                >
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>CP</th>
                                            <th>Carga de Ruptura à Flexão (N)</th>
                                            <th>Resist. à Tração na Flexão (Mpa)</th>
                                            <th>Resist. Média (Mpa)</th>
                                            <th>Resist. Tração Flexão</th>
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-flexao let-i="rowIndex">
                                        <tr>
                                            <td>{{ flexao.cp }}</td>
                                            <td><input pInputText [(ngModel)]="flexao.flexao_n" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="flexao.flexao_mpa" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="flexao.media_mpa" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="flexao.tracao_flexao" type="number" /></td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar Ruptura a Flexão" 
                                (onClick)="salvarFlexao(analise)"
                                severity="info"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar Ruptura a Flexão"
                                [style]="{'background-color': 'purple', 'border-color': 'purple'}"
                            />
                            
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>
    </div>
    
</p-drawer>

<!-- ruptura a compressao -->
<p-drawer 
    [(visible)]="modalDadosLaudoCompressao" 
    position="full" >
    <p-toast />
    <p-confirmDialog />
        <div class="containerInterno w-12">
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-superficial">
                        <ng-template #header>
                            <div class="header-compressao w-full text-center">
                                <b>Carga de Ruptura a Compressão</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                <p-table 
                                    [value]="linhasCompressao" 
                                    stripedRows
                                >
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>CP</th>
                                            <th>Carga de Ruptura à Compressão (N)</th>
                                            <th>Resist. à Tração na Compressão (Mpa)</th>
                                            <th>Resist. Média (Mpa)</th>
                                            <th>Resist. Tração Compressão</th>
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-compressao let-i="rowIndex">
                                        <tr>
                                            <td>{{ compressao.cp }}</td>
                                            <td><input pInputText [(ngModel)]="compressao.compressao_n" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="compressao.compressao_mpa" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="compressao.media_mpa" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="compressao.tracao_compressao" type="number" /></td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar Ruptura a Compressão" 
                                (onClick)="salvarCompressao(analise)"
                                severity="info"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar Ruptura a Compressão"
                                [style]="{'background-color': 'brown', 'border-color': 'purple'}"
                            />
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>
    </div>
    
</p-drawer>

<!-- Gráfico -->
<p-drawer 
    [(visible)]="modalGrafico" 
    position="full" 
>
    <div class="container">
    <h2>Cálculo do Coeficiente de Absorção de Água por Capilaridade (Aw)</h2>

    <form [formGroup]="dataForm" class="data-input-area">
        <h3>1. Entrada de Dados Experimentais (Fase Linear)</h3>

        <table formArrayName="dataRows" class="data-table">
            <thead>
                <tr>
                    <th>Tempo</th>
                    <th>Raiz t (h¹/²)</th>
                    <th>Δmt (kg/m²)</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let row of dataRows.controls; let i = index" [formGroupName]="i">
                    <td>
                        {{ dataRows.at(i).get('tLabel')?.value }}
                    </td>
                    <td>
                        <input type="number" [formControlName]="'raizT'" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" [formControlName]="'deltaMt'" step="0.01" required>
                    </td>
                    <td>
                        <button type="button" (click)="removeDataRow(i)" *ngIf="i >= dadosIniciais.length" class="btn-remove">X</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <button type="button" (click)="addDataRow()" class="btn-add">+ Adicionar Ponto</button>

    </form>
    
    <hr>

    <div class="chart-area">
        <div style="width: 800px; height: 500px; margin: 20px auto;">
            <canvas #meuGrafico></canvas>
        </div>

        <div class="resultados">
            <h3>Resultado Calculado (Aw)</h3>
            <p>
                **Aw:** <span *ngIf="awCalculado !== null" style="font-weight: bold; color: #d9534f; font-size: 1.4em;">
                    {{ awCalculado | number:'1.3-3' }} kg/(m² · h¹/²)
                </span>
                <span *ngIf="!awCalculado">Aguardando dados válidos...</span>
            </p>
            <p>
                **R²:** {{ r2Calculado | number:'1.4-4' }}
            </p>
            
            <!-- Botões para salvar/baixar imagem do gráfico -->
            <div class="flex gap-3 mt-4 justify-content-center">
                <p-button 
                    label="Salvar Imagem no Banco" 
                    icon="pi pi-cloud-upload"
                    severity="success"
                    [loading]="salvandoImagemGrafico"
                    (click)="gerarESalvarImagemGrafico()"
                    [disabled]="!chartInstance"
                    pTooltip="Salva a imagem do gráfico no banco de dados da amostra">
                </p-button>
                
                <p-button 
                    label="Download Imagem" 
                    icon="pi pi-download"
                    severity="info"
                    (click)="downloadImagemGrafico()"
                    [disabled]="!chartInstance"
                    pTooltip="Baixa a imagem do gráfico para seu computador">
                </p-button>
            </div>
        </div>
    </div>
</div>
</p-drawer>
