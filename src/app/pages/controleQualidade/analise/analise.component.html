<div class="menu">
    <ul nz-menu nzMode="horizontal" style="overflow-x: auto; white-space: nowrap; background-color:#f2f2f2;height: 40px;box-shadow: 2px 0 6px ; ">
        <li nz-menu-item nzMatchRouter="#">
            <a style="font-size: 13px;" routerLink="/welcome/controleQualidade/dashControle">Início</a>
        </li>
        <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-submenu nzTitle="Cadastros "  style="font-size: 13px; ">
            <ul>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/tipoEnsaio">Tipo de Ensaio</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/variavel">Variáveis de Ensaio</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/ensaio" >Ensaio</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/calculoEnsaio" >Cálculo de Ensaio</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/plano" >Plano de Análise</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/tipoAmostra" >Local de Coleta</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/produtoAmostra" >Produto</a>
                </li>
                <li *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])" nz-menu-item  nzMatchRouter>
                    <a routerLink="/welcome/controleQualidade/garantia" >Garantias</a>
                </li>
            </ul>
        </li >
        <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;" routerLink="/welcome/controleQualidade/amostra">Amostras</a>
        </li>

        <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;" routerLink="/welcome/controleQualidade/ordem">Ordens de Serviço</a>
        </li>

        <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;" routerLink="/welcome/controleQualidade/arquivo">Banco de Análises</a>
        </li>

        <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;">Banco de Relatórios</a>
        </li>
         <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;" routerLink="/welcome/controleQualidade/resultados">Histórico de Resultados</a>
        </li>
        <li nz-menu-item nzMatchRouter="#" *ngIf="hasGroup(['Admin','Master','LabGestor','LabOp'])">
            <a style="font-size: 13px;" routerLink="/welcome/controleQualidade/acompanhamento">Acompanhamento de Tempo</a>
        </li>
    </ul>
</div>
<p-confirmDialog></p-confirmDialog>
<!-- Painel de Alertas de Rompimento -->
<div *ngIf="alertasRompimento.length > 0" class="alertas-rompimento-panel">
    <p-card class="mb-3">
        <ng-template #header>
            <div class="flex justify-content-between align-items-center p-3">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-exclamation-triangle text-orange-500"></i>
                    <span class="font-bold text-lg">Alertas de Rompimento</span>
                    <p-badge [value]="alertasRompimento.length" severity="warn"></p-badge>
                </div>
                <p-button 
                    icon="pi pi-times" 
                    severity="secondary" 
                    [text]="true"
                    size="small"
                    (click)="limparTodosAlertas()"
                    pTooltip="Limpar todos os alertas">
                </p-button>
            </div>
        </ng-template>
        <div class="grid">
            <div 
                *ngFor="let alerta of alertasRompimento" 
                class="col-12 md:col-6 lg:col-4 mb-2">
                <div 
                    class="p-3 border-round-md"
                    [ngClass]="{
                        'bg-red-50 border-red-200 border-1': alerta.tipo === 'vencido',
                        'bg-orange-50 border-orange-200 border-1': alerta.tipo === 'critico',
                        'bg-blue-50 border-blue-200 border-1': alerta.tipo === 'aviso'
                    }">
                    <div class="flex justify-content-between align-items-start mb-2">
                        <p-badge 
                            [value]="alerta.tipo.toUpperCase()" 
                            [severity]="alerta.tipo === 'vencido' ? 'danger' : alerta.tipo === 'critico' ? 'warn' : 'info'">
                        </p-badge>
                        <p-button 
                            icon="pi pi-times" 
                            [text]="true"
                            size="small"
                            (click)="removerAlerta(alerta.id)"
                            pTooltip="Remover alerta">
                        </p-button>
                    </div>
                    <p class="m-0 mb-2 font-semibold">{{ alerta.ensaio }}</p>
                    <p class="m-0 text-sm text-600">
                        <i class="pi pi-calendar mr-1"></i>
                        Rompimento: {{ alerta.dataRompimento }}
                    </p>
                    <p class="m-0 text-sm" 
                       [ngClass]="{
                         'text-red-600': alerta.tipo === 'vencido',
                         'text-orange-600': alerta.tipo === 'critico',
                         'text-blue-600': alerta.tipo === 'aviso'
                       }">
                        <i class="pi pi-clock mr-1"></i>
                        {{ alerta.diasRestantes < 0 ? 'Vencido há ' + Math.abs(alerta.diasRestantes) + ' dia(s)' :
                           alerta.diasRestantes === 0 ? 'Vence hoje!' :
                           'Vence em ' + alerta.diasRestantes + ' dia(s)' }}
                    </p>
                </div>
            </div>
        </div>
    </p-card>
</div>
<!-- CONTAINER -->
<div class="container">
    <!-- DETALHES DA AMOSTRA -->
    <div class="form-geral flex flex-column align-items-center" @swipeAnimation>
        <div class="step1 w-12 mt-3">
            <p-card class="card" *ngIf="analise">
                    <ng-template #header>
                        <div class="header flex flex-row justify-content-between gap-2 px-2">
                            <h2>Amostra</h2>
                            <h2>
                                Amostra N°: <b>{{ analise.amostra_detalhes?.numero }}</b>
                            </h2>
                        </div>
                    </ng-template>
                    <div class="flex flex-column w-12 lg:flex-row">
                        <div class="text-left w-4 ">
                            <p><b>Data de Coleta:</b> {{ analise.amostra_detalhes?.data_coleta | date:'dd/MM/yyyy' }}</p>
                            <p><b>Digitador:</b> {{ analise.amostra_detalhes?.digitador }}</p>
                            <p><b>Material:</b> {{ analise.amostra_detalhes?.material }}</p>
                        </div>
                        <div class="text-left w-4">
                            <p><b>Finalidade:</b> {{ analise.amostra_detalhes?.finalidade }}</p>
                            <p><b>Produto:</b> {{ analise.amostra_detalhes?.produto_amostra_detalhes?.nome }}</p>
                            <p><b>Data Entrada:</b> {{ analise.amostra_detalhes?.data_entrada  | date:'dd/MM/yyyy' }}</p>
                        </div>
                        <div class="text-left w-4">
                            <p><b>Fornecedor:</b> {{ analise.amostra_detalhes?.fornecedor }}</p>
                            <p><b>Local de Coleta:</b> {{ analise.amostra_detalhes?.local_coleta }}</p>
                            <p><b>Status:</b> {{ analise.amostra_detalhes?.status }}</p>
                        </div>    
                    </div>
                    <div class="flex flex-column lg:flex-row align-items-center w-full">
                        <div class="col-12 lg:col-4 flex justify-content-center lg:justify-content-start">
                            <p-button
                            class="w-full lg:w-auto"
                            label="Imagens"
                            [raised]="true"
                            severity="info"
                            icon="pi pi-image"
                            iconPos="right"
                            (onClick)="visualizarImagens(analise.amostra_detalhes?.id)">
                            </p-button>
                        </div>
                        <div class="col-12 lg:col-4 flex justify-content-center lg:justify-content-start">
                            <p-button
                                class="w-full lg:w-auto"
                                label="Garantias"
                                [raised]="true"
                                severity="warn"
                                icon="pi pi-shield"
                                iconPos="right"
                                (onClick)="consultarGarantia()">
                            </p-button>
                        </div>

                        <div class="text-left w-8"> 
                            <p-floatlabel variant="on"> 
                                <textarea 
                                    pTextarea 
                                    [value]="analise.amostra_detalhes?.observacoes" 
                                    id="on_label" 
                                    rows="5" 
                                    cols="30" 
                                    class="h-full w-full" 
                                    style="border-radius: 5px; background-color: #444959; color: white;" >
                                </textarea> 
                                <label for="in_label">Observações:</label> 
                            </p-floatlabel> 
                        </div>
                    </div>
                    <div class="w-4 text-left">
                            <p-floatLabel variant="on">
                                <p-select 
                                    inputId="float-label" 
                                    [style]="{'width':'100%'}" 
                                    [options]="status" 
                                    [(ngModel)]="analise.classificacao"
                                    optionLabel="nome" 
                                    optionValue="nome" 
                                    appendTo="body" 
                                    [filter]="true" 
                                    filterBy="nome" 
                                    [showClear]="true"
                                >
                                </p-select>
                                <label for="float-label">Classificação</label>
                                </p-floatLabel>
                    </div>
                    <div *ngIf="analise?.amostra_detalhes?.material?.toLowerCase() === 'argamassa'" class="flex flex-column mt-3 lg:flex-row w-full lg:justify-content-around">
                        <div class="flex flex-column w-5 gap-3">
                            <p-floatLabel variant="on"> 
                                <p-select
                                    variant="filled"
                                    inputId="float-label"
                                    [style]="{'width':'100%'}"
                                    [options]="metodosModelagem" 
                                    [(ngModel)]="analise.metodoModelagem"
                                    optionLabel="value"
                                    optionValue="value"
                                    [filter]="true" 
                                    filterBy="value"
                                    [showClear]="true"
                                    appendTo="body"
                                >
                                </p-select>
                                <label for="float-label">Método de Modelagem Ensaios LAB</label>
                            </p-floatLabel>
                             <p-floatLabel variant="on"> 
                                <p-select
                                    variant="filled"
                                    inputId="float-label"
                                    [style]="{'width':'100%'}"
                                    [options]="metodosModelagem" 
                                    [(ngModel)]="analise.metodoMuro"
                                    optionLabel="value"
                                    optionValue="value"
                                    [filter]="true" 
                                    filterBy="value"
                                    [showClear]="true"
                                    appendTo="body"
                                >
                                </p-select>
                                <label for="float-label">Método de Modelagem Aplicação no Muro</label>
                            </p-floatLabel>  
                        </div>
                        <div class="w-6 mt-3">
                            <div class="text-left w-12"> 
                                <p-floatlabel variant="on"> 
                                    <textarea 
                                        pTextarea 
                                        [(ngModel)]="analise.observacoesMuro"
                                        id="on_label" 
                                        rows="5" 
                                        cols="30" 
                                        class="h-full w-full" 
                                        style="border-radius: 5px; background-color: #444959; color: white;" >
                                    </textarea> 
                                    <label for="in_label">Observações:Aplicação no Muro</label> 
                                </p-floatlabel> 
                            </div>
                        </div>
                    </div>
                    <div *ngIf="analise?.amostra_detalhes?.material==='Areia'">
                        <p-divider></p-divider>

                        <div class="flex flex-column mt-5 lg:flex-row w-full lg:justify-content-around">
                            <div class="flex flex-column w-5 gap-3">
                                <p-floatLabel variant="on"> 
                                    <p-select
                                        variant="filled"
                                        inputId="float-label"
                                        [style]="{'width':'100%'}"
                                        [options]="materiaisOrganicos" 
                                        [(ngModel)]="analise.materialOrganico"
                                        optionLabel="value"
                                        optionValue="value"
                                        [filter]="true" 
                                        filterBy="value"
                                        [showClear]="true"
                                        appendTo="body"
                                    >
                                    </p-select>
                                    <label for="float-label">Materiais Orgânicos</label>
                                </p-floatLabel>
                            </div>
                            <div class="w-6">
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-column mt-3 lg:flex-row w-full lg:justify-content-around">
                        
                    </div>
                    <div class="flex flex-column mt-3 lg:flex-row w-full lg:justify-content-around">
                        
                    </div>
            </p-card>
        </div>
        <!-- TABELAS ENSAIOS E CALCULOS-->
        <div class="w-12 mt-4">
            <div *ngFor="let plano of analisesSimplificadas[0]?.planoDetalhes">
                <div class="step1 mb-5 flex justify-content-between align-items-center gap-3">    
                    <p-message severity="info" class="flex-1">
                        Plano de Análise: <b> {{ plano.descricao }}</b>
                    </p-message>
                    <!-- Informação sobre permissão de edição -->
                    <p-message 
                        *ngIf="!podeEditarEnsaiosCalculos()" 
                        severity="warn"
                        text="Você não tem permissão para editar esta análise (laboratório diferente)"
                    >
                    </p-message>
                </div>    
                
                <!-- Informações de Laboratório -->
                <div class="flex gap-3 mb-4 align-items-center">
                    <!-- Badge: Laboratório da Análise -->
                    <div class="flex align-items-center gap-2 px-4 py-2 border-round-lg"
                         [style]="'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);'">
                        <i class="pi pi-building" style="font-size: 1.2rem;"></i>
                        <div class="flex flex-column">
                            <span style="font-size: 0.7rem; opacity: 0.9;">Laboratório da Análise</span>
                            <span style="font-size: 1rem; font-weight: 700;">{{ analisesSimplificadas[0]?.amostraLaboratorio || 'N/A' }}</span>
                        </div>
                    </div>
                    
                    <!-- Badge: Laboratório do Usuário -->
                    <div class="flex align-items-center gap-2 px-4 py-2 border-round-lg"
                         [style]="'background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);'">
                        <i class="pi pi-user" style="font-size: 1.2rem;"></i>
                        <div class="flex flex-column">
                            <span style="font-size: 0.7rem; opacity: 0.9;">Seu Laboratório</span>
                            <span style="font-size: 1rem; font-weight: 700;">{{ laboratorioUsuario || 'N/A' }}</span>
                        </div>
                    </div>
                    
                    <!-- Indicador de Permissão -->
                    <div class="flex align-items-center gap-2 px-4 py-2 border-round-lg"
                         [style]="podeAdicionarRemoverItens() 
                            ? 'background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);' 
                            : 'background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);'">
                        <i [class]="podeAdicionarRemoverItens() ? 'pi pi-check-circle' : 'pi pi-lock'" style="font-size: 1.2rem;"></i>
                        <div class="flex flex-column">
                            <span style="font-size: 0.7rem; opacity: 0.9;">Status</span>
                            <span style="font-size: 1rem; font-weight: 700;">{{ podeAdicionarRemoverItens() ? 'Pode Adicionar/Remover' : 'Somente Visualização' }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Tabela para cada ensaio fixo (fora dos cálculos) -->
                <div class="step1">     
                    <div class=" w-full flex justify-content-between align-items-center">
                        <h2 style="color: #ffffff">Ensaios Diretos</h2>
                        <div class="flex gap-2" *ngIf="podeEditarEnsaiosCalculos()">
                            <p-button 
                                icon="pi pi-plus" 
                                label="Adicionar Ensaio" 
                                severity="warn" 
                                [raised]="true" 
                                size="small"
                                (onClick)="abrirModalAdicionarEnsaios()" 
                                pTooltip="Adicionar novo ensaio à análise"
                                tooltipPosition="top"
                            >
                            </p-button>
                        </div>
                    </div>
                    <!--ENSAIOS-->        
                    <div>
                        <p-table
                            #dt1 
                            class="ensaio-table-spacing" 
                            [value]="plano.ensaio_detalhes"
                            [tableStyle]="{'min-width': '70rem'}"
                            [dataKey]="'id'"
                            [globalFilterFields]="['descricao','unidade','norma','valor','responsavel','numero_cadinho']"
                        >
                            <ng-template pTemplate="caption">
                                <div class="flex flex-row md: justify-content-end">
                                    <p-floatlabel variant="on">
                                        <p-iconfield>
                                            <p-inputicon class="pi pi-search" style="color: #1b91ff;" />
                                                <input 
                                                    variant="filled" 
                                                    [(ngModel)]="inputValue"
                                                    [style]="{'width':'100%'}" 
                                                    pInputText id="on_label"
                                                    autocomplete="off" 
                                                    type="text" 
                                                    (ngModelChange)="dt1.filterGlobal($event, 'contains')"
                                                />
                                        </p-iconfield>
                                        <label for="on_label" style="color: #1b91ff">Pesquisar</label>
                                    </p-floatlabel>
                                </div>
                            </ng-template>
                            <ng-template pTemplate="header">
                                <tr class="tabela">
                                    <th style="width: 5%;">
                                        <p-button
                                            [text]="true"
                                            [plain]="true"
                                            size="small"
                                            [icon]="todasExpandidas ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                            (click)="toggleTodasLinhas()"

                                            pTooltip="Expandir/Recolher todas as linhas">
                                        </p-button>
                                    </th>
                                    <!-- Drag handle header (móvel) -->
                                    <th style="width: 4%;"></th>
                                    <th style="width: 30%; text-align: left;" field="ensaio" display="menu">Ensaio</th>
                                    <th style="width: 35%; text-align: right;">Resultado</th>
                                    <th style="width: 15%; text-align: right;">Histórico</th>
                                    <th style="width: 15%; text-align: right;" *ngIf="podeEditarEnsaiosCalculos()">Ações</th>
                                </tr>
                            </ng-template>
                            <!-- Linha principal -->
                            <ng-template pTemplate="body" let-ensaio let-rowIndex="rowIndex">
                                <tr 
                                    class="row"
                                    [ngClass]="getClasseTipoEnsaio(ensaio)"
                                    [class.row-expanded]="ensaio.expanded" 
                                    draggable="true"
                                    (dragstart)="onDragStart($event, ensaio, rowIndex, plano)"
                                    (dragover)="onDragOver($event)"
                                    (drop)="onDrop($event, ensaio, rowIndex, plano)"
                                    style="cursor: grab;"
                                    [style.opacity]="ensaio.expanded ? '0.7' : '1'"
                                >        
                                    <td>
                                        <p-button
                                            [text]="true"
                                            [plain]="true"
                                            size="small"
                                            [icon]="ensaio.expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                            (click)="toggleEnsaioExpansion(ensaio)">
                                        </p-button>
                                    </td>
                                            <!-- Drag handle cell (móvel) -->
                                    <td>
                                        <span 
                                            class="pi pi-sort-alt" 
                                            style="cursor: move; font-size: 1.2em; color: #6c757d;"
                                            title="Arrastar para reordenar">
                                        </span>
                                    </td>
                                    <td>
                                        <div class="flex align-items-start justify-content-start gap-2 flex-wrap">
                                            <i class="pi pi-file-edit text-primary"></i>
                                            <span class="font-bold text-lg">{{ ensaio.descricao }}</span>
                                            <span class="text-sm text-600 ml-2">({{ ensaio.unidade }})</span>
                                            <span class="text-sm text-600 ml-2" *ngIf="analise.amostra_detalhes?.material==='cal'">({{ ensaio.norma }})</span>
                                            
                                            <!-- Badge do laboratório -->
                                            <span 
                                                *ngIf="ensaio.laboratorio"
                                                [class]="'text-xs px-2 py-1 border-round-md flex align-items-center gap-1 ' + (isItemSomenteLeitura(ensaio) ? 'bg-red-100 text-red-700 border-1 border-red-300' : 'bg-green-100 text-green-700 border-1 border-green-300')"
                                                [style]="{'font-weight': '600'}"
                                                [pTooltip]="isItemSomenteLeitura(ensaio) ? 'Ensaio do laboratório ' + ensaio.laboratorio + ' (somente leitura)' : 'Ensaio do laboratório ' + ensaio.laboratorio + ' (editável)'"
                                                tooltipPosition="top"
                                            >
                                                <i class="pi pi-building text-xs"></i>
                                                <span>{{ ensaio.laboratorio }}</span>
                                                <i [class]="'text-xs ' + (isItemSomenteLeitura(ensaio) ? 'pi pi-lock' : 'pi pi-pencil')"></i>
                                            </span>
                                        </div>
                                    </td>
                                    <td style="text-align: end;">
                                        <div class="flex align-items-end justify-content-end">
                                            <span class="valor-result font-bold text-lg text-primary">
                                                {{ ensaioTemVariavelData(ensaio) ? (formatarDataExibicao(ensaio.valorTimestamp || ensaio.valor) || '—') : formatEnsaioValue(ensaio.valor || 0, ensaio.id) }}
                                            </span>
                                        </div>
                                        <div 
                                            *ngIf="ensaioTemVariavelData(ensaio) && ensaio.tipo_ensaio_detalhes?.nome !== 'Resistencia'" 
                                            class="text-xs text-500 mt-1"
                                        >
                                            {{ ensaioTemVariavelData(ensaio) ? 'Rompimento' : 'Resultado' }}
                                        </div>
                                    </td>
                                    <td style="text-align: end;">
                                        <p-button 
                                            icon="pi pi-history" 
                                            severity="info" 
                                            size="small" 
                                            [raised]="true"
                                            (onClick)="abrirDrawerResultadosEnsaios(ensaio)"
                                            [loading]="carregandoResultados && ensaioSelecionadoParaPesquisa?.descricao === ensaio.descricao"
                                            pTooltip="Ver resultados anteriores" 
                                            tooltipPosition="top"
                                        >
                                        </p-button>
                                    </td>
                                    <td *ngIf="podeEditarEnsaiosCalculos()" class="text-right">
                                        <p-button 
                                            icon="pi pi-trash" 
                                            severity="danger" 
                                            [raised]="true" 
                                            size="small"
                                            [disabled]="isItemSomenteLeitura(ensaio)"
                                            (onClick)="removerEnsaio(ensaio, plano)" 
                                            [pTooltip]="isItemSomenteLeitura(ensaio) ? 'Não é possível remover ensaio de outro laboratório' : 'Remover ensaio'"
                                            tooltipPosition="top"
                                        >
                                        </p-button>
                                    </td>
                                </tr>                    
                                <!-- Linha expandida (condicional) - Separada para não interferir no reordenamento -->
                                <tr *ngIf="ensaio.expanded" class="expanded-row">
                                    <td [attr.colspan]="podeEditarEnsaiosCalculos() ? 6 : 5" style="background-color: #2C323A; padding: 0;">
                                        <div class="p-3" style="background-color: #2C323A;">
                                            <div class="header flex justify-content-between align-items-center">
                                                <h2 class="text-2xl font-bold text-primary"><i class="pi pi-objects-column"></i> {{ ensaio.descricao }}
                                                </h2>
                                                
                                            </div>
                                            
                                            <div class="flex flex-row justify-content-between align-items-center mt-2 mb-2 w-full" *ngIf="ensaio.descricao?.toLowerCase().trim().includes('reatividade') || ensaio.descricao?.toLowerCase().trim().includes('finura');">
                                                            
                                                    <div class="flex flex-row gap-1 flex-shrink-0">
                                                        <p-button 
                                                            severity="info"
                                                            [raised]="true" 
                                                            size="small"
                                                            pTooltip="Visualizar Pen. Secas"
                                                            tooltipPosition="top"
                                                            (click)="visualizarPeneira()"
                                                            label="Visualizar Pen. Secas"
                                                        ></p-button>

                                                        <p-button 
                                                            severity="info"
                                                            pTooltip="Visualizar Pen. Úmidas"
                                                            tooltipPosition="top" 
                                                            size="small" 
                                                            [raised]="true"
                                                            (click)="visualizarPeneiraUmida()"
                                                            label="Visualizar Pen. Úmidas"
                                                        ></p-button>
                                                    </div>
                                                 
                                                </div>                    
                                            <div class="expanded-row flex flex-column w-12 lg:flex-row">
                                                 
                                                <!-- Variáveis -->
                                                <div class="flex flex-column w-7">
                                                    <div class="flex  gap-1" *ngIf="ensaio.variavel_detalhes && ensaio.variavel_detalhes.length > 0">
                                                        <div class="flex flex-wrap w-12 gap-1">
                                                            <div 
                                                                class="flex flex-wrap"
                                                                *ngFor="let variavel of getVariaveisOrdenadas(ensaio.variavel_detalhes)"
                                                            >
                                                                <p-floatlabel variant="in">
                                                                    <!-- Input para data -->
                                                                    <p-datepicker 
                                                                        *ngIf="isVariavelTipoData(variavel)" 
                                                                        [showIcon]="true"
                                                                        variant="filled" 
                                                                        size="small" 
                                                                        [style]="{'width':'100%'}" 
                                                                        appendTo="body"
                                                                        id="variavel_{{variavel.id || variavel.nome}}" [(ngModel)]="variavel.valorData"
                                                                        (ngModelChange)="atualizarVariavelData(ensaio, variavel, $event)"
                                                                        dateFormat="dd/mm/yy"
                                                                        appendTo="body"
                                                                        [disabled]="isItemSomenteLeitura(ensaio)"
                                                                    >
                                                                    </p-datepicker>
                                                                    <!-- Select para variáveis específicas do ensaio 126 (Fator calibração var45) -->
                                                                    <p-select
                                                                        *ngIf="!isVariavelTipoData(variavel) && ensaio.id === 126 && variavel.tecnica === 'var45'"
                                                                        [options]="getOpcoesValoresFator()"
                                                                        [(ngModel)]="variavel.valor"
                                                                        optionLabel="label"
                                                                        optionValue="value"
                                                                        (onChange)="atualizarVariavelEnsaio(ensaio, variavel, $event.value)"
                                                                        appendTo="body"
                                                                        [style]="{'width':'100%', 'min-width': '200px'}"
                                                                        [disabled]="isItemSomenteLeitura(ensaio)"
                                                                    ></p-select>
                                                                    <!-- Input numérico (padrão) -->
                                                                    <p-inputnumber 
                                                                        *ngIf="!isVariavelTipoData(variavel) && !(ensaio.id === 126 && variavel.tecnica === 'var45')" 
                                                                        mode="decimal"
                                                                        minFractionDigits="0" 
                                                                        maxFractionDigits="8" 
                                                                        variant="filled" 
                                                                        size="large"
                                                                        [style]="{'width':'100%'}" id="variavel_{{variavel.id || variavel.nome}}"
                                                                        showButtons="false" 
                                                                        [(ngModel)]="variavel.valor"
                                                                        (ngModelChange)="atualizarVariavelEnsaio(ensaio, variavel, $event)"
                                                                        [disabled]="isItemSomenteLeitura(ensaio)"
                                                                    />
                                                                    <label for="variavel_{{variavel.id || variavel.nome}}">
                                                                        {{ getVariavelDisplayName(variavel, ensaio) }}
                                                                    </label>
                                                                </p-floatlabel>
                                                            </div>
                                                        </div>
                                                    </div>                   
                                                    <!-- Para ensaios simples (sem variavel_detalhes) -->
                                                    <div *ngIf="!ensaio.variavel_detalhes || ensaio.variavel_detalhes.length === 0">
                                                        <div class="flex flex-column">
                                                            <p-floatlabel variant="in">
                                                                <input
                                                                    variant="filled"
                                                                    pInputText
                                                                    showButtons="false"
                                                                    type="number"
                                                                    [(ngModel)]="ensaio.valor" 
                                                                    [style]="{'width':'30%'}"
                                                                    id="ensaio_valor_{{ensaio.id}}"
                                                                    (ngModelChange)="onValorEnsaioChange(ensaio, $event)"
                                                                    [disabled]="isItemSomenteLeitura(ensaio)"
                                                                />
                                                                <label>{{ ensaio.descricao }}</label>
                                                            </p-floatlabel>
                                                        </div>
                                                    </div>
                                                    <div class="flex flex-row justify-content-start w-12">
                                                        <div 
                                                            class="resultado flex flex-column mt-3 w-6 justify-content-end"
                                                            [ngClass]="{ negativo: (+ensaio.valor || 0) < 0 }"
                                                           
                                                        >
                                                            <div class="bg-gray-50 border-round mt-2 text-center">
                                                                <label class="text-sm font-medium">Resultado</label>
                                                            </div>
                                                            <div class="bg-gray-50 border-round mt-2 text-center">
                                                                <span 
                                                                    class="text-2xl font-bold text-primary resultado-valor"
                                                                >
                                                                    {{ ensaioTemVariavelData(ensaio) ? (formatarDataExibicao(ensaio.valorTimestamp || ensaio.valor) || '—') : formatEnsaioValue(ensaio.valor || 0, ensaio.id) }}
                                                                </span>
                                                                <span class="ml-2 text-lg text-600">{{ ensaio.unidade }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex flex-column w-5">
                                                    <div   
                                                        class="flex flex-column gap-1 w-12 lg:flex-row" 
                                                    >
                                                        <!-- Técnico -->
                                                        <div class="w-6">
                                                            <p-floatLabel variant="in">
                                                                <p-select 
                                                                    [style]="{'width':'100%'}"
                                                                    [options]="responsaveis" 
                                                                    optionLabel="value"
                                                                    optionValue="value" 
                                                                    [(ngModel)]="ensaio.responsavel" 
                                                                    appendTo="body" 
                                                                    [filter]="true"
                                                                    filterBy="value" 
                                                                    [showClear]="true"
                                                                    [disabled]="isItemSomenteLeitura(ensaio)"
                                                                >
                                                                </p-select>
                                                                <label for="float-label">Selecione o Responsável</label>
                                                            </p-floatLabel>
                                                        </div>
                                                        <!-- Nº Cadinho -->
                                                        <div class="w-6"  *ngIf="ensaio.descricao.includes('PF - Perda ao Fogo') || ensaio.descricao.includes('Ri + SiO₂')">
                                                            <p-floatLabel variant="in">
                                                                <p-inputnumber 
                                                                    [(ngModel)]="ensaio.numero_cadinho" 
                                                                    [showButtons]="true" 
                                                                    [min]="1"
                                                                    [max]="9999" 
                                                                    mode="decimal" 
                                                                    [useGrouping]="false"
                                                                    [size]="'small' "
                                                                    [disabled]="isItemSomenteLeitura(ensaio)"
                                                                >
                                                                </p-inputnumber>
                                                                <label for="float-label">Nº Cadinho</label>
                                                            </p-floatLabel>
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-2 mt-5 w-6">
                                                        <p-button 
                                                            icon="pi pi-book" 
                                                            severity="warn" 
                                                            [raised]="true" 
                                                            size="small"
                                                            (click)="ensaioSelecionado = ensaio; popoverDetalhes.toggle($event)"
                                                            pTooltip="Ver detalhes técnicos do ensaio" 
                                                            tooltipPosition="top"
                                                        >
                                                        </p-button>
                                                        <p-button 
                                                            severity="info" 
                                                            pTooltip="Alterar ordem das variáveis" 
                                                            tooltipPosition="top"
                                                            size="small" 
                                                            [raised]="true" 
                                                            icon="pi pi-arrows-v"
                                                            (click)="abrirModalOrdemVariaveis(ensaio)"
                                                        >
                                                        </p-button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div> 
                    <!-- Popover para detalhes do ensaio -->
                    <p-popover #popoverDetalhes>
                        <ng-template #content>
                            <div 
                                class="p-3" 
                                style="min-width: 500px;" 
                                *ngIf="ensaioSelecionado"
                            >
                                <div class="header w-full text-left mb-3">
                                    <h2>Detalhes do Ensaio: {{ ensaioSelecionado.descricao }}</h2>
                                </div>
                                
                                <!-- Informações do ensaio -->
                                <div class="flex flex-column gap-3">
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">ID do Ensaio</label>
                                        <span class="text-lg">{{ ensaioSelecionado.id }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Descrição</label>
                                        <span class="text-lg">{{ ensaioSelecionado.descricao }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Tipo de Ensaio</label>
                                        <span class="text-lg">{{ ensaioSelecionado.tipo_ensaio_detalhes?.nome || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Unidade</label>
                                        <span class="text-lg">{{ ensaioSelecionado.unidade || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Tempo Previsto</label>
                                        <span class="text-lg">{{ ensaioSelecionado.tempo_previsto || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Fórmula do Ensaio</label>
                                        <p-floatlabel variant="on">
                                            <p-iconfield>
                                                <p-inputicon class="pi pi-calculator" />
                                                <input 
                                                    variant="filled" 
                                                    [style]="{'width':'100%'}" 
                                                    pInputText
                                                    id="funcao_ensaio_{{ensaioSelecionado.id}}" 
                                                    autocomplete="off"
                                                    [(ngModel)]="ensaioSelecionado.funcao" 
                                                    type="text" 
                                                    readonly 
                                                />
                                            </p-iconfield>
                                            <label for="funcao_ensaio_{{ensaioSelecionado.id}}">Fórmula</label>
                                        </p-floatlabel>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Variável Técnica</label>
                                        <span class="text-lg">{{ ensaioSelecionado.tecnica || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Valor Atual</label>
                                        <span class="text-2xl font-bold text-primary">
                                            {{ ensaioTemVariavelData(ensaioSelecionado) ? (formatarDataExibicao(ensaioSelecionado?.valorTimestamp || ensaioSelecionado?.valor) || '—') : (ensaioSelecionado?.valor || 0) }}
                                            <span class="text-lg text-600 ml-2">{{ ensaioSelecionado.unidade }}</span>
                                        </span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Responsável</label>
                                        <span class="text-lg">{{ ensaioSelecionado.responsavel || 'Não atribuído' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Nº do Cadinho</label>
                                        <span class="text-lg">{{ ensaioSelecionado.numero_cadinho || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Quantidade de Variáveis</label>
                                        <span class="text-lg">{{ ensaioSelecionado.variavel_detalhes?.length || 0 }} variável(is)</span>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </p-popover>                  
                </div>
                <!-- Tabela de Cálculos -->
                <div class="step1 mt-5">
                    <div class="header w-full flex justify-content-between align-items-center">
                        <h2 style="color: #ffffff">Ensaios Compostos</h2>
                        <div class="flex gap-2" *ngIf="podeEditarEnsaiosCalculos()">
                            <p-button 
                                icon="pi pi-plus" 
                                label="Adicionar Ensaio" 
                                severity="warn" 
                                [raised]="true" 
                                size="small"
                                (onClick)="abrirModalAdicionarCalculos()" 
                                pTooltip="Adicionar novo ensaio composto à análise"
                                tooltipPosition="top"
                            >
                            </p-button>
                        </div>
                    </div> 
                    <div class="tabela-ensaio-wrap">
                        <p-table
                            #tabelaCalculos 
                            class="ensaio-table-spacing" 
                            [value]="plano.calculo_ensaio_detalhes"
                            [tableStyle]="{'min-width': '70rem'}" 
                            [dataKey]="'id'"
                            [globalFilterFields]="['descricao','unidade','resultado','responsavel','digitador','ensaios_detalhes.descricao']"
                        >
                            <ng-template pTemplate="caption">
                                <div class="flex flex-row md: justify-content-end">
                                    <p-floatlabel variant="on">
                                        <p-iconfield>
                                            <p-inputicon class="pi pi-search" style="color: #1b91ff;" />
                                            <input
                                                variant="filled"
                                                [(ngModel)]="inputCalculos"
                                                [style]="{'width':'100%'}"
                                                pInputText id="calc_search"
                                                autocomplete="off"
                                                type="text"
                                                (ngModelChange)="tabelaCalculos.filterGlobal($event, 'contains')"
                                            />
                                        </p-iconfield>
                                        <label for="calc_search" style="color: #1b91ff">Pesquisar cálculos</label>
                                    </p-floatlabel>
                                </div>
                            </ng-template>
                            <ng-template pTemplate="header">
                                <tr class="tabela">
                                    <th style="width: 5%;">
                                        <p-button 
                                            [text]="true" 
                                            [plain]="true" 
                                            size="small"
                                            [icon]="todasCalculosExpandidas ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                            (click)="toggleTodasCalculos()" pTooltip="Expandir/Recolher todos os cálculos">
                                        </p-button>
                                    </th>
                                    <!-- Drag handle header para cálculos -->
                                    <th style="width: 4%;"></th>
                                    <th style="width: 30%; text-align: left;">Cálculo</th>
                                    <th style="width: 35%; text-align: right;">Resultado</th>
                                    <th style="width: 15%; text-align: right;">Histórico</th>
                                    <th style="width: 15%; text-align: right;" *ngIf="podeEditarEnsaiosCalculos()">Ações</th>
                                </tr>
                            </ng-template>               
                            <!-- Linha principal do cálculo -->
                            <ng-template pTemplate="body" let-calc let-rowIndex="rowIndex">
                                <tr 
                                    class="row" 
                                    draggable="true" 
                                    (dragstart)="onDragStartCalculo($event, calc, rowIndex, plano)"
                                    (dragover)="onDragOver($event)" (drop)="onDropCalculo($event, calc, rowIndex, plano)"
                                    style="cursor: grab;" [style.opacity]="calc.expanded ? '0.7' : '1'"
                                >
                                    <td>
                                        <p-button 
                                            [text]="true" 
                                            [plain]="true" 
                                            size="small"
                                            [icon]="calc.expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                            (click)="toggleCalculoExpansion(calc)">
                                        </p-button>
                                    </td>
                                    <!-- Drag handle cell for cálculos -->
                                    <td>
                                        <span 
                                            class="pi pi-sort-alt" 
                                            style="cursor: move; font-size: 1.2em; color: #6c757d;"
                                            title="Arrastar para reordenar"
                                        >
                                        </span>
                                    </td>
                                    <td>
                                        <div class="flex align-items-start justify-content-start gap-2 flex-wrap">
                                            <i class="pi pi-calculator text-primary"></i>
                                            <span class="font-bold text-lg">{{ calc.descricao }}</span>
                                            <span class="text-sm text-600 ml-2">({{ calc.unidade }})</span>
                                            <!-- Badge do laboratório -->
                                            <span 
                                                *ngIf="calc.laboratorio"
                                                [class]="'text-xs px-2 py-1 border-round-md flex align-items-center gap-1 ' + (isItemSomenteLeitura(calc) ? 'bg-red-100 text-red-700 border-1 border-red-300' : 'bg-green-100 text-green-700 border-1 border-green-300')"
                                                [style]="{'font-weight': '600'}"
                                                [pTooltip]="isItemSomenteLeitura(calc) ? 'Cálculo do laboratório ' + calc.laboratorio + ' (somente leitura)' : 'Cálculo do laboratório ' + calc.laboratorio + ' (editável)'"
                                                tooltipPosition="top"
                                            >
                                                <i class="pi pi-building text-xs"></i>
                                                <span>{{ calc.laboratorio }}</span>
                                                <i [class]="'text-xs ' + (isItemSomenteLeitura(calc) ? 'pi pi-lock' : 'pi pi-pencil')"></i>
                                            </span>
                                        </div>
                                    </td>
                                    <td style="text-align: end;">
                                        <div class="flex align-items-end justify-content-end gap-2">
                                            <span class="valor-result font-bold text-lg text-primary">
                                                {{ calcResultadoEhData(calc) ? formatarDataExibicao(calc.resultado) : (typeof calc.resultado === 'number' ? formatForDisplayPorId(calc.resultado, calc) : (calc.resultado || 0)) }}
                                            </span>
                                            <span class="text-sm text-600" *ngIf="calc.unidade">
                                                {{ calc.unidade }}
                                            </span>
                                        </div>
                                    </td>
                                    <td style="text-align: end;">
                                        <p-button 
                                            icon="pi pi-history" 
                                            severity="info" 
                                            size="small" 
                                            [raised]="true"
                                            (onClick)="abrirDrawerResultados(calc, plano)"
                                            [loading]="carregandoResultados && calculoSelecionadoParaPesquisa?.descricao === calc.descricao"
                                            pTooltip="Ver resultados anteriores" 
                                            tooltipPosition="top"
                                        >
                                        </p-button>
                                    </td>
                                    <td *ngIf="podeEditarEnsaiosCalculos()" class="text-right">
                                        <p-button 
                                            icon="pi pi-trash" 
                                            severity="danger" 
                                            [raised]="true" 
                                            size="small"
                                            [disabled]="isItemSomenteLeitura(calc)"
                                            (onClick)="removerCalculo(calc, plano)" 
                                            [pTooltip]="isItemSomenteLeitura(calc) ? 'Não é possível remover cálculo de outro laboratório' : 'Remover cálculo'"
                                            tooltipPosition="top"
                                        >
                                        </p-button>
                                    </td>
                                </tr>
                                <!-- Linha expandida do cálculo (condicional) - Separada para não interferir no reordenamento -->
                                <tr *ngIf="calc.expanded" class="expanded-row">
                                    <td 
                                        [attr.colspan]="podeEditarEnsaiosCalculos() ? 6 : 5"
                                        style="background-color: #2C323A; padding: 0;"
                                    >
                                        <div class="p-3">
                                            <div class="header flex justify-content-between align-items-center">
                                                <h2 style="color: #ffffff">Ensaios pertencentes ao Cálculo: <b>{{ calc.descricao }}</b></h2>
                                            </div>
                                            <div class="flex flex-column lg:flex-row lg:w-12">
                                                <div class="flex flex-column w-12">
                                                    <div 
                                                        class="flex flex-column gap-3"
                                                    >

                                                        <div 
                                                            class="flex flex-row justify-content-between align-items-center mb-2 mt-2 w-full" 
                                                            *ngIf="calc.descricao?.toLowerCase().trim().includes('reatividade'); 
                                                            else somentePesquisa"
                                                        >
                                                                                                                  
                                                            <div class="flex flex-row gap-1 flex-shrink-0">
                                                                <p-button 
                                                                    severity="info"
                                                                    [raised]="true" 
                                                                    size="small"
                                                                    pTooltip="Visualizar Pen. Secas"
                                                                    tooltipPosition="top"
                                                                    (click)="visualizarPeneira()"
                                                                    label="Visualizar Pen. Secas"
                                                                ></p-button>

                                                                <p-button 
                                                                    severity="info"
                                                                    pTooltip="Visualizar Pen. Úmidas"
                                                                    tooltipPosition="top" 
                                                                    size="small" 
                                                                    [raised]="true"
                                                                    (click)="visualizarPeneiraUmida()"
                                                                    label="Visualizar Pen. Úmidas"
                                                                ></p-button>
                                                            </div>

                                                            <div class="flex justify-content-end flex-shrink-0">
                                                                <p-floatlabel variant="on">
                                                                    <p-iconfield>
                                                                        <p-inputicon class="pi pi-search" style="color: #1b91ff;" />
                                                                        <input
                                                                            variant="filled"
                                                                            [(ngModel)]="calc._filtroEnsaios"
                                                                            [style]="{'width':'20rem'}"
                                                                            pInputText id="calc_ensaio_search_{{calc.id}}"
                                                                            autocomplete="off"
                                                                            type="text"
                                                                        />
                                                                    </p-iconfield>
                                                                    <label for="calc_ensaio_search_{{calc.id}}" style="color: #1b91ff">Pesquisar ensaios</label>
                                                                </p-floatlabel>
                                                            </div>
                                                        </div>    

                                                            <ng-template #somentePesquisa>
                                                                <div class="flex justify-content-end mt-2 w-full">
                                                                    <p-floatlabel variant="on">
                                                                        <p-iconfield>
                                                                            <p-inputicon class="pi pi-search" style="color: #1b91ff;" />
                                                                            <input
                                                                            variant="filled"
                                                                            [(ngModel)]="calc._filtroEnsaios"
                                                                            style="width: 20rem;"
                                                                            pInputText 
                                                                            id="calc_ensaio_search_{{calc.id}}"
                                                                            autocomplete="off"
                                                                            type="text"
                                                                            />
                                                                        </p-iconfield>
                                                                        <label for="calc_ensaio_search_{{calc.id}}" style="color: #1b91ff">
                                                                            Pesquisar ensaios
                                                                        </label>
                                                                    </p-floatlabel>
                                                                </div>
                                                            </ng-template>
                                                            

                                                        <div 
                                                            class="flex flex-column w-12 border-500 surface-overlay border-2 border-round-lg p-2 mb-2"
                                                            *ngFor="let ensaio of getEnsaiosFiltrados(calc); let i = index" 
                                                            draggable="true"
                                                            (dragstart)="onDragStartEnsaioInterno($event, ensaio, i, calc, plano)"
                                                            (dragover)="onDragOver($event)"
                                                            (drop)="onDropEnsaioInterno($event, ensaio, i, calc, plano)"

                                                        >
                                                            <div class="align-items-center gap-2">
                                                                <div class="flex align-items-center gap-2 flex-wrap">
                                                                    <i class="pi pi-flask text-primary"></i>
                                                                    <span class="font-bold">{{ ensaio.descricao }}</span>
                                                                    <!-- Badge do laboratório -->
                                                                    <span 
                                                                        *ngIf="ensaio.laboratorio"
                                                                        [class]="'px-2 py-1 border-round-md flex align-items-center gap-1 ' + (isItemSomenteLeitura(ensaio) ? 'bg-red-100 text-red-700 border-1 border-red-300' : 'bg-green-100 text-green-700 border-1 border-green-300')"
                                                                        [style]="{'font-size': '0.7rem', 'font-weight': '600'}"
                                                                        [pTooltip]="isItemSomenteLeitura(ensaio) ? 'Ensaio do laboratório ' + ensaio.laboratorio + ' (somente leitura)' : 'Ensaio do laboratório ' + ensaio.laboratorio + ' (editável)'"
                                                                        tooltipPosition="top"
                                                                    >
                                                                        <i class="pi pi-building" [style]="{'font-size': '0.7rem'}"></i>
                                                                        <span>{{ ensaio.laboratorio }}</span>
                                                                        <i [class]="(isItemSomenteLeitura(ensaio) ? 'pi pi-lock' : 'pi pi-pencil')" [style]="{'font-size': '0.7rem'}"></i>
                                                                    </span>
                                                                </div>
                                                                <span 
                                                                    class="pi pi-sort-alt"
                                                                    style="cursor: move; font-size: 1.1em; color: #6c757d;"
                                                                    title="Arrastar para reordenar"
                                                                >
                                                                </span>
                                                            </div>
                                                            <!-- Variáveis do ensaio (se houver) -->
                                                            <div 
                                                                class="mt-2 ml-3"
                                                                *ngIf="ensaio.variavel_detalhes || ensaio.variavel_detalhes.length"
                                                            >
                                                                <div class="flex flex-column w-12 lg:flex-row">
                                                                    <div class="flex flex-column w-8 gap-1">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <div 
                                                                                class="flex flex-row"
                                                                                *ngFor="let variavel of getVariaveisOrdenadas(ensaio.variavel_detalhes)"
                                                                            >
                                                                                <p-floatlabel variant="in">
                                                                                    <p-datepicker 
                                                                                        *ngIf="isVariavelTipoData(variavel)"
                                                                                        [showIcon]="true"
                                                                                        [(ngModel)]="variavel.valorData"
                                                                                        (ngModelChange)="atualizarVariavelEnsaioDentroCalculo(plano, ensaio, variavel, $event)"
                                                                                        dateFormat="dd/mm/yy" [showIcon]="true"
                                                                                        inputId="variavel_{{variavel.id || variavel.nome}}"
                                                                                        [style]="{'width':'100%'}"
                                                                                        appendTo="body"
                                                                                        [disabled]="isItemSomenteLeitura(ensaio)"
                                                                                    >
                                                                                    </p-datepicker>
                                                                                    <!-- Select para variáveis específicas do ensaio 126 (Fator calibração var45) -->
                                                                                    <p-select
                                                                                        *ngIf="!isVariavelTipoData(variavel) && ensaio.id === 126 && variavel.tecnica === 'var45'"
                                                                                        [options]="getOpcoesValoresFator()"
                                                                                        [(ngModel)]="variavel.valor"
                                                                                        optionLabel="label"
                                                                                        optionValue="value"
                                                                                        (onChange)="atualizarVariavelEnsaio(ensaio, variavel, $event.value)"
                                                                                        appendTo="body"
                                                                                        [style]="{'width':'100%', 'min-width': '200px'}"
                                                                                        [disabled]="isItemSomenteLeitura(ensaio)"
                                                                                    ></p-select>
                                                                                    <input 
                                                                                        *ngIf="!isVariavelTipoData(variavel) && !(ensaio.id === 126 && variavel.tecnica === 'var45')"
                                                                                        pInputText
                                                                                        type="number"
                                                                                        variant="filled"
                                                                                        size="small" 
                                                                                        [style]="{'width':'100%'}"
                                                                                        id="variavel_{{variavel.id || variavel.nome}}"
                                                                                        showButtons="false" 
                                                                                        [(ngModel)]="variavel.valor"
                                                                                        (ngModelChange)="atualizarVariavelEnsaio(ensaio, variavel, $event)"
                                                                                        [disabled]="isItemSomenteLeitura(ensaio)"
                                                                                    />
                                                                                    <label
                                                                                        for="variavel_{{variavel.id || variavel.nome}}">
                                                                                        {{ getVariavelDisplayName(variavel, ensaio) }}
                                                                                    </label>
                                                                                </p-floatlabel>
                                                                            </div>
                                                                        </div>
                                                                        <div 
                                                                            class="resultado flex flex-column mt-3 w-6 justify-content-end"
                                                                            [ngClass]="{ negativo: (+ensaio.valor || 0) < 0 }"
                                                                            
                                                                        >
                                                                            <div class="bg-gray-50 border-round mt-2 text-center">
                                                                                <label class="text-sm font-medium">Resultado </label>
                                                                                <label class="text-sm font-medium" *ngIf="ensaio.descricao.toLowerCase()==='data moldagem'">Data Rompimento</label>
                                                                            </div>
                                                                            <div class="bg-gray-50 border-round mt-2 text-center">
                                                                                                          <span class="text-2xl font-bold text-primary">
                                                                                                              {{ ensaioTemVariavelData(ensaio) || (ensaio.tipo_ensaio_detalhes?.nome === 'data' && !ensaio.descricao?.toLowerCase()?.includes('variação')) ? (formatarDataExibicao(ensaio.valorTimestamp || ensaio.valor) || '—') : formatEnsaioValue(ensaio.valor || 0, ensaio.id) }}
                                                                                                          </span>
                                                                                <span class="ml-2 text-lg text-600">{{ ensaio.unidade }}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>           
                                                                    <div class="flex flex-column w-4">
                                                                        <div class="flex flex-column w-12 gap-1">
                                                                            <div class="w-10">
                                                                                <p-floatLabel variant="in">
                                                                                    <p-select 
                                                                                        [style]="{'width':'100%'}"
                                                                                        [options]="responsaveis" optionLabel="value"
                                                                                        inputId="label"
                                                                                        optionValue="value"
                                                                                        [(ngModel)]="ensaio.responsavel"
                                                                                        (ngModelChange)="onResponsavelEnsaioDentroCalculoChange(plano, ensaio, $event)"
                                                                                        appendTo="body" [filter]="true" filterBy="value"
                                                                                        [showClear]="true"
                                                                                        [disabled]="isItemSomenteLeitura(ensaio)">
                                                                                    </p-select>
                                                                                    <label for="label">Responsável</label>
                                                                                </p-floatLabel>
                                                                            </div>
                                                                            <div class="w-2" *ngIf="ensaio.descricao.includes('PF - Perda ao Fogo') || ensaio.descricao.includes('Ri + SiO₂')">
                                                                                <p-floatLabel variant="in">
                                                                                    <p-inputnumber 
                                                                                        [(ngModel)]="ensaio.numero_cadinho"
                                                                                        (ngModelChange)="onNumeroCadinhoDentroCalculoChange(plano, ensaio, $event)"
                                                                                        [showButtons]="true" [min]="1" [max]="9999"
                                                                                        mode="decimal" [useGrouping]="false" size="small"
                                                                                        [style]="{'width':'100%'}"
                                                                                        [disabled]="isItemSomenteLeitura(ensaio)"
                                                                                    >
                                                                                    </p-inputnumber>
                                                                                    <label>Nº Cadinho</label>
                                                                                </p-floatLabel>
                                                                            </div>
                                                                        </div>
                                                                        <div class="flex flex-column w-12  lg:flex-row">
                                                                            <div class="flex gap-1 mt-2 w-4">
                                                                                <p-button 
                                                                                    icon="pi pi-book" 
                                                                                    severity="warn"
                                                                                    [raised]="true" size="small"
                                                                                    (click)="ensaioSelecionado = ensaio; popoverDetalhes.toggle($event)"
                                                                                    pTooltip="Ver detalhes técnicos do ensaio"
                                                                                    tooltipPosition="top"
                                                                                >
                                                                                </p-button>
                                                                                <p-button 
                                                                                    severity="info"
                                                                                    pTooltip="Alterar ordem das variáveis"
                                                                                    tooltipPosition="top" size="small" [raised]="true"
                                                                                    icon="pi pi-arrows-v"
                                                                                    (click)="abrirModalOrdemVariaveis(ensaio)"
                                                                                >
                                                                                </p-button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                class="flex flex-column lg:flex-row w-12 align-items-end   border-3  border-round-lg"
                                                style="background-color: #444959; color: #ffffff;"
                                            >
                                                <div class="w-1 m-3">
                                                    <p-button 
                                                        icon="pi pi-book" 
                                                        severity="warn" 
                                                        [raised]="true" 
                                                        size="small"
                                                        (click)="calculoSelecionado = calc; popoverDetalhesCalculo.toggle($event)"
                                                        pTooltip="Ver detalhes técnicos do cálculo"
                                                    >
                                                    </p-button>
                                                </div>
                                                <!-- Responsável -->
                                                <div class="w-3 m-3">
                                                    <p-floatLabel variant="in">
                                                        <p-select 
                                                            variant="filled" 
                                                            [style]="{'width':'100%'}" 
                                                            [options]="responsaveis"
                                                            optionLabel="value" 
                                                            optionValue="value" 
                                                            [(ngModel)]="calc.responsavel"
                                                            appendTo="body" 
                                                            [filter]="true" 
                                                            filterBy="value" 
                                                            [showClear]="true"
                                                            [disabled]="isItemSomenteLeitura(calc)"
                                                        >
                                                        </p-select>
                                                        <label for="float-label">Selecione o Responsável</label>
                                                    </p-floatLabel>
                                                </div>
                                                <!-- Resultado -->
                                                <div 
                                                    class="resultado flex flex-column  w-8 justify-content-end m-3"
                                                    [ngClass]="{ negativo: (+calc.resultado || 0) < 0 }"
                                                >   
                                                    <div class="bg-gray-50 border-round mt-2 text-center" *ngIf="calc.descricao && calc.descricao.toLowerCase().includes('dimensional')">
                                                        <label class="text-sm font-medium">Data de Desmoldagem</label>
                                                    </div>
                                                    <div class="bg-gray-50 border-round mt-2 text-center" *ngIf="calc.descricao && calc.descricao.toLowerCase().includes('ensaio')">
                                                        <label class="text-sm font-medium">Data de Rompimento Prevista</label>
                                                    </div>
                                                    <div class="bg-gray-50 border-round mt-2 text-center" *ngIf="!calc.descricao && !calc.descricao.toLowerCase().includes('ensaio')">
                                                        <label class="text-sm font-medium">Resultado Final do Cálculo</label>
                                                    </div>
                                                    <div class="bg-gray-50 border-round mt-2 text-center">
                                                            <span class="text-2xl font-bold text-primary">
                                                                {{ calcResultadoEhData(calc) ? formatarDataExibicao(calc.resultado) : (typeof calc.resultado === 'number' ? formatForDisplayPorId(calc.resultado, calc) : (calc.resultado || 0)) }}
                                                            </span>
                                                        <span class="ml-2 text-lg text-600">{{ calc.unidade }}</span>
                                                    </div>
                
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                    <!-- Popover para detalhes do cálculo -->
                    <p-popover #popoverDetalhesCalculo>
                        <ng-template #content>
                            <div 
                                class="p-3" 
                                style="min-width: 500px;" 
                                *ngIf="calculoSelecionado"
                            >
                                <div class="header w-full text-left mb-3">
                                    <h2>Detalhes do Cálculo: {{ calculoSelecionado.descricao }}</h2>
                                </div>
                                
                                <!-- Informações do cálculo -->
                                <div class="flex flex-column gap-3">
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">ID do Cálculo</label>
                                        <span class="text-lg">{{ calculoSelecionado.id }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Descrição</label>
                                        <span class="text-lg">{{ calculoSelecionado.descricao }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Unidade</label>
                                        <span class="text-lg">{{ calculoSelecionado.unidade || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Fórmula de Cálculo</label>
                                        <p-floatlabel variant="on">
                                            <p-iconfield>
                                                <p-inputicon class="pi pi-calculator" />
                                                <input 
                                                    variant="filled" 
                                                    [style]="{'width':'100%'}" 
                                                    pInputText
                                                    id="funcao_calculo_{{calculoSelecionado.id}}" 
                                                    autocomplete="off"
                                                    [(ngModel)]="calculoSelecionado.funcao" 
                                                    type="text" 
                                                    readonly 
                                                />
                                            </p-iconfield>
                                            <label for="funcao_calculo_{{calculoSelecionado.id}}">Fórmula</label>
                                        </p-floatlabel>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Resultado Atual</label>
                                        <span class="text-2xl font-bold text-primary">
                                            {{ calculoSelecionado.resultado || 0 }}
                                            <span class="text-lg text-600 ml-2">{{ calculoSelecionado.unidade }}</span>
                                        </span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Responsável</label>
                                        <span class="text-lg">{{ calculoSelecionado.responsavel || 'Não atribuído' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Digitador</label>
                                        <span class="text-lg">{{ calculoSelecionado.digitador || 'N/A' }}</span>
                                    </div>
                                    
                                    <div class="flex flex-column">
                                        <label class="font-bold text-sm text-600 mb-1">Quantidade de Ensaios</label>
                                        <span class="text-lg">{{ calculoSelecionado.ensaios_detalhes?.length || 0 }} ensaio(s)</span>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </p-popover>       
                </div>
            </div>
        </div>    
        <div class="step1 flex justify-content-between align-items-center w-12 mt-3 mb-5">
            <div>
                <p-menu 
                    #menuPeneiras 
                    [model]="menuPeneira" 
                    popup="true" 
                    styleClass="menu-up"
                    [appendTo]="'body'"
                >
                </p-menu>

                <p-button 
                    label="Peneiras"
                    icon="pi pi-chevron-up"
                    (click)="menuPeneiras.toggle($event)"
                    size="large" 
                    severity="help"
                    [disabled]="hasUnsavedChanges"
                >
                </p-button>
            </div>

            <div *ngIf="analise?.amostra_detalhes?.material?.toLowerCase() === 'argamassa'
            || analise?.amostra_detalhes?.material?.toLowerCase() === 'areia' 
            || analise?.amostra_detalhes?.material?.toLowerCase() === 'cimento'
                ">
                <p-menu 
                    #menu 
                    [model]="menuArgamassa" 
                    popup="true" 
                    styleClass="menu-up">
                </p-menu>
                <p-button 
                    label="Ações Argamassa"
                    icon="pi pi-chevron-up"
                    (click)="menu.toggle($event)"
                    size="large" 
                    severity="info">
                </p-button>
            </div>
            <div class="flex gap-2">
                <p-button 
                    label="Transferir Laboratório" 
                    icon="pi pi-arrow-right-arrow-left" 
                    severity="warn" 
                    [raised]="true"
                    size="large" 
                    (onClick)="abrirModalTransferirLaboratorio()" 
                    pTooltip="Transferir esta análise para outro laboratório"
                    tooltipPosition="top"
                    *ngIf="hasGroup(['Admin','Master','LabGestor'])"
                ></p-button>
                <p-button 
                    [label]="hasUnsavedChanges ? 'Salvar Resultados *' : 'Salvar Resultados'" 
                    [severity]="hasUnsavedChanges ? 'warn' : 'success'" 
                    icon="pi pi-check" 
                    iconPos="right" 
                    [raised]="true"
                    size="large" 
                    (onClick)="salvarAnaliseResultados()" 
                    [pTooltip]="hasUnsavedChanges ? 'Há alterações não salvas' : 'Salvar análise'" 
                ></p-button>
            </div>
            <div class="flex gap-2">
                <b>CaOComb</b>{{ caoCombCo2 || 0 }}
            </div>
        </div>
    </div>
</div>

<!------------------------------------ Resultados Anteriores Calculos ---------------------------------------------------->
<p-drawer [visible]="drawerResultadosVisivel" [modal]="true" [dismissible]="true" position="top"
    [style]="{ width: '100%',height: '50%' }">
    <div *ngIf="carregandoResultados" class="text-center p-4">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
        <p>Carregando histórico...</p>
    </div>
    <div *ngIf="!carregandoResultados && resultadosAnteriores.length > 0">
        <div class="header w-full text-left">
            Resultados Anteriores <h2><b>{{ calculoSelecionadoParaPesquisa?.descricao }}</b></h2>
        </div>
        <p-table [value]="resultadosAnteriores" [scrollable]="true" scrollHeight="400px" class="tabela">
            <ng-template pTemplate="header">
                <tr>
                    <th>Data</th>
                    <th>Amostra</th>
                    <th>Resultado</th>
                    <th>Ensaios/Valores</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-resultado>
                <tr class="row">
                    <td>{{ resultado.dataFormatada }}</td>
                    <td>{{ resultado.amostraNumero }}</td>
                    <td><strong>{{ resultado.resultadoCalculo }}</strong></td>
                    <td>
                        <div *ngFor="let ensaio of resultado.ensaiosUtilizados" style="margin-bottom: 5px;">
                            <span class="ensaio-item">
                                {{ ensaio.descricao }}: <strong>{{ ensaio.valor }}</strong>
                            </span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>    
    </div>
    <div 
        *ngIf="!carregandoResultados && resultadosAnteriores.length === 0" 
        class="text-center p-4"
    >
        <i class="pi pi-info-circle" style="font-size: 2rem; color: #2196F3;"></i>
        <p>Nenhum resultado anterior encontrado para este cálculo.</p>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Fechar" severity="info" icon="pi pi-times" (onClick)="fecharDrawerResultados()">
        </p-button>
    </ng-template>
</p-drawer>
<!-- Resultados Anteriores Ensaios -->
<p-drawer 
    [visible]="drawerResultadosEnsaioVisivel" 
    [modal]="true" 
    [dismissible]="true" 
    position="top"
    [style]="{ width: '100%', height: '50%' }"
>
    <div *ngIf="carregandoResultados" class="text-center p-4">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
        <p>Carregando histórico...</p>
    </div>
    <div *ngIf="!carregandoResultados && resultadosAnteriores.length > 0">
        <div class="header w-full text-left">
            Resultados Anteriores <h2><b>{{ ensaioSelecionadoParaPesquisa?.descricao }}</b></h2>
        </div>       
        <p-table 
            [value]="resultadosAnteriores" 
            [scrollable]="true" 
            scrollHeight="400px" 
            class="tabela"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th>Data</th>
                    <th>Amostra</th>
                    <th>Resultado</th>
                    <th>Responsável</th>
                    <th>Digitador</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-resultado>
                <tr class="row">
                    <td>{{ resultado.dataFormatada }}</td>
                    <td>{{ resultado.amostraNumero }}</td>
                    <td>
                        <div *ngFor="let ensaio of resultado.ensaiosUtilizados" style="margin-bottom: 5px;">
                            <span class="ensaio-item">
                                <strong>{{ ensaio.valor }}</strong>
                            </span>
                        </div>
                    </td>
                    <td>{{ resultado.responsavel }}</td>
                    <td>{{ resultado.digitador}}</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    <div *ngIf="!carregandoResultados && resultadosAnteriores.length === 0" class="text-center p-4">
        <i class="pi pi-info-circle" style="font-size: 2rem; color: #2196F3;"></i>
        <p>Nenhum resultado anterior encontrado para este cálculo.</p>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Fechar" severity="info" icon="pi pi-times" (onClick)="fecharDrawerResultadosEnsaios()">
        </p-button>
    </ng-template>
</p-drawer>
<!-- Resultados Anteriores Imagens -->
<p-drawer 
  header="Imagens da Amostra" 
  [(visible)]="modalImagensVisible" 
  position="right" 
  [style]="{ width: '80vw' }"
>
  <div *ngIf="amostraImagensSelecionada" class="mb-4">
    <p><strong>Amostra:</strong> {{ amostraImagensSelecionada.numero }}</p>
    <p><strong>Material:</strong> {{ amostraImagensSelecionada.material }}</p>
    <p><strong>Data de Coleta:</strong> {{ amostraImagensSelecionada.data_coleta | date:'dd/MM/yyyy' }}</p>
  </div>
  <div *ngIf="imagensAmostra.length > 0" class="image-viewer">
    <!-- Navegação de imagens -->
    <div class="flex justify-content-between align-items-center mb-3">
      <p-button 
        icon="pi pi-chevron-left" 
        [disabled]="imagemAtualIndex === 0"
        (onClick)="imagemAnterior()"
        [rounded]="true">
      </p-button>
      <span class="text-lg font-semibold">
        {{ imagemAtualIndex + 1 }} de {{ imagensAmostra.length }}
      </span>
      <p-button 
        icon="pi pi-chevron-right" 
        [disabled]="imagemAtualIndex === imagensAmostra.length - 1"
        (onClick)="proximaImagem()"
        [rounded]="true">
      </p-button>
    </div>
    <!-- Imagem principal -->
    <div class="text-center mb-4">
      <img 
        [src]="imagensAmostra[imagemAtualIndex]?.image" 
        [alt]="imagensAmostra[imagemAtualIndex]?.descricao || 'Imagem da amostra'"
        style="max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);"
      />
    </div>
    <!-- Informações da imagem -->
    <div class="bg-gray-50 p-3 border-round mb-4">
        <p><strong>Descrição:</strong> {{ imagensAmostra[imagemAtualIndex]?.descricao || 'Sem descrição' }}</p>
        <p><strong>Data do Upload:</strong> {{ imagensAmostra[imagemAtualIndex]?.data_upload | date:'dd/MM/yyyy HH:mm' }}</p>
        <div class="bg-gray-50 p-3 border-round mb-4">
            <div class="w-full mb-3">
                <p-floatLabel variant="on">
                    <input 
                        pInputText 
                        [(ngModel)]="imagensAmostra[imagemAtualIndex].descricao" 
                        type="text" 
                        id="edit-descricao"
                        [style]="{'width':'100%'}" 
                        autocomplete="off" 
                        variant="filled"
                        (ngModelChange)="onDescricaoChange(imagensAmostra[imagemAtualIndex])"
                    />
                    <label for="edit-descricao">Descrição da imagem</label>
                </p-floatLabel>
            </div>
            <p><strong>Data do Upload:</strong> {{ imagensAmostra[imagemAtualIndex]?.data_upload | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
    </div>
    <!-- Ações da imagem -->
    <div class="flex justify-content-center gap-2 mb-4">
      <p-button 
        label="Download" 
        icon="pi pi-download" 
        severity="success"
        (onClick)="downloadImagem(imagensAmostra[imagemAtualIndex])">
      </p-button>
      
      <p-button 
        label="Deletar" 
        icon="pi pi-trash" 
        severity="danger"
        (onClick)="deletarImagem(imagensAmostra[imagemAtualIndex].id)">
      </p-button>
    </div>
    <!-- Thumbnails (miniaturas) -->
    <div class="flex flex-wrap gap-2 justify-content-center" *ngIf="imagensAmostra.length > 1">
      <div 
        *ngFor="let imagem of imagensAmostra; let i = index"
        class="cursor-pointer border-2 border-round overflow-hidden"
        [class.border-success]="i === imagemAtualIndex"
        [class.border-gray-300]="i !== imagemAtualIndex"
        (click)="irParaImagem(i)"
        style="width: 80px; height: 80px;">
        <img 
          [src]="imagem.image" 
          [alt]="'Miniatura ' + (i + 1)"
          style="width: 100%; height: 100%; object-fit: cover;">
      </div>
    </div>
  </div>
  <!-- Mensagem quando não há imagens -->
  <div *ngIf="imagensAmostra.length === 0" class="text-center p-5">
    <i class="pi pi-images text-6xl text-gray-400 mb-3"></i>
    <p class="text-xl text-gray-600">Esta amostra não possui imagens anexadas.</p>
  </div>
</p-drawer>
<!-- ============================= MODAIS PARA ADICIONAR ENSAIOS E CÁLCULOS ============================= -->
<!-- Modal para Adicionar Ensaios -->
<p-dialog 
  [(visible)]="modalAdicionarEnsaioVisible" 
  [modal]="true" 
  [closable]="true" 
  [resizable]="false"
  [style]="{ width: '70vw' }"
  (onHide)="fecharModalAdicionarEnsaios()"
  >
    <p-card class="card">
        <ng-template #header>
            <div class="header w-full text-left">
                <h2>Adicionar Ensaios</h2>
                <p>Selecione os ensaios que deseja adicionar à análise:</p>
            </div>
        </ng-template>
        <div class="p-4">            
            <p-table 
                #dtEnsaios
                [value]="getEnsaiosDisponiveis()"
                selectionMode="multiple" 
                [(selection)]="ensaiosSelecionadosParaAdicionar"
                [paginator]="true"
                [rows]="10"
                [globalFilterFields]="['descricao', 'tipo_ensaio_detalhes.nome']"
            >
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between align-items-center">
                        <span class="p-input-icon-left">
                            <p-iconfield>
                                <p-inputicon styleClass="pi pi-search" />
                                <input 
                                    pInputText 
                                    type="text" 
                                    placeholder="Pesquisar ensaios..."
                                    #searchInputEnsaios
                                    (input)="dtEnsaios.filterGlobal(searchInputEnsaios.value, 'contains')" 
                                />
                            </p-iconfield>
                        </span>
                    </div>
                </ng-template>     
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem;">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th>Descrição</th>
                        <th>Tipo</th>
                        <th>Tempo Previsto</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-ensaio>
                    <tr>
                    <td>
                        <p-tableCheckbox [value]="ensaio"></p-tableCheckbox>
                    </td>
                    <td>{{ ensaio.descricao }}</td>
                    <td>{{ ensaio.tipo_ensaio_detalhes?.nome || 'N/A' }}</td>
                    <td>{{ ensaio.tempo_previsto || 'N/A' }}</td>
                    </tr>
                </ng-template> 
                <ng-template pTemplate="emptymessage">
                    <tr>
                    <td colspan="5" class="text-center p-4">
                        <i class="pi pi-info-circle text-2xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">Nenhum ensaio disponível para adicionar.</p>
                    </td>
                    </tr>
                </ng-template>
            </p-table>      
            <div class="flex justify-content-end gap-2 mt-4">
                <p-button 
                    label="Cancelar" 
                    icon="pi pi-times" 
                    severity="info" 
                    (onClick)="fecharModalAdicionarEnsaios()">
                </p-button>
                <p-button 
                    label="Adicionar" 
                    icon="pi pi-plus" 
                    severity="success"
                    (onClick)="adicionarEnsaios()"
                    [disabled]="!ensaiosSelecionadosParaAdicionar.length">
                </p-button>
            </div>
        </div>
    </p-card>    
</p-dialog>
<!-- Modal para Adicionar Cálculos -->
<p-dialog 
  [(visible)]="modalAdicionarCalculoVisible" 
  [modal]="true" 
  [closable]="true" 
  [resizable]="false"
  [style]="{ width: '70vw' }"
 >
    <p-card class="card">
        <ng-template #header>
            <div class="header w-full text-left">
                <h2>Adicionar Cálculos</h2>
                Selecione os cálculos que deseja adicionar à análise:
            </div>
        </ng-template>
        <div class="p-4">
            <p-table 
                #dtCalculos
                [value]="getCalculosDisponiveis()" 
                selectionMode="multiple" 
                [(selection)]="calculosSelecionadosParaAdicionar"
                [paginator]="true" 
                [rows]="10"
                [globalFilterFields]="['descricao', 'funcao']"
            >
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between align-items-center">
                        <span class="p-input-icon-left">
                            <p-iconfield>
                                <p-inputicon styleClass="pi pi-search" />
                                <input 
                                pInputText 
                                type="text" 
                                placeholder="Pesquisar cálculos..."
                                #searchInputCalculos
                                (input)="dtCalculos.filterGlobal(searchInputCalculos.value, 'contains')" />
                            </p-iconfield>
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                    <th style="width: 3rem;">
                        <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                    </th>
                    <th>Descrição</th>
                    <th>Função</th>
                    <th>Responsável</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-calculo>
                    <tr>
                    <td>
                        <p-tableCheckbox [value]="calculo"></p-tableCheckbox>
                    </td>
                    <td>{{ calculo.descricao }}</td>
                    <td>
                        <span class="font-mono text-sm">{{ calculo.funcao }}</span>
                    </td>
                    <td>{{ calculo.responsavel || 'N/A' }}</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                    <td colspan="4" class="text-center p-4">
                        <i class="pi pi-info-circle text-2xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">Nenhum cálculo disponível para adicionar.</p>
                    </td>
                    </tr>
                </ng-template>
            </p-table>
            <div class="flex justify-content-end gap-2 mt-4">
                <p-button 
                    label="Cancelar" 
                    icon="pi pi-times" 
                    severity="secondary" 
                    >
                </p-button>
                <p-button 
                    label="Adicionar" 
                    icon="pi pi-plus" 
                    severity="success"
                    (onClick)="adicionarCalculos()"
                    [disabled]="!calculosSelecionadosParaAdicionar.length">
                </p-button>
            </div>
        </div>
    </p-card>    
</p-dialog>
<!-- Componentes necessários para confirmações e notificações -->
<p-confirmDialog key="confirmDialog"></p-confirmDialog>
<p-toast></p-toast>

<!-- Modal para Transferir Laboratório -->
<p-dialog 
    [(visible)]="modalTransferirLaboratorioVisible" 
    header="Transferir Análise para Outro Laboratório"
    [modal]="true"
    [closable]="true"
    [style]="{ width: '600px' }"
    [draggable]="false"
    [resizable]="false"
>
    <div class="flex flex-column gap-4">
        <div class="flex flex-column gap-2">
            <label class="font-semibold">Laboratório Atual:</label>
            <div class="p-3 bg-blue-50 border-round">
                <span class="text-xl font-bold text-primary">
                    {{ analisesSimplificadas[0]?.amostraLaboratorio || 'Não definido' }}
                </span>
            </div>
        </div>
        
        <div class="flex flex-column gap-2">
            <label for="laboratorio-destino" class="font-semibold">
                Selecione o Laboratório de Destino:
            </label>
            <p-select
                id="laboratorio-destino"
                [(ngModel)]="laboratorioDestinoTransferencia"
                [options]="laboratorios"
                optionLabel="descricao"
                optionValue="nome"
                placeholder="Selecione um laboratório"
                [style]="{ width: '100%' }"
            >
                <ng-template pTemplate="selectedItem" let-option>
                    <div class="flex align-items-center gap-2" *ngIf="option">
                        <i class="pi pi-building text-primary"></i>
                        <span class="font-semibold">{{ option.nome }}</span>
                        <span class="text-sm text-500">- {{ option.descricao }}</span>
                    </div>
                </ng-template>
                <ng-template pTemplate="item" let-option>
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-building text-primary"></i>
                        <span class="font-semibold">{{ option.nome }}</span>
                        <span class="text-sm text-500">- {{ option.descricao }}</span>
                    </div>
                </ng-template>
            </p-select>
        </div>
        
        <div class="bg-yellow-50 border-round p-3">
            <p class="m-0 text-sm font-semibold text-700">
                <i class="pi pi-exclamation-triangle mr-2"></i>
                Atenção: Esta ação irá transferir TODOS os ensaios e cálculos desta análise 
                para o laboratório selecionado. Lembre-se de salvar a análise após a transferência!
            </p>
        </div>
        
        <div class="bg-blue-50 border-round p-3" *ngIf="analisesSimplificadas[0]?.planoDetalhes">
            <p class="m-0 text-sm text-600">
                <i class="pi pi-info-circle mr-2"></i>
                <strong>Itens a serem transferidos:</strong>
                <br>
                • Ensaios Diretos: {{ analisesSimplificadas[0].planoDetalhes[0]?.ensaio_detalhes?.length || 0 }}
                <br>
                • Ensaios Compostos: {{ analisesSimplificadas[0].planoDetalhes[0]?.calculo_ensaio_detalhes?.length || 0 }}
            </p>
        </div>
    </div>
    
    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2">
            <p-button 
                label="Cancelar" 
                icon="pi pi-times"
                severity="secondary"
                (onClick)="cancelarTransferenciaLaboratorio()"
            >
            </p-button>
            <p-button 
                label="Transferir" 
                icon="pi pi-arrow-right-arrow-left"
                severity="success"
                (onClick)="confirmarTransferenciaLaboratorio()"
                [disabled]="!laboratorioDestinoTransferencia"
            >
            </p-button>
        </div>
    </ng-template>
</p-dialog>

<!-- Modal ou seção para configurar ordem -->
<p-dialog [(visible)]="modalOrdemVariaveisVisible" header="Ordenar Variáveis">
  <div *ngFor="let variavel of ensaioSelecionado?.variavel_detalhes; let i = index">
    <div class="flex align-items-center gap-2 mb-2">
        <p-inputnumber 
            [(ngModel)]="variavel.ordem" 
            [min]="1" 
            [max]="ensaioSelecionado.variavel_detalhes.length"
            showButtons="true"
            (ngModelChange)="atualizarOrdemVariavel(variavel, $event)">
        </p-inputnumber>
        <span>{{ variavel.nome }}</span>
        <!-- Botões para mover para cima/baixo -->
        <p-button icon="pi pi-arrow-up" size="small" 
            [disabled]="i === 0"
            (onClick)="moverVariavelPara('cima', i)">
        </p-button>
        <p-button icon="pi pi-arrow-down" size="small"
            [disabled]="i === ensaioSelecionado.variavel_detalhes.length - 1"
            (onClick)="moverVariavelPara('baixo', i)">
        </p-button>
    </div>
  </div>
</p-dialog>

<!------------ Modal para visualizar garantias de produto -------------------->
<p-drawer 
    [(visible)]="modalGarantiasVisible" 
    header="Garantias do Produto"
    [modal]="true" 
    [dismissible]="true"   
    position="top"
    [style]="{ width: '100%', height: '50%' }"
>
    <p-table 
        [value]="garantias" 
        [paginator]="true" 
        [rows]="10" 
        [scrollable]="true" 
        scrollHeight="400px"
        class="tabela"
    >
        <ng-template pTemplate="header">
            <tr>
                <th>Requisito</th>
                <th>Norma</th>
                <th>Classe</th>
                <th>Especificação</th>
                <th>Mínimo</th>
                <th>Máximo</th>
                <th>Unidade</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-garantia>
            <tr>
                <td>{{ garantia.requisito }}</td>
                <td>{{ garantia.norma }}</td>
                <td>{{ garantia.classe }}</td>
                <td>{{ garantia.especificacao }}</td>
                <td>{{ garantia.minimo }}</td>
                <td>{{ garantia.maximo }}</td>
                <td>{{ garantia.unidade }}</td>
            </tr>
        </ng-template>
    </p-table>
    <ng-template pTemplate="footer">
        <p-button label="Fechar" severity="info" icon="pi pi-times" (onClick)="fecharDrawerGarantias()">
        </p-button>
    </ng-template>
</p-drawer>

<!-- tração normal -->
<p-drawer 
    [(visible)]="modalDadosTracaoNormal" 
    position="full" >

    <div class="background-form">
        <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
            <div class="fg1 flex flex-column w-12 align-items-center">

                <p-card class="card w-12 text-center card-substrato">
                    <ng-template #header>
                        <div class="header-substrato w-full text-center">
                            <b>Resist. Ader. a Tração (Normal)</b>
                        </div>
                    </ng-template>
                    <div class="flex flex-row w-12 gap-3">
                        <div class="w-12">
                            <div class="flex gap-3 mb-3">
                                <div class="w-6">
                                    <strong> Tempo Previsto:
                                    <input pInputText [(ngModel)]="tracao_normal_tempo_previsto" style="width: 200px" />
                                    </strong>
                                </div>

                                <div class="w-6">
                                    <strong> Tempo Trabalhado:
                                    <input pInputText [(ngModel)]="tracao_normal_tempo_trabalho" style="width: 200px" />
                                    </strong>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                    <div class="w-6 mb-5">
                                        <label class="font-bold text-lg mb-2 block"> Data de Moldagem</label>
                                        <p-datePicker 
                                            [(ngModel)]="tracaoNormalDataMoldagem" 
                                            (ngModelChange)="onTracaoNormalDataMoldagemChange()" 
                                            dateFormat="dd/mm/yy"
                                            placeholder="Selecione a data inicial" 
                                            [style]="{'width':'30%'}" 
                                            />
                                     </div>
                                     <div class="w-6 mt-3">
                                        <strong> Data Rompimento: </strong>{{ tracaoNormalDataRompimento | date:'dd/MM/yyyy' }}
                                     </div>     
                            </div>

                            <br>

                            <div class="w-12 flex flex-row gap-4" style="align-items: flex-end;"> 
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Média de Resist. MPa: {{ tracao_normal_media}} </strong>
                                </h2>
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Desvio Padrão: {{ tracao_normal_desvio_padrao  !== null ? tracao_normal_desvio_padrao : '-' }} </strong>
                                </h2>
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Máx: {{ tracaoNormalResultadoMax !== null ? tracaoNormalResultadoMax : '-' }} </strong>
                                </h2>
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Mín: {{ tracaoNormalResultadoMin !== null ? tracaoNormalResultadoMin : '-' }} </strong>
                                </h2>
                                <!-- Card de Parecer do Ensaio -->
                                <div *ngIf="tracaoNormalParecerEnsaio"
                                    [style]="{'background': tracaoNormalParecerEnsaio === 'Ensaio Válido' ? 'linear-gradient(135deg, rgba(46, 125, 50, 0.9) 0%, rgba(76, 175, 80, 0.9) 100%)' : 'linear-gradient(135deg, rgba(198, 40, 40, 0.9) 0%, rgba(244, 67, 54, 0.9) 100%)', 'color': 'white', 'padding': '0.75rem 1.25rem', 'border-radius': '12px', 'border': tracaoNormalParecerEnsaio === 'Ensaio Válido' ? '2px solid rgba(76, 175, 80, 0.5)' : '2px solid rgba(244, 67, 54, 0.5)', 'box-shadow': '0 4px 6px rgba(0,0,0,0.3)', 'margin-bottom': '0', 'min-width': '280px'}"
                                    class="flex align-items-center">
                                    <i [class]="tracaoNormalParecerEnsaio === 'Ensaio Válido' ? 'pi pi-check-circle' : 'pi pi-times-circle'"
                                        style="font-size: 1.5rem; margin-right: 0.75rem;"></i>
                                    <div style="flex: 1;">
                                        <div *ngIf="tracaoNormalParecerEnsaio === 'Ensaio Válido'" style="font-weight: 600; font-size: 1rem;">
                                            {{ tracaoNormalParecerEnsaio }}
                                        </div>
                                        <div *ngIf="tracaoNormalParecerEnsaio === 'Ensaio Inválido'">
                                            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">
                                                {{ tracaoNormalParecerEnsaio }}
                                            </div>
                                            <div style="font-size: 0.85rem; opacity: 0.95;">
                                                Refazer o Ensaio = Número de pontos válidos menor que o mínimo necessário
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p-table [value]="linhasTracaoNormal" stripedRows>
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Nº</th>
                                        <th>Diâmetro mm</th>
                                        <th>Área</th>
                                        <th>Carga kgf</th>
                                        <th>RESIST. Mpa</th>
                                        <th>Validação</th>
                                        <th>S</th>
                                        <th>S/A</th>
                                        <th>A</th>
                                        <th>A/P</th>
                                        <th>P</th>
                                        <th>F</th>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                    <tr>
                                        <td>{{ linha.numero }}</td>
                                        <td><input 
                                                pInputText 
                                                [(ngModel)]="linha.diametro"
                                                type="number"
                                                (ngModelChange)="atualizarAreaQuadrado(linha)"
                                                style="width: 70px"

                                            />
                                        </td>
                                        <td><input pInputText [(ngModel)]="linha.area" type="text" readonly (ngModelChange)="atualizarCalculosTracaoNormal(linha)" style="width: 95px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.carga" type="number" (ngModelChange)="atualizarCalculosTracaoNormal(linha)" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.resist" type="text" readonly style="width: 80px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.validacao" type="text" style="width: 100px" readonly/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.substrato" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.interfaceSubstrato" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.argamassa" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.interfaceArgamassa" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.placaCeramica" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.falhaCola" type="number" style="width: 70px"/></td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                    
                    <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                        <p-button 
                            label="Salvar Tração (Normal)" 
                            severity="warn"
                            icon="pi pi-check" 
                            iconPos="right" 
                            tooltipPosition="top"
                            pTooltip="Salvar Tração (Normal)"
                            (onClick)="salvarTracaoNormal(analise)"
                        />
                    </div>
                </p-card>
            </div>    
        </div>
    </div>
    
</p-drawer>

<!-- tração submersa -->
<p-drawer 
    [(visible)]="modalDadosTracaoSubmersa" 
    position="full" >
    <div class="background-form">
        <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
            <div class="fg1 flex flex-column w-12 align-items-center">
                <p-card class="card w-12 text-center card-substrato">
                    <ng-template #header>
                        <div class="header-substrato w-full text-center">
                            <b>Resist. Ader. a Tração (Submersa)</b>
                        </div>
                    </ng-template>
                    <div class="flex flex-row w-12 gap-3">
                        <div class="w-12">
                            <div class="flex gap-3 mb-3">
                                <div class="w-6">
                                    <strong> Tempo Previsto:
                                    <input pInputText [(ngModel)]="tracao_submersa_tempo_previsto" style="width: 200px" />
                                    </strong>
                                </div>

                                <div class="w-6">
                                    <strong> Tempo Trabalhado:
                                    <input pInputText [(ngModel)]="tracao_submersa_tempo_trabalho" style="width: 200px" />
                                    </strong>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                    <div class="w-6 mb-5">
                                        <label class="font-bold text-lg mb-2 block"> Data de Moldagem</label>
                                        <p-datePicker 
                                            [(ngModel)]="tracaoSubmersaDataMoldagem" 
                                            (ngModelChange)="onTracaoSubmersaDataMoldagemChange()" 
                                            dateFormat="dd/mm/yy"
                                            placeholder="Selecione a data inicial" 
                                            [style]="{'width':'30%'}" 
                                            />
                                     </div>
                                     <div class="w-6 mt-3">
                                        <strong> Data Rompimento: </strong>{{ tracaoSubmersaDataRompimento | date:'dd/MM/yyyy' }}
                                     </div>     
                            </div>

                            <br>
                            <div class="w-12 flex flex-row gap-4" style="align-items: flex-end;"> 
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Média de Resist. MPa: {{ tracao_submersa_media}} </strong>
                                </h2>
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Desvio Padrão: {{ tracao_submersa_desvio_padrao !== null ? tracao_submersa_desvio_padrao : '-' }} </strong>
                                </h2>
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Máx: {{ tracaoSubmersaResultadoMax !== null ? tracaoSubmersaResultadoMax : '-' }} </strong>
                                </h2>
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Mín: {{ tracaoSubmersaResultadoMin !== null ? tracaoSubmersaResultadoMin : '-' }} </strong>
                                </h2>
                                <!-- Card de Parecer do Ensaio -->
                                <div *ngIf="tracaoSubmersaParecerEnsaio"
                                    [style]="{'background': tracaoSubmersaParecerEnsaio === 'Ensaio Válido' ? 'linear-gradient(135deg, rgba(46, 125, 50, 0.9) 0%, rgba(76, 175, 80, 0.9) 100%)' : 'linear-gradient(135deg, rgba(198, 40, 40, 0.9) 0%, rgba(244, 67, 54, 0.9) 100%)', 'color': 'white', 'padding': '0.75rem 1.25rem', 'border-radius': '12px', 'border': tracaoSubmersaParecerEnsaio === 'Ensaio Válido' ? '2px solid rgba(76, 175, 80, 0.5)' : '2px solid rgba(244, 67, 54, 0.5)', 'box-shadow': '0 4px 6px rgba(0,0,0,0.3)', 'margin-bottom': '0', 'min-width': '280px'}"
                                    class="flex align-items-center">
                                    <i [class]="tracaoSubmersaParecerEnsaio === 'Ensaio Válido' ? 'pi pi-check-circle' : 'pi pi-times-circle'"
                                        style="font-size: 1.5rem; margin-right: 0.75rem;"></i>
                                    <div style="flex: 1;">
                                        <div *ngIf="tracaoSubmersaParecerEnsaio === 'Ensaio Válido'" style="font-weight: 600; font-size: 1rem;">
                                            {{ tracaoSubmersaParecerEnsaio }}
                                        </div>
                                        <div *ngIf="tracaoSubmersaParecerEnsaio === 'Ensaio Inválido'">
                                            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">
                                                {{ tracaoSubmersaParecerEnsaio }}
                                            </div>
                                            <div style="font-size: 0.85rem; opacity: 0.95;">
                                                Refazer o Ensaio = Número de pontos válidos menor que o mínimo necessário
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                
                            <p-table [value]="linhasTracaoSubmersa" stripedRows>
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Nº</th>
                                        <th>Diâmetro mm</th>
                                        <th>Área</th>
                                        <th>Carga kgf</th>
                                        <th>RESIST. Mpa</th>
                                        <th>Validação</th>
                                        <th>S</th>
                                        <th>S/A</th>
                                        <th>A</th>
                                        <th>A/P</th>
                                        <th>P</th>
                                        <th>F</th>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                    <tr>
                                        <td>{{ linha.numero }}</td>
                                        <td><input 
                                                pInputText 
                                                [(ngModel)]="linha.diametro"
                                                type="number"
                                                (ngModelChange)="atualizarAreaQuadrado(linha)"
                                                style="width: 70px"

                                            />
                                        </td>
                                        <td><input pInputText [(ngModel)]="linha.area" type="text" readonly (ngModelChange)="atualizarCalculosTracaoSubmersa(linha)" style="width: 95px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.carga" type="number" (ngModelChange)="atualizarCalculosTracaoSubmersa(linha)" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.resist" type="text" readonly style="width: 80px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.validacao" type="text" style="width: 100px" readonly/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.substrato" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.interfaceSubstrato" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.argamassa" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.interfaceArgamassa" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.placaCeramica" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.falhaCola" type="number" style="width: 70px"/></td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                    
                    <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                        <p-button 
                            label="Salvar Tração (Submersa)" 
                            severity="warn"
                            icon="pi pi-check" 
                            iconPos="right" 
                            tooltipPosition="top"
                            pTooltip="Salvar Tração (Submersa)"
                            (onClick)="salvarTracaoSubmersa(analise)"
                        />
                    </div>
                </p-card>
            </div>    
        </div>
    </div>
    
</p-drawer>

<!-- tração estufa -->
<p-drawer 
    [(visible)]="modalDadosTracaoEstufa" 
    position="full" >

    <div class="background-form">
        <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
            <div class="fg1 flex flex-column w-12 align-items-center">

                <p-card class="card w-12 text-center card-substrato">
                    <ng-template #header>
                        <div class="header-substrato w-full text-center">
                            <b>Resist. Ader. a Tração (Estufa)</b>
                        </div>
                    </ng-template>
                    <div class="flex flex-row w-12 gap-3">
                        <div class="w-12">
                            <div class="flex gap-3 mb-3">
                                <div class="w-6">
                                    <strong> Tempo Previsto:
                                    <input pInputText [(ngModel)]="tracao_estufa_tempo_previsto" style="width: 200px" />
                                    </strong>
                                </div>

                                <div class="w-6">
                                    <strong> Tempo Trabalhado:
                                    <input pInputText [(ngModel)]="tracao_submersa_tempo_trabalho" style="width: 200px" />
                                    </strong>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                    <div class="w-6 mb-5">
                                        <label class="font-bold text-lg mb-2 block"> Data de Moldagem</label>
                                        <p-datePicker 
                                            [(ngModel)]="tracaoEstufaDataMoldagem" 
                                            (ngModelChange)="onTracaoEstufaDataMoldagemChange()" 
                                            dateFormat="dd/mm/yy"
                                            placeholder="Selecione a data inicial" 
                                            [style]="{'width':'30%'}" 
                                            />
                                     </div>
                                     <div class="w-6 mt-3">
                                        <strong> Data Rompimento: </strong>{{ tracaoEstufaDataRompimento | date:'dd/MM/yyyy' }}
                                     </div>     
                            </div>

                            <br>
                            <div class="w-12 flex flex-row gap-4" style="align-items: flex-end;"> 
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Média de Resist. MPa: {{ tracao_estufa_media}} </strong>
                                </h2>
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Desvio Padrão: {{ tracao_estufa_desvio_padrao !== null ? tracao_estufa_desvio_padrao : '-' }} </strong>
                                </h2>
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Máx: {{ tracaoEstufaResultadoMax !== null ? tracaoEstufaResultadoMax : '-' }} </strong>
                                </h2>
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Mín: {{ tracaoEstufaResultadoMin !== null ? tracaoEstufaResultadoMin : '-' }} </strong>
                                </h2>
                                <!-- Card de Parecer do Ensaio -->
                                <div *ngIf="tracaoEstufaParecerEnsaio"
                                    [style]="{'background': tracaoEstufaParecerEnsaio === 'Ensaio Válido' ? 'linear-gradient(135deg, rgba(46, 125, 50, 0.9) 0%, rgba(76, 175, 80, 0.9) 100%)' : 'linear-gradient(135deg, rgba(198, 40, 40, 0.9) 0%, rgba(244, 67, 54, 0.9) 100%)', 'color': 'white', 'padding': '0.75rem 1.25rem', 'border-radius': '12px', 'border': tracaoEstufaParecerEnsaio === 'Ensaio Válido' ? '2px solid rgba(76, 175, 80, 0.5)' : '2px solid rgba(244, 67, 54, 0.5)', 'box-shadow': '0 4px 6px rgba(0,0,0,0.3)', 'margin-bottom': '0', 'min-width': '280px'}"
                                    class="flex align-items-center">
                                    <i [class]="tracaoEstufaParecerEnsaio === 'Ensaio Válido' ? 'pi pi-check-circle' : 'pi pi-times-circle'"
                                        style="font-size: 1.5rem; margin-right: 0.75rem;"></i>
                                    <div style="flex: 1;">
                                        <div *ngIf="tracaoEstufaParecerEnsaio === 'Ensaio Válido'" style="font-weight: 600; font-size: 1rem;">
                                            {{ tracaoEstufaParecerEnsaio }}
                                        </div>
                                        <div *ngIf="tracaoEstufaParecerEnsaio === 'Ensaio Inválido'">
                                            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">
                                                {{ tracaoEstufaParecerEnsaio }}
                                            </div>
                                            <div style="font-size: 0.85rem; opacity: 0.95;">
                                                Refazer o Ensaio = Número de pontos válidos menor que o mínimo necessário
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p-table [value]="linhasTracaoEstufa" stripedRows>
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Nº</th>
                                        <th>Diâmetro mm</th>
                                        <th>Área</th>
                                        <th>Carga kgf</th>
                                        <th>RESIST. Mpa</th>
                                        <th>Validação</th>
                                        <th>S</th>
                                        <th>S/A</th>
                                        <th>A</th>
                                        <th>A/P</th>
                                        <th>P</th>
                                        <th>F</th>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                    <tr>
                                        <td>{{ linha.numero }}</td>
                                        <td><input 
                                                pInputText 
                                                [(ngModel)]="linha.diametro"
                                                type="number"
                                                (ngModelChange)="atualizarAreaQuadrado(linha)"
                                                style="width: 70px"

                                            />
                                        </td>
                                        <td><input pInputText [(ngModel)]="linha.area" type="text" readonly (ngModelChange)="atualizarCalculosTracaoEstufa(linha)" style="width: 95px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.carga" type="number" (ngModelChange)="atualizarCalculosTracaoEstufa(linha)" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.resist" type="text" readonly style="width: 80px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.validacao" type="text" style="width: 100px" readonly/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.substrato" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.interfaceSubstrato" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.argamassa" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.interfaceArgamassa" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.placaCeramica" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.falhaCola" type="number" style="width: 70px"/></td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                    
                    <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                        <p-button 
                            label="Salvar Tração (Estufa)" 
                            severity="warn"
                            icon="pi pi-check" 
                            iconPos="right" 
                            tooltipPosition="top"
                            pTooltip="Salvar Tração (Estufa)"
                            (onClick)="salvarTracaoEstufa(analise)"
                        />
                    </div>
                </p-card>
            </div>    
        </div>
    </div>

</p-drawer>

<!-- tração tempo em aberto -->
<p-drawer 
    [(visible)]="modalDadosTracaoAberto" 
    position="full" >

    <div class="background-form">
        <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
            <div class="fg1 flex flex-column w-12 align-items-center">

                <p-card class="card w-12 text-center card-substrato">
                    <ng-template #header>
                        <div class="header-substrato w-full text-center">
                            <b>Resist. Ader. a Tração (Tempo em Aberto)</b>
                        </div>
                    </ng-template>
                    <div class="flex flex-row w-12 gap-3">
                        <div class="w-12">
                            <div class="flex gap-3 mb-3">
                                <div class="w-6">
                                    <strong> Tempo Previsto:
                                    <input pInputText [(ngModel)]="tracao_aberto_tempo_previsto" style="width: 200px" />
                                    </strong>
                                </div>

                                <div class="w-6">
                                    <strong> Tempo Trabalhado:
                                    <input pInputText [(ngModel)]="tracao_aberto_tempo_trabalho" style="width: 200px" />
                                    </strong>
                                </div>
                                <div class="w-6">
                                    <strong> Tempo em Aberto:
                                    <input pInputText [(ngModel)]="tracao_aberto_tempo_aberto" style="width: 200px" />
                                    </strong>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                    <div class="w-4 mb-5">
                                        <label class="font-bold text-lg mb-2 block"> Data de Moldagem</label>
                                        <p-datePicker 
                                            [(ngModel)]="tracaoAbertoDataMoldagem" 
                                            (ngModelChange)="onTracaoAbertoDataMoldagemChange()" 
                                            dateFormat="dd/mm/yy"
                                            placeholder="Selecione a data inicial" 
                                            [style]="{'width':'30%'}" 
                                            />
                                     </div>
                                     <div class="w-4 mt-3">
                                        <strong> Data Rompimento: </strong>{{ tracaoAbertoDataRompimento | date:'dd/MM/yyyy' }}
                                     </div>
                            </div>

                            <br>
                            <div class="w-12 flex flex-row gap-4" style="align-items: flex-end;"> 
                                <h2 style="color: white; margin-bottom: 0;">
                                    <strong> Média de Resist. MPa: {{ tracao_aberto_media}} </strong>
                                </h2>
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Desvio Padrão: {{ tracao_aberto_desvio_padrao  !== null ? tracao_aberto_desvio_padrao : '-' }} </strong>
                                    </h2>
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Máx: {{ tracaoAbertoResultadoMax !== null ? tracaoAbertoResultadoMax : '-' }} </strong>
                                    </h2>
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Mín: {{ tracaoAbertoResultadoMin !== null ? tracaoAbertoResultadoMin : '-' }} </strong>
                                    </h2>
                                    
                                    <!-- Card de Parecer do Ensaio -->
                                    <div 
                                        *ngIf="tracaoAbertoParecerEnsaio" 
                                        [style]="{'background': tracaoAbertoParecerEnsaio === 'Ensaio Válido' ? 'linear-gradient(135deg, rgba(46, 125, 50, 0.9) 0%, rgba(76, 175, 80, 0.9) 100%)' : 'linear-gradient(135deg, rgba(198, 40, 40, 0.9) 0%, rgba(244, 67, 54, 0.9) 100%)', 'color': 'white', 'padding': '0.75rem 1.25rem', 'border-radius': '12px', 'border': tracaoAbertoParecerEnsaio === 'Ensaio Válido' ? '2px solid rgba(76, 175, 80, 0.5)' : '2px solid rgba(244, 67, 54, 0.5)', 'box-shadow': '0 4px 6px rgba(0,0,0,0.3)', 'margin-bottom': '0', 'min-width': '280px'}"
                                        class="flex align-items-center">
                                        <i [class]="tracaoAbertoParecerEnsaio === 'Ensaio Válido' ? 'pi pi-check-circle' : 'pi pi-times-circle'" 
                                           style="font-size: 1.5rem; margin-right: 0.75rem;"></i>
                                        <div style="flex: 1;">
                                            <div *ngIf="tracaoAbertoParecerEnsaio === 'Ensaio Válido'" style="font-weight: 600; font-size: 1rem;">
                                                {{ tracaoAbertoParecerEnsaio }}
                                            </div>
                                            <div *ngIf="tracaoAbertoParecerEnsaio === 'Ensaio Inválido'">
                                                <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">
                                                    {{ tracaoAbertoParecerEnsaio }}
                                                </div>
                                                <div style="font-size: 0.85rem; opacity: 0.95;">
                                                    Refazer o Ensaio = Número de pontos válidos menor que o mínimo necessário
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                            <p-table [value]="linhasTracaoAberto" stripedRows>
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Nº</th>
                                        <th>Diâmetro mm</th>
                                        <th>Área</th>
                                        <th>Carga kgf</th>
                                        <th>RESIST. Mpa</th>
                                        <th>Validação</th>
                                        <th>S</th>
                                        <th>S/A</th>
                                        <th>A</th>
                                        <th>A/P</th>
                                        <th>P</th>
                                        <th>F</th>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                    <tr>
                                        <td>{{ linha.numero }}</td>
                                        <td><input 
                                                pInputText 
                                                [(ngModel)]="linha.diametro"
                                                type="number"
                                                (ngModelChange)="atualizarAreaQuadrado(linha)"
                                                style="width: 70px"

                                            />
                                        </td>
                                        <td><input pInputText [(ngModel)]="linha.area" type="text" readonly (ngModelChange)="atualizarCalculosTracaoAberto(linha)" style="width: 95px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.carga" type="number" (ngModelChange)="atualizarCalculosTracaoAberto(linha)" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.resist" type="text" readonly style="width: 80px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.validacao" type="text" style="width: 100px" readonly/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.substrato" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.interfaceSubstrato" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.argamassa" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.argamassaCola" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.placaCeramica" type="number" style="width: 70px"/></td>
                                        <td><input pInputText [(ngModel)]="linha.rupturas.falhaCola" type="number" style="width: 70px"/></td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                    
                    <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                        <p-button 
                            label="Salvar Tração (Tempo em Aberto)" 
                            severity="warn"
                            icon="pi pi-check" 
                            iconPos="right" 
                            tooltipPosition="top"
                            pTooltip="Salvar Tração (Tempo em Aberto)"
                            (onClick)="salvarTracaoAberto(analise)"
                        />
                    </div>
                </p-card>
            </div>    
        </div>
    </div>
    
</p-drawer>


<!-- Substrato Mpa -->
<p-drawer 
    [(visible)]="modalDadosLaudoSubstrato" 
    position="full" >
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-substrato">
                        <ng-template #header>
                            <div class="header-substrato w-full text-center">
                                <b>Determinação da resistência potencial de aderência a tração ao substrato</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                
                                <div class="flex gap-3 mb-4">
                                    <div class="w-6">
                                        <strong> Tempo Previsto:
                                        <input pInputText [(ngModel)]="substrato_tempo_previsto" style="width: 200px" />
                                        </strong>
                                    </div>

                                    <div class="w-6">
                                        <strong> Tempo Trabalhado:
                                        <input pInputText [(ngModel)]="substrato_tempo_trabalho" style="width: 200px" />
                                        </strong>
                                    </div>
                                </div>

                                <div class="flex gap-3">
                                    <div class="w-6 mb-5">
                                        <label class="font-bold text-lg mb-2 block"> Data de Moldagem</label>
                                        <p-datePicker 
                                            [(ngModel)]="substratoDataMoldagem" 
                                            (ngModelChange)="onSubstratoDataMoldagemChange()" 
                                            dateFormat="dd/mm/yy"
                                            placeholder="Selecione a data inicial" 
                                            [style]="{'width':'30%'}" 
                                            />
                                     </div>
                                     <div class="w-6 mt-3">
                                        <strong> Data Rompimento: </strong>{{ substratoDataRompimento | date:'dd/MM/yyyy' }}
                                     </div>     
                                </div>

                                <br>
                                <div class="w-12 flex flex-row gap-4" style="align-items: flex-end;"> 
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Média de Resist. MPa: {{ substrato_media }} </strong>
                                    </h2>
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Desvio Padrão: {{ substrato_desvio_padrao !== null ? substrato_desvio_padrao : '-' }} </strong>
                                    </h2>
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Máx: {{ substrato_resultado_max !== null ? substrato_resultado_max : '-' }} </strong>
                                    </h2>
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Mín: {{ substrato_resultado_min !== null ? substrato_resultado_min : '-' }} </strong>
                                    </h2>
                                    
                                    <!-- Card de Parecer do Ensaio -->
                                    <div 
                                        *ngIf="substrato_parecer_ensaio" 
                                        [style]="{'background': substrato_parecer_ensaio === 'Ensaio Válido' ? 'linear-gradient(135deg, rgba(46, 125, 50, 0.9) 0%, rgba(76, 175, 80, 0.9) 100%)' : 'linear-gradient(135deg, rgba(198, 40, 40, 0.9) 0%, rgba(244, 67, 54, 0.9) 100%)', 'color': 'white', 'padding': '0.75rem 1.25rem', 'border-radius': '12px', 'border': substrato_parecer_ensaio === 'Ensaio Válido' ? '2px solid rgba(76, 175, 80, 0.5)' : '2px solid rgba(244, 67, 54, 0.5)', 'box-shadow': '0 4px 6px rgba(0,0,0,0.3)', 'margin-bottom': '0', 'min-width': '280px'}"
                                        class="flex align-items-center">
                                        <i [class]="substrato_parecer_ensaio === 'Ensaio Válido' ? 'pi pi-check-circle' : 'pi pi-times-circle'" 
                                           style="font-size: 1.5rem; margin-right: 0.75rem;"></i>
                                        <div style="flex: 1;">
                                            <div *ngIf="substrato_parecer_ensaio === 'Ensaio Válido'" style="font-weight: 600; font-size: 1rem;">
                                                {{ substrato_parecer_ensaio }}
                                            </div>
                                            <div *ngIf="substrato_parecer_ensaio === 'Ensaio Inválido'">
                                                <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">
                                                    {{ substrato_parecer_ensaio }}
                                                </div>
                                                <div style="font-size: 0.85rem; opacity: 0.95;">
                                                    Refazer o Ensaio = Número de pontos válidos menor que o mínimo necessário
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                   
                                <p-table [value]="linhasSubstrato" stripedRows>
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Nº</th>
                                            <th>Diâmetro mm</th>
                                            <th>Área mm²</th>
                                            <th>Espessura mm</th>
                                            <th>Subst</th>
                                            <th>Junta</th>
                                            <th>Carga kgf</th>
                                            <th>RESIST. Mpa</th>
                                            <th>Validação</th>
                                            <th>(A) Sub</th>
                                            <th>(B) Sub/Arga</th>
                                            <th>(C) Rup Arga</th>
                                            <th>(D) Arga Cola</th>
                                            <th>(E) Colar pastilha</th>
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                        <tr>
                                            <td>{{ linha.numero }}</td>
                                            <td><input 
                                                    pInputText 
                                                    [(ngModel)]="linha.diametro"
                                                    type="number"
                                                    (ngModelChange)="atualizarArea(linha)"
                                                    style="width: 70px"

                                                />
                                            </td>
                                            <td><input pInputText [(ngModel)]="linha.area" type="text" readonly (ngModelChange)="atualizarCalculosSubstrato(linha)" style="width: 95px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.espessura" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.subst" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.junta" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.carga" type="number" (ngModelChange)="atualizarCalculosSubstrato(linha)" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.resist" type="text" readonly style="width: 80px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.validacao" type="text" style="width: 100px" readonly/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.sub" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.subArga" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.rupArga" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.argaCola" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.colarPastilha" type="number" style="width: 70px"/></td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar Substrato" 
                                severity="warn"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar Substrato"
                                (onClick)="salvarSubstrato(analise)"
                            />
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>

</p-drawer>

<!-- superficial -->
<p-drawer 
    [(visible)]="modalDadosLaudoSuperficial" 
    position="full" >
    <p-toast />
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-superficial">
                        <ng-template #header>
                            <div class="header-superficial w-full text-center">
                                <b>Determinação da resistência potencial de aderência a tração superficial</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                <div class="flex gap-3 mb-3">
                                    <div class="w-6">
                                        <strong> Tempo Previsto:
                                        <input pInputText [(ngModel)]="superficial_tempo_previsto" style="width: 200px" />
                                        </strong>
                                    </div>

                                    <div class="w-6">
                                        <strong> Tempo Trabalhado:
                                        <input pInputText [(ngModel)]="superficial_tempo_trabalho" style="width: 200px" />
                                        </strong>
                                    </div>
                                </div>

                                <div class="flex gap-3">
                                    <div class="w-6 mb-5">
                                        <label class="font-bold text-lg mb-2 block"> Data de Moldagem</label>
                                        <p-datePicker 
                                            [(ngModel)]="superficialDataMoldagem" 
                                            (ngModelChange)="onSuperficialDataMoldagemChange()" 
                                            dateFormat="dd/mm/yy"
                                            placeholder="Selecione a data inicial" 
                                            [style]="{'width':'30%'}" 
                                            />
                                     </div>
                                     <div class="w-6 mt-3">
                                        <strong> Data Rompimento: </strong>{{ superficialDataRompimento | date:'dd/MM/yyyy' }}
                                     </div>     
                                </div>

                                <br>

                                <div class="w-12 flex flex-row gap-4" style="align-items: flex-end;"> 
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Média de Resist. MPa: {{ superficial_media }} </strong>
                                    </h2>
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Desvio Padrão: {{ superficial_desvio_padrao !== null ? superficial_desvio_padrao : '-' }} </strong>
                                    </h2>
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Máx: {{ superficial_resultado_max !== null ? superficial_resultado_max : '-' }} </strong>
                                    </h2>
                                    <h2 style="color: white; margin-bottom: 0;">
                                        <strong> Mín: {{ superficial_resultado_min !== null ? superficial_resultado_min : '-' }} </strong>
                                    </h2>
                                    
                                    <!-- Card de Parecer do Ensaio -->
                                    <div 
                                        *ngIf="superficial_parecer_ensaio" 
                                        [style]="{'background': superficial_parecer_ensaio === 'Ensaio Válido' ? 'linear-gradient(135deg, rgba(46, 125, 50, 0.9) 0%, rgba(76, 175, 80, 0.9) 100%)' : 'linear-gradient(135deg, rgba(198, 40, 40, 0.9) 0%, rgba(244, 67, 54, 0.9) 100%)', 'color': 'white', 'padding': '0.75rem 1.25rem', 'border-radius': '12px', 'border': superficial_parecer_ensaio === 'Ensaio Válido' ? '2px solid rgba(76, 175, 80, 0.5)' : '2px solid rgba(244, 67, 54, 0.5)', 'box-shadow': '0 4px 6px rgba(0,0,0,0.3)', 'margin-bottom': '0', 'min-width': '280px'}"
                                        class="flex align-items-center">
                                        <i [class]="superficial_parecer_ensaio === 'Ensaio Válido' ? 'pi pi-check-circle' : 'pi pi-times-circle'" 
                                           style="font-size: 1.5rem; margin-right: 0.75rem;"></i>
                                        <div style="flex: 1;">
                                            <div *ngIf="superficial_parecer_ensaio === 'Ensaio Válido'" style="font-weight: 600; font-size: 1rem;">
                                                {{ superficial_parecer_ensaio }}
                                            </div>
                                            <div *ngIf="superficial_parecer_ensaio === 'Ensaio Inválido'">
                                                <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">
                                                    {{ superficial_parecer_ensaio }}
                                                </div>
                                                <div style="font-size: 0.85rem; opacity: 0.95;">
                                                    Refazer o Ensaio = Número de pontos válidos menor que o mínimo necessário
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <div class="w-12"> 
                                    <h2 style="color: white">
                                        <strong> Média de Resist. MPa: {{ superficial_media}} </strong>
                                    </h2>
                                </div>
                                <p-table 
                                    [value]="linhasSuperficial" 
                                    stripedRows
                                >
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Nº</th>
                                            <th>Diâmetro mm</th>
                                            <th>Área mm²</th>
                                            <th>Espessura mm</th>
                                            <th>Subst</th>
                                            <th>Junta</th>
                                            <th>Carga kgf</th>
                                            <th>RESIST. Mpa</th>
                                            <th>Validação</th>
                                            <th>(A) Sub</th>
                                            <th>(B) Sub/Arga</th>
                                            <th>(C) Rup Arga</th>
                                            <th>(D) Arga Cola</th>
                                            <th>(E) Colar pastilha</th>
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                        <tr>
                                            <td>{{ linha.numero }}</td>
                                            <td>
                                                <input 
                                                    pInputText 
                                                    [(ngModel)]="linha.diametro" 
                                                    type="number"
                                                    (ngModelChange)="atualizarAreaSuper(linha)"
                                                    style="width: 70px"
                                                />
                                            </td>
                                            <td><input pInputText [(ngModel)]="linha.area" type="number" readonly style="width: 95px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.espessura" type="number"style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.subst" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.junta" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.carga" type="number" style="width: 70px" (ngModelChange)="atualizarCalculosSuper(linha)"/></td>
                                            <td><input pInputText [(ngModel)]="linha.resist" type="number" step="0.01" style="width: 80px" readonly/></td>
                                            <td><input pInputText [(ngModel)]="linha.validacao" type="text" style="width: 100px" readonly/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.sub" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.subArga" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.rupArga" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.argaCola" type="number" style="width: 70px"/></td>
                                            <td><input pInputText [(ngModel)]="linha.rupturas.colarPastilha" type="number" style="width: 70px"/></td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar tração superficial" 
                                (onClick)="salvarSuperficial(analise)"
                                severity="info"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar tração superficial"
                            />
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>    
</p-drawer>

<!-- retracao -->
<p-drawer 
    [(visible)]="modalDadosLaudoRetracao" 
    position="full" >
    <p-toast />
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-superficial">
                        <ng-template #header>
                            <div class="header-retracao w-full text-center">
                                <b>Determinação da Variação Dimencional Linear (Retração/Expansão)</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                <p-table 
                                    [value]="linhasRetracao" 
                                    stripedRows
                                >
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Data</th>
                                            <th>Idade</th>
                                            <th>Média (mm/m)</th>
                                            <th>Desvio Máximo (mm/m)</th>
                                            
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-retracao let-i="rowIndex">
                                        <tr>
                                            <td><input pInputText [(ngModel)]="retracao.data" type="date" /></td>
                                            <td><input pInputText [(ngModel)]="retracao.idade" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="retracao.media" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="retracao.desvio" type="number" /></td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar Variação Dimencional Linear" 
                                (onClick)="salvarRetracao(analise)"
                                severity="info"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar Variação Dimencional Linear"
                                [style]="{'background-color': 'rgb(108, 165, 42)', 'border-color': 'rgb(108, 165, 42)'}"
                            />
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>
</p-drawer>

<!-- elasticidade -->
<p-drawer 
    [(visible)]="modalDadosLaudoElasticidade" 
    position="full" >
    <p-toast />
        <div class="background-form">
            <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
                <div class="fg1 flex flex-column w-12 align-items-center">

                    <p-card class="card w-12 text-center card-superficial">
                        <ng-template #header>
                            <div class="header-elasticidade w-full text-center">
                                <b>Módulo de Elasticidade Dinâmico</b>
                            </div>
                        </ng-template>
                        <div class="flex flex-row w-12 gap-3">
                            <div class="w-12">
                                <p-table 
                                    [value]="linhasElasticidade" 
                                    stripedRows
                                >
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Individual</th>
                                            <th>Média (Mpa)</th>
                                            <th>Desvio Padrão (%)</th>
                                            
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-elasticidade let-i="rowIndex">
                                        <tr>
                                            <td><input pInputText [(ngModel)]="elasticidade.individual" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="elasticidade.media" type="number" /></td>
                                            <td><input pInputText [(ngModel)]="elasticidade.desvio_padrao" type="number" /></td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                            </div>
                        </div>
                        
                        <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                            <p-button 
                                label="Salvar Módulo de Elasticidade Dinâmico" 
                                (onClick)="salvarElasticidade(analise)"
                                severity="info"
                                icon="pi pi-check" 
                                iconPos="right" 
                                tooltipPosition="top"
                                pTooltip="Salvar Módulo de Elasticidade Dinâmico"
                                [style]="{'background-color': ' rgb(182, 109, 32)', 'border-color': ' rgb(182, 109, 32)'}"
                            />
                        </div>
                    </p-card>
                </div>    
            </div>
        </div>
</p-drawer>

<!-- Modal Compressão e Flexão -->
<p-drawer 
    [(visible)]="exibirModalCompressaoFlexao" 
    position="full" 
>
    <div class="mb-4">
        <h2 class="font-bold text-2xl mb-4" style="color: #ffffff;"> Resistência à Tração na Flexão e à Compressão</h2>
    </div>

    <!-- Data de Moldagem -->
    <div class="mb-4">
        <label class="font-bold text-lg mb-2 block">Data de Moldagem</label>
        <p-datePicker 
            [(ngModel)]="moldagemData" 
            (ngModelChange)="onMoldagemDataChange()"
            dateFormat="dd/mm/yy"
            placeholder="Selecione a data de moldagem"
            [style]="{'width':'100%'}"
        />
    </div>

    <!-- Seção Flexão -->
    <div class="mb-5">
        <h3 class="font-bold text-xl mb-3" style="color: #48bb78;">Resistência à Tração na Flexão</h3>
        
        <!-- Data de Rompimento -->
        <div class="mb-3">
            <label class="font-semibold mb-2 block">Data de Rompimento (28 dias)</label>
            <div class="grid">
                <div class="col-12 md:col-6" *ngIf="analise?.amostra_detalhes?.material?.toLowerCase() === 'argamassa'" >
                    <label class="text-sm mb-1 block">Argamassa</label>
                    <p-datePicker 
                        [(ngModel)]="rompimentoFlexaoArgamassa28"
                        dateFormat="dd/mm/yy"
                        placeholder="Data rompimento argamassa"
                        [style]="{'width':'100%'}"
                    />
                </div>
                <div class="col-12 md:col-6" *ngIf="analise?.amostra_detalhes?.material?.toLowerCase() === 'cimento'">
                    <label class="text-sm mb-1 block">Cimento</label>
                    <p-datePicker 
                        [(ngModel)]="rompimentoFlexaoCimento28"
                        dateFormat="dd/mm/yy"
                        placeholder="Data rompimento cimento"
                        [style]="{'width':'100%'}"
                    />
                </div>
            </div>
        </div>

        <!-- Tabela Flexão -->
        <p-table 
            [value]="tabelaFlexaoData" 
            [tableStyle]="{'min-width': '50rem'}"
            styleClass="p-datatable-striped"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 100px;">CP</th>
                    <th style="width: 180px;">Carga de Ruptura (kN)</th>
                    <th style="width: 200px;">Resistência (Mpa)</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
                <tr>
                    <td>
                        <span class="font-semibold">{{ row.cp }}</span>
                    </td>
                    <td>
                        <p-inputNumber
                            *ngIf="row.cp === 1"
                            [(ngModel)]="cargaRupturaFlexaoCp1"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 2"
                            [(ngModel)]="cargaRupturaFlexaoCp2"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 3"
                            [(ngModel)]="cargaRupturaFlexaoCp3"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                    </td>
                   
                    <td>
                        <p-inputNumber
                            *ngIf="row.cp === 1"
                            [(ngModel)]="resistenciaFlexaoMediaCp1"
                            (ngModelChange)="realizarCalculosFlexao()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 2"
                            [(ngModel)]="resistenciaFlexaoMediaCp2"
                            (ngModelChange)="realizarCalculosFlexao()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 3"
                            [(ngModel)]="resistenciaFlexaoMediaCp3"
                            (ngModelChange)="realizarCalculosFlexao()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="footer">
                <tr style="background-color: #1a2537; border-top: 3px solid #48bb78;">
                    <td colspan="3" style="text-align: right; color: #48bb78; font-weight: 700; font-size: 17px; padding: 14px;">
                        Resistência Média à Tração na Flexão:
                    </td>
                    <td style="text-align: center; color: #48bb78; font-weight: 900; font-size: 24px; padding: 14px;">
                        <span *ngIf="resistenciaFlexaoMediaGeral !== null && !isNaN(resistenciaFlexaoMediaGeral)">
                            {{ resistenciaFlexaoMediaGeral | number:'1.2-2' }} MPa
                        </span>
                        <span *ngIf="resistenciaFlexaoMediaGeral === null || isNaN(resistenciaFlexaoMediaGeral)">
                            - MPa
                        </span>
                    </td>
                </tr>
                <tr style="background-color: #1a2537;">
                    <td colspan="3" style="text-align: right; color: #48bb78; font-weight: 700; font-size: 15px; padding: 10px;">
                        Desvio Absoluto (MAD):
                    </td>
                    <td style="text-align: center; color: #48bb78; font-weight: 700; font-size: 18px; padding: 10px;">
                        <span *ngIf="desvioAbsolutoFlexao !== null && !isNaN(desvioAbsolutoFlexao)">
                            {{ desvioAbsolutoFlexao | number:'1.2-2' }} MPa
                        </span>
                        <span *ngIf="desvioAbsolutoFlexao === null || isNaN(desvioAbsolutoFlexao)">
                            - MPa
                        </span>
                    </td>
                </tr>
                <tr style="background-color: #1a2537;">
                    <td colspan="3" style="text-align: right; color: #48bb78; font-weight: 700; font-size: 15px; padding: 10px;">
                        Desvio Absoluto Máximo:
                    </td>
                    <td style="text-align: center; color: #48bb78; font-weight: 700; font-size: 18px; padding: 10px;">
                        <span *ngIf="desvioAbsolutoMaximoFlexao !== null && !isNaN(desvioAbsolutoMaximoFlexao)">
                            {{ desvioAbsolutoMaximoFlexao | number:'1.2-2' }} MPa
                        </span>
                        <span *ngIf="desvioAbsolutoMaximoFlexao === null || isNaN(desvioAbsolutoMaximoFlexao)">
                            - MPa
                        </span>
                    </td>
                </tr>
            </ng-template>
        </p-table>

    </div>

    <!-- Seção Compressão -->
    <div class="mb-5">
        <h3 class="font-bold text-xl mb-3" style="color: #667eea;"> Resistência à Compressão</h3>
        
        <!-- Datas de Rompimento -->
        <div class="mb-3">
            <label class="font-semibold mb-2 block">Datas de Rompimento</label>
            <div class="grid">
                <div class="col-12 md:col-4" *ngIf="analise?.amostra_detalhes?.material?.toLowerCase() === 'argamassa'">
                    <label class="text-sm mb-1 block">Argamassa (28 dias)</label>
                    <p-datePicker 
                        [(ngModel)]="rompimentoCompressaoArgamassa28"
                        dateFormat="dd/mm/yy"
                        placeholder="Data rompimento"
                        [style]="{'width':'100%'}"
                    />
                </div>
                <div class="col-12 md:col-4" *ngIf="analise?.amostra_detalhes?.material?.toLowerCase() === 'cimento'">
                    <label class="text-sm mb-1 block">Cimento (7 dias)</label>
                    <p-datePicker 
                        [(ngModel)]="rompimentoCompressaoCimento7"
                        dateFormat="dd/mm/yy"
                        placeholder="Data rompimento"
                        [style]="{'width':'100%'}"
                    />
                </div>
                <div class="col-12 md:col-4" *ngIf="analise?.amostra_detalhes?.material?.toLowerCase() === 'cimento'">
                    <label class="text-sm mb-1 block">Cimento (28 dias)</label>
                    <p-datePicker 
                        [(ngModel)]="rompimentoCompressaoCimento28"
                        dateFormat="dd/mm/yy"
                        placeholder="Data rompimento"
                        [style]="{'width':'100%'}"
                    />
                </div>
            </div>
        </div>

        <!-- Tabela Compressão -->
        <p-table 
            [value]="tabelaCompressaoData" 
            [tableStyle]="{'min-width': '50rem'}"
            styleClass="p-datatable-striped"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 100px;">CP</th>
                    <th style="width: 200px;">Carga de Ruptura a Compressão (N)</th>
                    <th style="width: 180px;">Resis. à Tração na Compressão (Mpa)</th>
                    <th style="width: 80px;">
                        <i class="pi pi-times-circle" style="margin-right: 5px;"></i>
                        Ignorar
                    </th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
                <tr>
                    <td>
                        <span class="font-semibold">{{ row.cp }}</span>
                    </td>
                    <td>
                        <p-inputNumber
                            *ngIf="row.cp === 1"
                            [(ngModel)]="cargaRupturaCompressaoCp1"
                            mode="decimal"
                            [minFractionDigits]="2" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 2"
                            [(ngModel)]="cargaRupturaCompressaoCp2"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 3"
                            [(ngModel)]="cargaRupturaCompressaoCp3"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 4"
                            [(ngModel)]="cargaRupturaCompressaoCp4"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 5"
                            [(ngModel)]="cargaRupturaCompressaoCp5"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 6"
                            [(ngModel)]="cargaRupturaCompressaoCp6"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                    </td>
                    <td>
                        <p-inputNumber
                            *ngIf="row.cp === 1"
                            [(ngModel)]="resistenciaCompressaoMediaCp1"
                            (ngModelChange)="realizarCalculosCompressao()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 2"
                            [(ngModel)]="resistenciaCompressaoMediaCp2"
                            (ngModelChange)="realizarCalculosCompressao()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 3"
                            [(ngModel)]="resistenciaCompressaoMediaCp3"
                            (ngModelChange)="realizarCalculosCompressao()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 4"
                            [(ngModel)]="resistenciaCompressaoMediaCp4"
                            (ngModelChange)="realizarCalculosCompressao()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 5"
                            [(ngModel)]="resistenciaCompressaoMediaCp5"
                            (ngModelChange)="realizarCalculosCompressao()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                        <p-inputNumber
                            *ngIf="row.cp === 6"
                            [(ngModel)]="resistenciaCompressaoMediaCp6"
                            (ngModelChange)="realizarCalculosCompressao()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="4" 
                            [style]="{'width':'100%'}"
                            variant="filled"
                        ></p-inputNumber>
                    </td>
                    <td style="text-align: center;">
                        <p-checkbox
                            *ngIf="row.cp === 1"
                            [(ngModel)]="desconsiderarCompressaoCp1"
                            (ngModelChange)="realizarCalculosCompressao()"
                            [binary]="true"
                        ></p-checkbox>
                        <p-checkbox
                            *ngIf="row.cp === 2"
                            [(ngModel)]="desconsiderarCompressaoCp2"
                            (ngModelChange)="realizarCalculosCompressao()"
                            [binary]="true"
                        ></p-checkbox>
                        <p-checkbox
                            *ngIf="row.cp === 3"
                            [(ngModel)]="desconsiderarCompressaoCp3"
                            (ngModelChange)="realizarCalculosCompressao()"
                            [binary]="true"
                        ></p-checkbox>
                        <p-checkbox
                            *ngIf="row.cp === 4"
                            [(ngModel)]="desconsiderarCompressaoCp4"
                            (ngModelChange)="realizarCalculosCompressao()"
                            [binary]="true"
                        ></p-checkbox>
                        <p-checkbox
                            *ngIf="row.cp === 5"
                            [(ngModel)]="desconsiderarCompressaoCp5"
                            (ngModelChange)="realizarCalculosCompressao()"
                            [binary]="true"
                        ></p-checkbox>
                        <p-checkbox
                            *ngIf="row.cp === 6"
                            [(ngModel)]="desconsiderarCompressaoCp6"
                            (ngModelChange)="realizarCalculosCompressao()"
                            [binary]="true"
                        ></p-checkbox>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="footer">
                <tr style="background-color: #1a2537; border-top: 3px solid #667eea;">
                    <td colspan="3" style="text-align: right; color: #667eea; font-weight: 700; font-size: 17px; padding: 14px;">
                        Resistência Média à Tração na Compressão:
                    </td>
                    <td style="text-align: center; color: #667eea; font-weight: 900; font-size: 24px; padding: 14px;">
                        <span *ngIf="resistenciaCompressaoMediaGeral !== null && !isNaN(resistenciaCompressaoMediaGeral)">
                            {{ resistenciaCompressaoMediaGeral | number:'1.2-2' }} MPa
                        </span>
                        <span *ngIf="resistenciaCompressaoMediaGeral === null || isNaN(resistenciaCompressaoMediaGeral)">
                            - MPa
                        </span>
                    </td>
                </tr>
                <tr style="background-color: #1a2537;">
                    <td colspan="3" style="text-align: right; color: #667eea; font-weight: 700; font-size: 15px; padding: 10px;">
                        Desvio Absoluto (MAD):
                    </td>
                    <td style="text-align: center; color: #667eea; font-weight: 700; font-size: 18px; padding: 10px;">
                        <span *ngIf="desvioAbsolutoCompressao !== null && !isNaN(desvioAbsolutoCompressao)">
                            {{ desvioAbsolutoCompressao | number:'1.2-2' }} MPa
                        </span>
                        <span *ngIf="desvioAbsolutoCompressao === null || isNaN(desvioAbsolutoCompressao)">
                            - MPa
                        </span>
                    </td>
                </tr>
                <tr style="background-color: #1a2537;">
                    <td colspan="3" style="text-align: right; color: #667eea; font-weight: 700; font-size: 15px; padding: 10px;">
                        Desvio Absoluto Máximo:
                    </td>
                    <td style="text-align: center; color: #667eea; font-weight: 700; font-size: 18px; padding: 10px;">
                        <span *ngIf="desvioAbsolutoMaximoCompressao !== null && !isNaN(desvioAbsolutoMaximoCompressao)">
                            {{ desvioAbsolutoMaximoCompressao | number:'1.2-2' }} MPa
                        </span>
                        <span *ngIf="desvioAbsolutoMaximoCompressao === null || isNaN(desvioAbsolutoMaximoCompressao)">
                            - MPa
                        </span>
                    </td>
                </tr>
            </ng-template>
        </p-table>

    </div>

    <!-- Botões -->
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <p-button 
          label="Limpar" 
          icon="pi pi-eraser" 
          severity="info"
          iconPos="right"
          (onClick)="limparCompressaoFlexao()">
        </p-button>
        <p-button 
          label="Salvar" 
          icon="pi pi-check" 
          severity="success"
          iconPos="right"
          (onClick)="salvarCompressaoFlexao(analise)">
        </p-button>
    </div>

</p-drawer>

<!-- Gráfico -->
<p-drawer 
    [(visible)]="modalGrafico" 
    position="full" 
>
    <div class="container">
    <h2>Cálculo do Coeficiente de Absorção de Água por Capilaridade (Aw)</h2>

    <!-- Layout com tabela e gráfico lado a lado -->
    <div class="flex flex-column lg:flex-row gap-4 w-full">
        
        <!-- Seção da Tabela de Dados (Lado Esquerdo) -->
        <div class="flex-1">
            <form [formGroup]="dataForm" class="data-input-area">
                <h3 style="color: #ffffff;">1. Entrada de Dados Experimentais (Fase Linear)</h3>

                <p-table 
                    [value]="dataRows.controls" 
                    class="data-table"
                    [tableStyle]="{'min-width': '40rem'}"
                    formArrayName="dataRows"
                >
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Tempo</th>
                            <th>Raiz t (h¹/²)</th>
                            <th>Δmt (kg/m²)</th>
                            <th>Ações</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-row let-i="rowIndex">
                        <tr [formGroupName]="i">
                            <td>
                                {{ dataRows.at(i).get('tLabel')?.value }}
                            </td>
                            <td>
                                <p-inputNumber
                                    [formControlName]="'raizT'"
                                    mode="decimal"
                                    [minFractionDigits]="0"
                                    [maxFractionDigits]="2"
                                    [step]="0.01"
                                    [style]="{'width':'100%'}"
                                    placeholder="0.00"
                                ></p-inputNumber>
                            </td>
                            <td>
                                <p-inputNumber
                                    [formControlName]="'deltaMt'"
                                    mode="decimal"
                                    [minFractionDigits]="0"
                                    [maxFractionDigits]="2"
                                    [step]="0.01"
                                    [style]="{'width':'100%'}"
                                    placeholder="0.00"
                                ></p-inputNumber>
                            </td>
                            <td>
                                <p-button 
                                    *ngIf="i >= dadosIniciais.length"
                                    icon="pi pi-trash" 
                                    severity="danger" 
                                    size="small"
                                    [text]="true"
                                    (onClick)="removeDataRow(i)"
                                    pTooltip="Remover linha"
                                    tooltipPosition="top"
                                ></p-button>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

                <div class="flex justify-content-center mt-3">
                    <p-button 
                        label="Adicionar Ponto" 
                        icon="pi pi-plus" 
                        severity="success" 
                        (onClick)="addDataRow()"
                        pTooltip="Adicionar nova linha de dados"
                        tooltipPosition="top"
                    ></p-button>
                </div>
            </form>
        </div>

        <!-- Seção do Gráfico (Lado Direito) -->
        <div class="flex-1">
            <h3 style="color: #ffffff;">2. Gráfico de Regressão Linear</h3>
            
            <!-- Controle de Coeficiente Linear Customizado -->
            <div class="bg-blue-900 p-3 border-round mb-3">
                <div class="flex align-items-center gap-3 mb-3">
                    <label class="flex align-items-center gap-2 cursor-pointer" style="color: #ffffff;">
                        <input 
                            type="checkbox" 
                            [(ngModel)]="usarCoeficienteCustomizado"
                            (change)="toggleCoeficienteCustomizado()"
                            style="cursor: pointer; width: 18px; height: 18px;"
                        />
                        <span style="font-weight: 500;">Usar Coeficiente Linear (Intercepto) Customizado</span>
                    </label>
                </div>
                
                <div class="flex flex-column gap-2">
                    <div class="flex align-items-center gap-2">
                        <label style="color: #ffffff; min-width: 150px; font-weight: 500;">Coef. Linear (b):</label>
                        <p-inputNumber
                            [(ngModel)]="coeficienteLinearCustomizado"
                            (onInput)="atualizarCoeficienteCustomizado()"
                            [disabled]="!usarCoeficienteCustomizado"
                            mode="decimal"
                            [minFractionDigits]="4"
                            [maxFractionDigits]="11"
                            [step]="0.0001"
                            [style]="{'width':'250px'}"
                            placeholder="Ex: 3.2497"
                        ></p-inputNumber>
                    </div>
                    <small style="color: #cbd5e0; margin-left: 150px;">
                        Intercepto calculado pela regressão: <strong>{{ bIntercepto | number:'1.4-11' }}</strong>
                    </small>
                </div>
            </div>

            <div class="chart-area">
                <div class="w-full" style="height: 500px;">
                    <canvas #meuGrafico></canvas>
                </div>

                <div class="resultados mt-4">
                    <h3 style="color: #ffffff;">Resultado Calculado (Aw)</h3>
                    <div class="bg-gray-50 p-3 border-round mb-3">
                        <p class="m-0 mb-2">
                            <strong>Aw (Laboratório):</strong> 
                            <span *ngIf="awLaboratorioCalculado !== null" style="font-weight: bold; color: #059669; font-size: 1.2em;">
                                 {{ awLaboratorioCalculado | number:'1.2-2' }} kg/(m² · h¹/²)
                            </span>
                            <span *ngIf="awLaboratorioCalculado === null" class="text-muted">Aguardando dados válidos...</span>
                        </p>
                        <p class="m-0 mb-2">
                            <strong>Inclinação (m):</strong> 
                            <span *ngIf="awCalculado !== null" style="font-weight: bold; color: #059669; font-size: 1.2em;">
                                {{ awCalculado | number:'1.2-2' }}
                            </span>
                        </p>
                        <p class="m-0 mb-2">
                            <strong>Intercepto (b):</strong> 
                            <span *ngIf="bIntercepto !== null">
                                {{ bIntercepto | number:'1.4-11' }}
                                <span *ngIf="usarCoeficienteCustomizado" style="color: #059669; font-weight: bold;">
                                    → Usando: {{ coeficienteLinearCustomizado | number:'1.4-11' }}
                                </span>
                            </span>
                        </p>
                        <!-- <p class="m-0">
                            <strong>R²:</strong> {{ r2Calculado | number:'1.4-4' }}
                        </p> -->
                    </div>
                    
                    <!-- Botões para salvar/baixar imagem do gráfico -->
                    <div class="flex flex-column sm:flex-row gap-2 justify-content-center">
                        <p-button 
                            label="Salvar no Banco" 
                            icon="pi pi-cloud-upload"
                            severity="success"
                            [loading]="salvandoImagemGrafico"
                            (click)="gerarESalvarImagemGrafico()"
                            [disabled]="!chartInstance"
                            pTooltip="Salva a imagem do gráfico no banco de dados da amostra">
                        </p-button>
                        
                        <p-button 
                            label="Download" 
                            icon="pi pi-download"
                            severity="info"
                            (click)="downloadImagemGrafico()"
                            [disabled]="!chartInstance"
                            pTooltip="Baixa a imagem do gráfico para seu computador">
                        </p-button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</p-drawer>

<!-- Peneira -->
<p-drawer 
    [(visible)]="exibirModalPeneiraSeca" 
    position="full" 
>
    <div class="background-form">
        <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
            <div class="fg1 flex flex-column w-12 align-items-center">
                <p-card class="card w-12 text-center card-peneira">
                    <ng-template #header>
                        <div class="header-substrato w-full text-center">
                            <b>Peneiras Secas</b>
                        </div>
                    </ng-template>
                        <div class="flex flex-row w-12 gap-4 justify-content-start mb-3">
                            <label class="flex align-items-center gap-2">
                                <span class="font-semibold">Plano de Peneiras:</span>
                                <p-select
                                    [options]="planosPeneiras"
                                    [(ngModel)]="planoSelecionado"
                                    optionLabel="label"
                                    optionValue="value"
                                    placeholder="Selecione um plano"
                                    (onChange)="carregarPlanoPeneira($event.value)"
                                    appendTo="body"
                                    [showClear]="true"
                                    styleClass="w-15rem"
                                ></p-select>
                            </label>
                        </div>
                    <div class="flex flex-row w-12 gap-4 justify-content-start mb-3">
                        <label class="flex align-items-center gap-2">
                            Massa da Amostra:
                            <input 
                                pInputText 
                                id="massa_amostra" 
                                type="number" 
                                [(ngModel)]="massa_amostra"
                                style="width: 150px;"
                            />
                        </label>
                        <label class="flex align-items-center gap-2">
                            Finos Calculados:
                            <input 
                                pInputText 
                                id="total_fino" 
                                type="number" 
                                readOnly="true"
                                [(ngModel)]="total_finos"
                                style="width: 150px;"
                            />
                        </label>

                        <label class="flex align-items-center gap-2">
                            Finos Digitados:
                            <input 
                                pInputText 
                                id="total_fino_digitado" 
                                type="number" 
                                [(ngModel)]="total_finos_digitado"
                                style="width: 150px;"
                                (ngModelChange)="atualizaValoresCalculoPeneira()"
                            />
                        </label>

                        <label class="flex align-items-center gap-2">
                            Finos Cálculo:
                            <input 
                                pInputText 
                                id="total_fino_calculado" 
                                type="number" 
                                readOnly="true"
                                [(ngModel)]="total_finos_calculado"
                                style="width: 150px;"
                               [ngStyle]="{ color: (total_finos_calculado ?? 0) > 2 ? 'red' : (total_finos_calculado ?? 0) > 1 ? 'orange' : 'inherit' }"
                            />
                        </label>
                    </div>


                    <div class="flex flex-row w-12 gap-3">
                        <div class="w-12">
                            <p-table [value]="linhasPeneira" stripedRows>
                                    <ng-template pTemplate="header">
                                    <tr>
                                        <th>Peneira</th>
                                        <th>Retido (g)</th>
                                        <th>Retido (%)</th>
                                        <th>Passante (%)</th>
                                        <th>Acumulado (%)</th>
                                        <th>Passante Acumulado(%)</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                    <tr>
                                        <td>
                                            <p-floatLabel variant="on">
                                                <p-select
                                                    [options]="peneirasDados"
                                                    [(ngModel)]="linha.peneira"
                                                    optionLabel="value"
                                                    optionValue="value"
                                                    placeholder="Selecione a peneira"
                                                    appendTo="body"
                                                ></p-select>
                                                <label for="float-label">Peneiras</label>
                                            </p-floatLabel>
                                        </td>

                                        <td>
                                            <input 
                                                pInputText 
                                                [(ngModel)]="linha.valor_retido"
                                                type="number"
                                                min="0"
                                                step="any"
                                                (ngModelChange)="atualizarValores(i)"
                                                style="width: 150px"
                                            />
                                        </td>

                                        <td>
                                        <input 
                                            pInputText 
                                            [(ngModel)]="linha.porcentual_retido"
                                            type="number"
                                            [readonly]="true"
                                            style="width: 150px"
                                        />
                                        </td>

                                        <td>
                                        <input 
                                            pInputText 
                                            [(ngModel)]="linha.passante"
                                            type="number"
                                            [readonly]="true"
                                            style="width: 150px"
                                        />
                                        </td>

                                        <td>
                                        <input 
                                            pInputText 
                                            [(ngModel)]="linha.acumulado"
                                            type="number"
                                            [readonly]="true"
                                            style="width: 150px"
                                        />
                                        </td>

                                        <td>
                                        <input 
                                            pInputText 
                                            [(ngModel)]="linha.passante_acumulado"
                                            type="number"
                                            [readonly]="true"
                                            style="width: 150px"
                                        />
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                    <br>
                    <br>
                    <p-button 
                        (onClick)="addLinhaSeca()" 
                        label="Adicionar Linha"
                        iconPos="right"  
                        tooltipPosition="top"
                        pTooltip="Adicionar Linha"
                        icon="pi pi-plus"
                        severity="info"
                    />

                    <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                        <p-button 
                            label="Salvar Peneiras Secas" 
                            severity="info"
                            icon="pi pi-check" 
                            iconPos="right" 
                            tooltipPosition="top"
                            [disabled]="bloqueiaSalvarPeneiraSeca"
                            [pTooltip]="bloqueiaSalvarPeneiraSeca ? 'Resultado maior que 2% — ajuste os valores' : 'Salvar Peneiras Secas'"
                            pTooltip="Salvar Peneiras Secas"
                            (onClick)="salvarPeneiraSeca(analise)"
                        />
                    </div>
                </p-card>
            </div>    
        </div>
    </div>
</p-drawer>

<!-- Peneira Úmida -->
<p-drawer 
    [(visible)]="exibirModalPeneiraUmida" 
    position="full" 
>
    <div class="background-form">
        <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
            <div class="fg1 flex flex-column w-12 align-items-center">
                <p-card class="card w-12 text-center card-peneira">
                    <ng-template #header>
                        <div class="header-superficial w-full text-center">
                            <b>Peneiras Úmidas</b>
                        </div>
                    </ng-template>
                    <div class="flex flex-row w-12 gap-4 justify-content-start mb-3">
                            <label class="flex align-items-center gap-2">
                                <span class="font-semibold">Plano de Peneiras:</span>
                                <p-select
                                    [options]="planosPeneirasUmidas"
                                    [(ngModel)]="planoSelecionado"
                                    optionLabel="label"
                                    optionValue="value"
                                    placeholder="Selecione um plano"
                                    (onChange)="carregarPlanoPeneiraUmida($event.value)"
                                    appendTo="body"
                                    [showClear]="true"
                                    styleClass="w-15rem"
                                ></p-select>
                            </label>
                    </div>
                    <div class="flex flex-row w-12 gap-4 justify-content-start mb-3">
                        <label class="flex align-items-center gap-2">
                            Massa da Amostra:
                            <input 
                                pInputText 
                                id="massa_amostra" 
                                type="number" 
                                [(ngModel)]="massa_amostra_umida"
                                style="width: 150px;"
                                (ngModelChange)="recalcularTodasLinhas()"
                            />
                        </label> 
                    </div>
                    <div class="flex flex-row w-12 gap-3">
                        <div class="w-12">
                            <p-table [value]="linhasPeneiraUmida" stripedRows>
                                    <ng-template pTemplate="header">
                                    <tr>
                                        <th>Peneira</th>
                                        <th>Massa da Cápsula Vazia (g)</th>
                                        <th>Massa da Cápsula + Amostra Seca (g)</th>
                                        <th>Resultado Retido (%)</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                    <tr>
                                        <td>
                                            <p-floatLabel variant="on">
                                                <p-select
                                                    [options]="peneirasDados"
                                                    [(ngModel)]="linha.peneira"
                                                    optionLabel="value"
                                                    optionValue="value"
                                                    placeholder="Selecione a peneira"
                                                    appendTo="body"
                                                ></p-select>
                                                <label for="float-label">Peneiras</label>
                                            </p-floatLabel>
                                        </td>

                                        <td>
                                            <input 
                                                pInputText 
                                                [(ngModel)]="linha.massa_capsula_vazia"
                                                type="number"
                                                min="0"
                                                step="any"
                                                style="width: 150px"
                                                (ngModelChange)="recalcularLinha(linha)"
                                            />
                                        </td>

                                        <td>
                                        <input 
                                                pInputText 
                                                [(ngModel)]="linha.massa_capsula_seca"
                                                type="number"
                                                (ngModelChange)="recalcularLinha(linha)"
                                                style="width: 150px"
                                            />
                                        </td>

                                        <td>
                                            <input 
                                                pInputText 
                                                [(ngModel)]="linha.resultado"
                                                type="number"
                                                [readonly]="true"
                                                style="width: 150px"
                                            />
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                    <br>
                    <br>
                    <p-button 
                        (onClick)="addLinha()" 
                        label="Adicionar Linha"
                        iconPos="right"  
                        tooltipPosition="top"
                        pTooltip="Adicionar Linha"
                        icon="pi pi-plus"
                        severity="info"
                    />
                    <div class=" flex w-12 gap-3 mt-4 justify-content-center text-center">
                        <p-button 
                            label="Salvar Peneiras Umidas" 
                            severity="info"
                            icon="pi pi-check" 
                            iconPos="right" 
                            tooltipPosition="top"
                            pTooltip="Salvar Peneiras Umidas"
                            (onClick)="salvarPeneiraUmida(analise)"
                        />
                    </div>
                </p-card>
            </div>    
        </div>
    </div>
</p-drawer>


<!-- Visualizar peneira seca -->
<p-dialog 
    [(visible)]="modalVisualizarPeneira" 
    header="Peneiras Secas"
    position="top"
    [style]="{ height: '50vh' }"

>
    <div class="flex align-items-center gap-2 mb-2">
        <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
            <div class="fg1 flex flex-column w-12 align-items-center">

                <p-card class="card w-12 text-center card-peneira">
                  
                    <div class="flex flex-row w-12 gap-4 justify-content-start mb-3">
                        <label class="flex align-items-center gap-2">
                            Massa da Amostra:
                            <input 
                            pInputText 
                            id="massa_amostra" 
                            type="number" 
                            [(ngModel)]="massa_amostra"
                            [readonly]="true"
                            style="width: 150px;"
                            />
                        </label>

                        <label class="flex align-items-center gap-2">
                            Finos:
                            <input 
                            pInputText 
                            id="total_fino" 
                            type="number" 
                            [(ngModel)]="total_finos"
                            [readonly]="true"
                            style="width: 150px;"
                            />
                        </label>
                    </div>
                    <div class="flex flex-row w-12 gap-3">
                        <div class="w-12">
                            <p-table [value]="linhasPeneira" stripedRows>
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Peneira</th>
                                        <th>Retido (g)</th>
                                        <th>Retido (%)</th>
                                        <th>Passante (%)</th>
                                        <th>Acumulado (%)</th>
                                        <th>Passante Acumulado(%)</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                    <tr>
                                        <td>
                                            {{ linha.peneira }}
                                        </td>

                                        <td>
                                            {{ linha.valor_retido }}
                                        </td>

                                        <td>
                                            {{ linha.porcentual_retido }}
                                        </td>

                                        <td>
                                            {{ linha.passante }}
                                        </td>

                                        <td>
                                            {{ linha.acumulado }}
                                        </td>

                                        <td>
                                            {{ linha.passante_acumulado }}
                                        </td>                                      
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                
                </p-card>
            </div>    
        </div>
    </div>
</p-dialog>

<!-- Visualizar peneira umida -->
<p-dialog 
    [(visible)]="modalVisualizarPeneiraUmida" 
    header="Peneiras Úmidas"
    position="top"
    [style]="{ height: '50vh' }"

>
    <div class="flex align-items-center gap-2 mb-2">
        <div class="form-geral flex flex-column gap-3 w-12 lg:flex-row">
            <div class="fg1 flex flex-column w-12 align-items-center">

                <p-card class="card w-12 text-center card-peneira">
                  
                     <div class="flex flex-row w-12 gap-4 justify-content-start mb-3">
                        <label class="flex align-items-center gap-2">
                            Massa da Amostra:
                            <input 
                            pInputText 
                            id="massa_amostra" 
                            type="number" 
                            [(ngModel)]="massa_amostra_umida"
                            [readonly]="true"
                            style="width: 150px;"
                            />
                        </label>

                    
                    </div>
                    <div class="flex flex-row w-12 gap-3">
                        <div class="w-12">
                            <p-table [value]="linhasPeneiraUmida" stripedRows>
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Peneira</th>
                                        <th>Massa da Cápsula Vazia (g)</th>
                                        <th>Massa da Cápsula + Amostra Seca (g)</th>
                                        <th>Resultado Retido</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-linha let-i="rowIndex">
                                    <tr>
                                        <td>
                                            {{ linha.peneira }}
                                        </td>

                                        <td>
                                            {{ linha.massa_capsula_vazia }}
                                        </td>

                                        <td>
                                            {{ linha.massa_capsula_seca }}
                                        </td>
                                        <td>
                                            {{ linha.resultado }}
                                        </td>
                                    
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                </p-card>
            </div>    
        </div>
    </div>
</p-dialog>

<!-- Modal Variação Dimensional -->
<p-drawer 
    [(visible)]="exibirModalVariacaoDimensional" 
    position="full" 
>
   <div class="flex gap-4 mb-4 w-full">
        <div class="w-6">
            <label class="font-bold text-lg mb-1 block">Tempo de Trabalho</label>
            <input 
                pInputText 
                [(ngModel)]="variacao_dimensional_tempo_trabalho"
                placeholder="Informe o tempo trabalhado"
                style="width: 100%;"
            />
        </div>
        <div class="w-6">
            <label class="font-bold text-lg mb-1 block">Tempo Previsto</label>
            <input 
                pInputText 
                [(ngModel)]="variacao_dimensional_tempo_previsto"
                placeholder="Informe o tempo previsto"
                style="width: 100%;"
            />
        </div>
    </div>
    <!-- Seletor de Data Inicial -->
    <div class="mb-4">
        <label class="font-bold text-lg mb-2 block"> Data de Referência (L0)</label>
        <p-datePicker 
            [(ngModel)]="l0Data" 
            (ngModelChange)="onL0DataChange()"
            dateFormat="dd/mm/yy"
            placeholder="Selecione a data inicial"
            [style]="{'width':'100%'}"
        />
    </div>

    <!-- Tabela de Variação Dimensional -->
    <div class="mb-4" *ngIf="variacaoDimensionalTableData.length > 0">
        <h3 class="font-bold text-lg mb-3" style="color: #ffffff;"> Variação Dimensional</h3>
        <p-table 
            [value]="variacaoDimensionalTableData" 
            [tableStyle]="{'min-width': '50rem'}"
            styleClass="p-datatable-striped"
            [scrollable]="true"
            scrollHeight="400px"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 200px;">Período</th>
                    <th style="width: 150px;">Data</th>
                    <th style="width: 120px;">CP1 (mm)</th>
                    <th style="width: 120px;">CP2 (mm)</th>
                    <th style="width: 120px;">CP3 (mm)</th>
                    <th style="width: 150px;">Média (%)</th>
                    <th style="width: 150px;">Desvio Padrão</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="rowIndex">
                <tr>
                    <td>
                        <span class="font-semibold" [style]="{'font-size': '14px'}">{{ item.label }}</span>
                    </td>
                    <td>
                        <span class="text-sm">{{ item.data | date:'dd/MM/yyyy' }}</span>
                    </td>
                    <td>
                        <p-inputNumber
                            [ngModel]="i === 0 ? l0Cp1 : i === 1 ? l1Cp1 : i === 2 ? l7Cp1 : l28Cp1"
                            (ngModelChange)="i === 0 ? (l0Cp1 = $event) : i === 1 ? (l1Cp1 = $event) : i === 2 ? (l7Cp1 = $event) : (l28Cp1 = $event); realizarCalculosVariacaoDimensional()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                        ></p-inputNumber>
                    </td>
                    <td>
                        <p-inputNumber
                            [ngModel]="i === 0 ? l0Cp2 : i === 1 ? l1Cp2 : i === 2 ? l7Cp2 : l28Cp2"
                            (ngModelChange)="i === 0 ? (l0Cp2 = $event) : i === 1 ? (l1Cp2 = $event) : i === 2 ? (l7Cp2 = $event) : (l28Cp2 = $event); realizarCalculosVariacaoDimensional()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false"
                        ></p-inputNumber>
                    </td>
                    <td>
                        <p-inputNumber
                            [ngModel]="i === 0 ? l0Cp3 : i === 1 ? l1Cp3 : i === 2 ? l7Cp3 : l28Cp3"
                            (ngModelChange)="i === 0 ? (l0Cp3 = $event) : i === 1 ? (l1Cp3 = $event) : i === 2 ? (l7Cp3 = $event) : (l28Cp3 = $event); realizarCalculosVariacaoDimensional()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false"
                        ></p-inputNumber>
                    </td>
                    <td class="text-center">
                        <span 
                            *ngIf="item.media !== null && item.media !== undefined && !isNaN(item.media)" 
                            class="font-bold"
                            [style]="{'font-size': '16px'}"
                            [ngClass]="{
                                'text-green-600': item.media > 0,
                                'text-red-600': item.media < 0,
                                'text-gray-600': item.media === 0
                            }"
                        >
                            {{ item.media | number:'1.4-4' }}
                        </span>
                        <span *ngIf="item.media === null || item.media === undefined || isNaN(item.media)" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center">
                        <span *ngIf="item.desvioPadrao !== null && item.desvioPadrao !== undefined && !isNaN(item.desvioPadrao)" class="font-semibold">
                            {{ item.desvioPadrao | number:'1.4-4' }}
                        </span>
                        <span *ngIf="item.desvioPadrao === null || item.desvioPadrao === undefined || isNaN(item.desvioPadrao)" class="text-gray-400">-</span>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <p-button 
          label="Limpar" 
          icon="pi pi-eraser" 
          severity="info"
          iconPos="right"
          (onClick)="limparVariacaoDimensional()">
        </p-button>
        <p-button 
          label="Salvar" 
          icon="pi pi-check" 
          severity="success"
          iconPos="right"
          (onClick)="salvarVariacaoDimensional(analise)">
        </p-button>
    </div>

</p-drawer>

<!-- Modal Variação de Massa -->
<p-drawer 
    [(visible)]="exibirModalVariacaoMassa" 
    position="full" 
>
    <div class="flex gap-4 mb-4 w-full">
        <div class="w-6">
            <label class="font-bold text-lg mb-1 block">Tempo de Trabalho</label>
            <input 
                pInputText 
                [(ngModel)]="variacao_massa_tempo_trabalho"
                placeholder="Informe o tempo trabalhado"
                style="width: 100%;"
            />
        </div>
        <div class="w-6">
            <label class="font-bold text-lg mb-1 block">Tempo Previsto</label>
            <input 
                pInputText 
                [(ngModel)]="variacao_massa_tempo_previsto"
                placeholder="Informe o tempo previsto"
                style="width: 100%;"
            />
        </div>
    </div>
    <!-- Seletor de Data Inicial -->
    <div class="mb-4">
        <label class="font-bold text-lg mb-2 block"> Data de Referência (M0)</label>
        <p-datePicker 
            [(ngModel)]="m0Data" 
            (ngModelChange)="onM0DataChange()"
            dateFormat="dd/mm/yy"
            placeholder="Selecione a data inicial"
            [style]="{'width':'100%'}"
        />
    </div>
    <!-- Tabela de Variação de Massa -->
    <div class="mb-4" *ngIf="variacaoMassaTableData.length > 0">
        <h3 class="font-bold text-lg mb-3" style="color: #ffffff;"> Variação de Massa</h3>
        <p-table 
            [value]="variacaoMassaTableData" 
            [tableStyle]="{'min-width': '50rem'}"
            styleClass="p-datatable-striped"
            [scrollable]="true"
            scrollHeight="400px"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 200px;">Período</th>
                    <th style="width: 150px;">Data</th>
                    <th style="width: 150px;">CP1 (g)</th>
                    <th style="width: 150px;">CP2 (g)</th>
                    <th style="width: 150px;">CP3 (g)</th>
                    <th style="width: 150px;">Média (%)</th>
                    <th style="width: 150px;">Desvio Padrão</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="rowIndex">
                <tr>
                    <td>
                        <span class="font-semibold" [style]="{'font-size': '14px'}">{{ item.label }}</span>
                    </td>
                    <td>
                        <span class="text-sm">{{ item.data | date:'dd/MM/yyyy' }}</span>
                    </td>
                    <td>
                        <p-inputNumber
                            [ngModel]="i === 0 ? m0Cp1 : i === 1 ? m1Cp1 : i === 2 ? m7Cp1 : m28Cp1"
                            (ngModelChange)="i === 0 ? (m0Cp1 = $event) : i === 1 ? (m1Cp1 = $event) : i === 2 ? (m7Cp1 = $event) : (m28Cp1 = $event); realizarCalculosVariacaoMassa()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                        ></p-inputNumber>   
                    </td>
                    <td>
                        <p-inputNumber
                            [ngModel]="i === 0 ? m0Cp2 : i === 1 ? m1Cp2 : i === 2 ? m7Cp2 : m28Cp2"
                            (ngModelChange)="i === 0 ? (m0Cp2 = $event) : i === 1 ? (m1Cp2 = $event) : i === 2 ? (m7Cp2 = $event) : (m28Cp2 = $event); realizarCalculosVariacaoMassa()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                        ></p-inputNumber>
                    </td>
                    <td>
                        <p-inputNumber
                            [ngModel]="i === 0 ? m0Cp3 : i === 1 ? m1Cp3 : i === 2 ? m7Cp3 : m28Cp3"
                            (ngModelChange)="i === 0 ? (m0Cp3 = $event) : i === 1 ? (m1Cp3 = $event) : i === 2 ? (m7Cp3 = $event) : (m28Cp3 = $event); realizarCalculosVariacaoMassa()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                        ></p-inputNumber>
                    </td>
                    <td class="text-center">
                        <span 
                            *ngIf="item.media !== null && item.media !== undefined && !isNaN(item.media)" 
                            class="font-bold"
                            [style]="{'font-size': '16px'}"     
                            [ngClass]="{
                                'text-green-500': item.media >= 0.5,
                                'text-red-500': item.media < 0.5,    
                                'text-gray-600': item.media === 0
                            }"
                        >
                            {{ item.media | number:'1.2-4' }}
                        </span>
                        <span *ngIf="item.media === null || item.media === undefined || isNaN(item.media)" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center">
                        <span *ngIf="item.desvioPadrao !== null && item.desvioPadrao !== undefined && !isNaN(item.desvioPadrao)" class="font-semibold">
                            {{ item.desvioPadrao | number:'1.2-4' }}
                        </span>
                        <span *ngIf="item.desvioPadrao === null || item.desvioPadrao === undefined || isNaN(item.desvioPadrao)" class="text-gray-400">-</span>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <p-button 
          label="Limpar" 
          icon="pi pi-eraser" 
          severity="info"
          iconPos="right"
          (onClick)="limparVariacaoMassa()">
        </p-button>
        <p-button 
          label="Salvar" 
          icon="pi pi-check" 
          severity="success"
          iconPos="right"
          (onClick)="salvarVariacaoMassa(analise)">
        </p-button>
    </div>

</p-drawer>

<!-- Modal Módulo de Elasticidade -->
<p-drawer 
    [(visible)]="exibirModalModuloElasticidade" 
    position="full" 
>
    <div class="mb-4">
        <h2 class="font-bold text-2xl mb-4" style="color: #ffffff;">Módulo de Elasticidade Dinâmico</h2>
    </div>

    <div class="flex gap-4 mb-4 w-full">
        <div class="w-6">
            <label class="font-bold text-lg mb-1 block">Tempo de Trabalho</label>
            <input 
                pInputText 
                [(ngModel)]="elasticidade_tempo_trabalho"
                placeholder="Informe o tempo trabalhado"
                style="width: 100%;"
            />
        </div>
        <div class="w-6">
            <label class="font-bold text-lg mb-1 block">Tempo Previsto</label>
            <input 
                pInputText 
                [(ngModel)]="elasticidade_tempo_previsto"
                placeholder="Informe o tempo previsto"
                style="width: 100%;"
            />
        </div>
    </div>

    <!-- Tabela de Módulo de Elasticidade -->
    <div class="mb-4" *ngIf="moduloElasticidadeTableData.length > 0">
        <h3 class="font-bold text-lg mb-3" style="color: #ffffff;">Medições e Resultados</h3>
        <p-table 
            [value]="moduloElasticidadeTableData" 
            [tableStyle]="{'min-width': '80rem'}"
            styleClass="p-datatable-striped"
            [scrollable]="true"
            scrollHeight="500px"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 100px;">CP</th>
                    <th style="width: 120px;">Comprimento (mm)</th>
                    <th style="width: 120px;">Largura (mm)</th>
                    <th style="width: 120px;">Altura (mm)</th>
                    <th style="width: 120px;">Massa (g)</th>
                    <th style="width: 100px;">Tempo 1 (μs)</th>
                    <th style="width: 100px;">Tempo 2 (μs)</th>
                    <th style="width: 100px;">Tempo 3 (μs)</th>
                    <th style="width: 120px;">Menor Tempo (μs)</th>
                    <th style="width: 120px;">Volume (cm³)</th>
                    <th style="width: 120px;">P Max (g/cm³)</th>
                    <th style="width: 120px;">Velocidade (m/s)</th>
                    <th style="width: 150px;">Ed (GPa)</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="rowIndex">
                <tr>
                    <td>
                        <span class="font-semibold" [style]="{'font-size': '14px'}">{{ item.label }}</span>
                    </td>
                    <td *ngIf="i < 3">
                        <p-inputNumber
                            [ngModel]="i === 0 ? comprimentoCp1 : i === 1 ? comprimentoCp2 : comprimentoCp3"
                            (ngModelChange)="i === 0 ? (comprimentoCp1 = $event) : i === 1 ? (comprimentoCp2 = $event) : (comprimentoCp3 = $event); calculosModuloElasticidade()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                        ></p-inputNumber>
                    </td>
                    <td *ngIf="i < 3">
                        <p-inputNumber
                            [ngModel]="i === 0 ? larguraCp1 : i === 1 ? larguraCp2 : larguraCp3"
                            (ngModelChange)="i === 0 ? (larguraCp1 = $event) : i === 1 ? (larguraCp2 = $event) : (larguraCp3 = $event); calculosModuloElasticidade()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                        ></p-inputNumber>
                    </td>
                    <td *ngIf="i < 3">
                        <p-inputNumber
                            [ngModel]="i === 0 ? alturaCp1 : i === 1 ? alturaCp2 : alturaCp3"
                            (ngModelChange)="i === 0 ? (alturaCp1 = $event) : i === 1 ? (alturaCp2 = $event) : (alturaCp3 = $event); calculosModuloElasticidade()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                        ></p-inputNumber>
                    </td>
                    <td *ngIf="i < 3">
                        <p-inputNumber
                            [ngModel]="i === 0 ? massaCp1 : i === 1 ? massaCp2 : massaCp3"
                            (ngModelChange)="i === 0 ? (massaCp1 = $event) : i === 1 ? (massaCp2 = $event) : (massaCp3 = $event); calculosModuloElasticidade()"
                            mode="decimal"
                            [minFractionDigits]="0" 
                            [maxFractionDigits]="8" 
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                        ></p-inputNumber>
                    </td>
                    <td *ngIf="i < 3">
                        <p-inputnumber
                            mode="decimal"
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                            [minFractionDigits]="0"
                            [maxFractionDigits]="8"
                            [ngModel]="i === 0 ? tempo1Cp1 : i === 1 ? tempo1Cp2 : tempo1Cp3"
                            (ngModelChange)="i === 0 ? (tempo1Cp1 = +$event) : i === 1 ? (tempo1Cp2 = +$event) : (tempo1Cp3 = +$event); calculosModuloElasticidade()"
                    
                        />
                    </td>
                    <td *ngIf="i < 3">
                        <p-inputNumber
                            mode="decimal"
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                            [minFractionDigits]="0"
                            [maxFractionDigits]="8"
                            [ngModel]="i === 0 ? tempo2Cp1 : i === 1 ? tempo2Cp2 : tempo2Cp3"
                            (ngModelChange)="i === 0 ? (tempo2Cp1 = +$event) : i === 1 ? (tempo2Cp2 = +$event) : (tempo2Cp3 = +$event); calculosModuloElasticidade()"

                        />
                    </td>
                    <td *ngIf="i < 3">
                        <p-inputNumber
                            mode="decimal"
                            [style]="{'width':'20%'}"
                            variant="filled" 
                            size="large"
                            showButtons="false" 
                            [minFractionDigits]="0"
                            [maxFractionDigits]="8"
                            [ngModel]="i === 0 ? tempo3Cp1 : i === 1 ? tempo3Cp2 : tempo3Cp3"
                            (ngModelChange)="i === 0 ? (tempo3Cp1 = +$event) : i === 1 ? (tempo3Cp2 = +$event) : (tempo3Cp3 = +$event); calculosModuloElasticidade()"
                        />
                    </td>
                    <td class="text-center" *ngIf="i < 3">
                        <span *ngIf="item.menorTempo !== null && item.menorTempo !== undefined && !isNaN(item.menorTempo)" class="font-semibold">
                            {{ item.menorTempo | number:'1.2-2' }}
                        </span>
                        <span *ngIf="item.menorTempo === null || item.menorTempo === undefined || isNaN(item.menorTempo)" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center" *ngIf="i < 3">
                        <span *ngIf="item.volume !== null && item.volume !== undefined && !isNaN(item.volume)" class="font-semibold">
                            {{ item.volume | number:'1.2-3' }}
                        </span>
                        <span *ngIf="item.volume === null || item.volume === undefined || isNaN(item.volume)" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center" *ngIf="i < 3">
                        <span *ngIf="item.pMax !== null && item.pMax !== undefined && !isNaN(item.pMax)" class="font-semibold">
                            {{ item.pMax | number:'1.2-3' }}
                        </span>
                        <span *ngIf="item.pMax === null || item.pMax === undefined || isNaN(item.pMax)" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center" *ngIf="i < 3">
                        <span *ngIf="item.velocidade !== null && item.velocidade !== undefined && !isNaN(item.velocidade)" class="font-semibold">
                            {{ item.velocidade | number:'1.2-3' }}
                        </span>
                        <span *ngIf="item.velocidade === null || item.velocidade === undefined || isNaN(item.velocidade)" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center" [attr.colspan]="i === 3 ? 12 : 1" [ngStyle]="i === 3 ? {'text-align': 'left', 'padding-left': '20px'} : {}">
                        <span 
                            *ngIf="item.ed !== null && item.ed !== undefined && !isNaN(item.ed)" 
                            class="font-bold"
                            [style]="{'font-size': i === 3 ? '20px' : '16px'}"
                            [ngClass]="{
                                'text-blue-500': i < 3,
                                'text-green-500': i === 3
                            }"
                        >
                            {{ item.ed | number:'1.2-4' }} GPa
                        </span>
                        <span *ngIf="item.ed === null || item.ed === undefined || isNaN(item.ed)" class="text-gray-400">-</span>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <p-button 
          label="Limpar" 
          icon="pi pi-eraser" 
          severity="info"
          iconPos="right"
          (onClick)="limparModuloElasticidade()">
        </p-button>
        <p-button 
          label="Salvar" 
          icon="pi pi-check" 
          severity="success"
          iconPos="right"
          (onClick)="salvarModuloElasticidade(analise)">
        </p-button>
    </div>

</p-drawer>

<!-- ============================== Modal Deslizamento (Colantes) ============================== -->
<p-drawer 
    [(visible)]="exibirModalDeslizamento" 
    position="full" 
>
    <div class="flex gap-4 mb-4 w-full">
        <div class="w-6">
            <label class="font-bold text-lg mb-1 block">Tempo de Trabalho</label>
            <input 
                pInputText 
                [(ngModel)]="deslizamento_tempo_trabalho"
                placeholder="Informe o tempo trabalhado"
                style="width: 100%;"
            />
        </div>
        <div class="w-6">
            <label class="font-bold text-lg mb-1 block">Tempo Previsto</label>
            <input 
                pInputText 
                [(ngModel)]="deslizamento_tempo_previsto"
                placeholder="Informe o tempo previsto"
                style="width: 100%;"
            />
        </div>
    </div>

    <!-- Tabela de Deslizamento -->
    <div class="mb-4">
        <h3 class="font-bold text-lg mb-3" style="color: #ffffff;">Deslizamento (Colantes)</h3>
        <p-table 
            [value]="deslizamentoTableData" 
            [tableStyle]="{'min-width': '50rem'}"
            styleClass="p-datatable-striped"
            [scrollable]="true"
            scrollHeight="400px"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 200px; background-color: #8b4789; color: white;">Descrição</th>
                    <th style="width: 120px; background-color: #8b4789; color: white;">Medida Inicial 1</th>
                    <th style="width: 120px; background-color: #8b4789; color: white;">Medida Inicial 2</th>
                    <th style="width: 120px; background-color: #8b4789; color: white;">Medida Inicial 3</th>
                    <th style="width: 120px; background-color: #8b4789; color: white;">Medida Inicial 4</th>
                    <th style="width: 120px; background-color: #8b4789; color: white;">Medida Inicial 5</th>
                    <th style="width: 120px; background-color: #8b4789; color: white;">Medida Inicial 6</th>
                    <th style="width: 120px; background-color: #882447; color: white;">Medida Final 1</th>
                    <th style="width: 120px; background-color: #882447; color: white;">Medida Final 2</th>
                    <th style="width: 120px; background-color: #882447; color: white;">Medida Final 3</th>
                    <th style="width: 120px; background-color: #882447; color: white;">Medida Final 4</th>
                    <th style="width: 120px; background-color: #882447; color: white;">Medida Final 5</th>
                    <th style="width: 120px; background-color: #882447; color: white;">Medida Final 6</th>
                    <th style="width: 150px; background-color: #8b4789; color: white;">Resultado</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>
                        <span class="font-semibold" style="color: #8b4789;">{{ item.label }}</span>
                    </td>
                    <td style="background-color: rgba(139, 71, 137, 0.1);">
                        <span [style]="{'color': item.medidaInicial1 !== null ? '#000' : '#999'}">
                            {{ item.medidaInicial1 !== null ? (item.medidaInicial1 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(139, 71, 137, 0.1);">
                        <span [style]="{'color': item.medidaInicial2 !== null ? '#000' : '#999'}">
                            {{ item.medidaInicial2 !== null ? (item.medidaInicial2 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(139, 71, 137, 0.1);">
                        <span [style]="{'color': item.medidaInicial3 !== null ? '#000' : '#999'}">
                            {{ item.medidaInicial3 !== null ? (item.medidaInicial3 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(139, 71, 137, 0.1);">
                        <span [style]="{'color': item.medidaInicial4 !== null ? '#000' : '#999'}">
                            {{ item.medidaInicial4 !== null ? (item.medidaInicial4 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(139, 71, 137, 0.1);">
                        <span [style]="{'color': item.medidaInicial5 !== null ? '#000' : '#999'}">
                            {{ item.medidaInicial5 !== null ? (item.medidaInicial5 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(139, 71, 137, 0.1);">
                        <span [style]="{'color': item.medidaInicial6 !== null ? '#000' : '#999'}">
                            {{ item.medidaInicial6 !== null ? (item.medidaInicial6 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(136, 36, 71, 0.1);">
                        <span [style]="{'color': item.medidaFinal1 !== null ? '#000' : '#999'}">
                            {{ item.medidaFinal1 !== null ? (item.medidaFinal1 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(136, 36, 71, 0.1);">
                        <span [style]="{'color': item.medidaFinal2 !== null ? '#000' : '#999'}">
                            {{ item.medidaFinal2 !== null ? (item.medidaFinal2 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(136, 36, 71, 0.1);">
                        <span [style]="{'color': item.medidaFinal3 !== null ? '#000' : '#999'}">
                            {{ item.medidaFinal3 !== null ? (item.medidaFinal3 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(136, 36, 71, 0.1);">
                        <span [style]="{'color': item.medidaFinal4 !== null ? '#000' : '#999'}">
                            {{ item.medidaFinal4 !== null ? (item.medidaFinal4 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(136, 36, 71, 0.1);">
                        <span [style]="{'color': item.medidaFinal5 !== null ? '#000' : '#999'}">
                            {{ item.medidaFinal5 !== null ? (item.medidaFinal5 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(136, 36, 71, 0.1);">
                        <span [style]="{'color': item.medidaFinal6 !== null ? '#000' : '#999'}">
                            {{ item.medidaFinal6 !== null ? (item.medidaFinal6 | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                    <td style="background-color: rgba(139, 71, 137, 0.2);">
                        <span class="font-bold" style="color: #8b4789; font-size: 16px;">
                            {{ item.resultado !== null ? (item.resultado | number:'1.2-2') : '-' }}
                        </span>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <!-- Formulário de Entrada de Dados -->
    <div class="grid mb-4">
        <div class="col-12">
            <h4 class="font-bold mb-3" style="color: #8b4789;">Medidas Iniciais (mm)</h4>
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Inicial 1</label>
            <p-inputNumber 
                [(ngModel)]="medidaInicial1"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Inicial 2</label>
            <p-inputNumber 
                [(ngModel)]="medidaInicial2"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Inicial 3</label>
            <p-inputNumber 
                [(ngModel)]="medidaInicial3"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Inicial 4</label>
            <p-inputNumber 
                [(ngModel)]="medidaInicial4"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Inicial 5</label>
            <p-inputNumber 
                [(ngModel)]="medidaInicial5"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Inicial 6</label>
            <p-inputNumber 
                [(ngModel)]="medidaInicial6"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>

        <div class="col-12 mt-4">
            <h4 class="font-bold mb-3" style="color: #882447;">Medidas Finais (mm)</h4>
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Final 1</label>
            <p-inputNumber 
                [(ngModel)]="medidaFinal1"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Final 2</label>
            <p-inputNumber 
                [(ngModel)]="medidaFinal2"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Final 3</label>
            <p-inputNumber 
                [(ngModel)]="medidaFinal3"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Final 4</label>
            <p-inputNumber 
                [(ngModel)]="medidaFinal4"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Final 5</label>
            <p-inputNumber 
                [(ngModel)]="medidaFinal5"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
        <div class="col-12 md:col-6 lg:col-2">
            <label class="block mb-2">Medida Final 6</label>
            <p-inputNumber 
                [(ngModel)]="medidaFinal6"
                (ngModelChange)="calculosDeslizamento()"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                [style]="{'width':'100%'}"
                placeholder="0.00"
            />
        </div>
    </div>

    <!-- Card de Resultado -->
    <div class="mb-4" *ngIf="deslizamentoTotal !== null">
        <p-card styleClass="bg-purple-50">
            <div class="flex align-items-center justify-content-between">
                <div>
                    <p class="text-500 mb-2 font-semibold">Resultado do Deslizamento</p>
                    <p class="text-4xl font-bold m-0" style="color: #8b4789;">
                        {{ deslizamentoTotal | number:'1.2-2' }} mm
                    </p>
                </div>
                <i class="pi pi-arrow-down-right text-6xl" style="color: #8b4789; opacity: 0.3;"></i>
            </div>
        </p-card>
    </div>

    <!-- Botões de Ação -->
    <div class="flex gap-3 justify-content-end mt-4">
        <p-button 
          label="Fechar" 
          icon="pi pi-times" 
          severity="secondary"
          iconPos="right"
          (onClick)="exibirModalDeslizamento = false">
        </p-button>
        <p-button 
          label="Salvar" 
          icon="pi pi-check" 
          severity="success"
          iconPos="right"
          (onClick)="salvarDeslizamento(analise)">
        </p-button>
    </div>

</p-drawer>