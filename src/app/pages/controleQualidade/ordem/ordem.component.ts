import { trigger, transition, style, animate, keyframes } from '@angular/animations';
import { CommonModule, formatDate } from '@angular/common';
import { Component, OnInit, ViewChild } from '@angular/core';
import { ReactiveFormsModule, FormsModule, FormControl, FormGroup, Validators } from '@angular/forms';
import { RouterLink } from '@angular/router';
import { NzMenuModule } from 'ng-zorro-antd/menu';
import { MessageService, ConfirmationService } from 'primeng/api';
import { AutoCompleteModule } from 'primeng/autocomplete';
import { ButtonModule } from 'primeng/button';
import { ConfirmDialogModule } from 'primeng/confirmdialog';
import { DialogModule } from 'primeng/dialog';
import { DividerModule } from 'primeng/divider';
import { DrawerModule } from 'primeng/drawer';
import { DropdownModule } from 'primeng/dropdown';
import { FloatLabelModule } from 'primeng/floatlabel';
import { IconField, IconFieldModule } from 'primeng/iconfield';
import { InputGroupModule } from 'primeng/inputgroup';
import { InputGroupAddonModule } from 'primeng/inputgroupaddon';
import { InputIcon, InputIconModule } from 'primeng/inputicon';
import { InputMaskModule } from 'primeng/inputmask';
import { InputNumberModule } from 'primeng/inputnumber';
import { InputTextModule } from 'primeng/inputtext';
import { MultiSelectModule } from 'primeng/multiselect';
import { SelectModule } from 'primeng/select';
import { Table, TableModule } from 'primeng/table';
import { ToastModule } from 'primeng/toast';
import { SpeedDial, SpeedDialModule } from 'primeng/speeddial';
import { LoginService } from '../../../services/avaliacoesServices/login/login.service';
import { OrdemService } from '../../../services/controleQualidade/ordem.service';
import { string, boolean } from 'mathjs';
import { EnsaioService } from '../../../services/controleQualidade/ensaio.service';
import { CdkDragPlaceholder } from '@angular/cdk/drag-drop';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzUploadModule } from 'ng-zorro-antd/upload';
import { CardModule } from 'primeng/card';
import { DatePickerModule } from 'primeng/datepicker';
import { FieldsetModule } from 'primeng/fieldset';
import { InplaceModule } from 'primeng/inplace';
import { MenuModule } from 'primeng/menu';
import { SplitButtonModule } from 'primeng/splitbutton';
import { StepperModule } from 'primeng/stepper';
import { ToggleSwitchModule } from 'primeng/toggleswitch';
import { TooltipModule } from 'primeng/tooltip';
import { AnaliseService } from '../../../services/controleQualidade/analise.service';
import { AmostraService } from '../../../services/controleQualidade/amostra.service';
import { TagModule } from 'primeng/tag';
import { Amostra } from '../amostra/amostra.component';


import jsPDF from 'jspdf';
import autoTable, { CellInput } from "jspdf-autotable";


interface OrdemForm {
  data: FormControl,
  numero: FormControl,
  planoAnalise: FormControl,
  responsavel: FormControl,
  digitador: FormControl,
  classificacao: FormControl,
}

interface FileWithInfo {
  file: File;
  descricao: string;
}

export interface Ordem {
  id: number;
  numero: number;
  data: string;
  planoAnalise: any;
  responsavel: string;
  digitador: string;
  modificacoes: any;
  classificacao: any;
}

@Component({
  selector: 'app-ordem',
  imports: [
    ReactiveFormsModule, FormsModule, CommonModule, DividerModule, InputIconModule,InputMaskModule, DialogModule, ConfirmDialogModule, SelectModule, IconFieldModule, CardModule,FloatLabelModule, TableModule, InputTextModule, InputGroupModule, InputGroupAddonModule,ButtonModule, DropdownModule, ToastModule, NzMenuModule, DrawerModule, RouterLink, IconField,InputNumberModule, AutoCompleteModule, MultiSelectModule, DatePickerModule, StepperModule,InputIcon, FieldsetModule, MenuModule, SplitButtonModule, DrawerModule, SpeedDialModule, InplaceModule,NzButtonModule, NzIconModule, NzUploadModule, ToggleSwitchModule, TooltipModule, TagModule
  ],
  animations: [
    trigger('efeitoFade',[
      transition(':enter',[
        style({ opacity: 0 }),
        animate('2s', style({ opacity:1 }))
      ])
    ]),
    trigger('efeitoZoom', [
      transition(':enter', [
        style({ transform: 'scale(0)' }),
        animate('2s', style({ transform: 'scale(1)' })),
      ]),
    ]),
    trigger('bounceAnimation', [
      transition(':enter', [
        animate('4.5s ease-out', keyframes([
          style({ transform: 'scale(0.5)', offset: 0 }),
          style({ transform: 'scale(1.2)', offset: 0.5 }),
          style({ transform: 'scale(1)', offset: 1 }),
        ])),
      ]),
    ]),
    trigger('swipeAnimation', [
      transition(':enter', [
        style({ transform: 'translateX(-100%)' }),
        animate('1.5s ease-out', style({ transform: 'translateX(0)' })),
      ]),
      transition(':leave', [
        style({ transform: 'translateX(0)' }),
        animate('1.5s ease-out', style({ transform: 'translateX(100%)' })),
      ]),
    ]),
    trigger('swipeAnimationReverse', [
      transition(':enter', [
        style({ transform: 'translateX(100%)' }),
        animate('1.5s ease-out', style({ transform: 'translateX(0)' })),
      ]),
      transition(':leave', [
        style({ transform: 'translateX(0)' }),
        animate('1.5s ease-out', style({ transform: 'translateX(100%)' })),
      ]),
    ]),
  ],
  providers: [
    MessageService,ConfirmationService
  ],
  templateUrl: './ordem.component.html',
  styleUrl: './ordem.component.scss'
})
export class OrdemComponent implements OnInit {

  @ViewChild('dt1') dt1!: Table;
  inputValue: string = '';

  produtosFiltrados: any[] = [];
  materiaisFiltro: any[] = [];
  amostras: Amostra[] = [];

  ordens: Ordem[]=[];
  analises: any[] = [];
  uploadedFilesWithInfo: FileWithInfo[] = [];

  // Propriedades para dados da amostra recebida
  amostraData: any = null;
  amostraRecebida: any = null;
  imagensExistentes: any[] = [];
  planosAnalise: any[] = [];
  digitador: string = '';



  teste: any[] = [];




  isCreatingOrdem: boolean = false;
  isCreatingAnalise: boolean = false;
  registerOrdemForm!: FormGroup<OrdemForm>;

  classificacoes = [
  { id: 0, nome: 'Controle de Qualidade' },
  { id: 1, nome: 'SAC' },
  { id: 2, nome: 'Desenvolvimento de Produtos' },
]

  responsaveis = [
    { value: 'Antonio Carlos Vargas Sito' },
    { value: 'Fabiula Bueno' },
    { value: 'Janice Castro de Oliveira'},
    { value: 'Karine Urruth Kaizer'},
    { value: 'Luciana de Oliveira' },
    { value: 'Kaua Morales Silbershlach'},
    { value: 'Marco Alan Lopes'},
    { value: 'Maria Eduarda da Silva'},
    { value: 'Monique Barcelos Moreira'},
    { value: 'Renata Rodrigues Machado Pinto'},
    { value: 'S√¢mella de Campos Moreira'},
    { value: 'David Weslei Sprada'},
    { value: 'Camila Vitoria Carneiro Alves Santos'},
  ]

  materiais: any[] = [
    { value: 'Aditivos' },
    { value: 'Acabamento' },
    { value: 'Areia' },
    { value: 'Argamassa' },
    { value: 'Cal' },
    { value: 'Calcario' },
    { value: 'Cimento' },
    { value: 'Cinza Pozolana' },
    { value: 'Fertilizante' },
    { value: 'Finaliza' },
    { value: 'Mineracao' },
    { value: 'Areia' },
  ]

  finalidades = [
    { id: 0, nome: 'Controle de Qualidade' },
    { id: 1, nome: 'SAC' },
    { id: 2, nome: 'Desenvolvimento de Produtos' },
  ]
  
  router: any;
  constructor(
    private loginService: LoginService,
    private ordemService: OrdemService,
    private ensaioService: EnsaioService,
    private analiseService: AnaliseService,
    private messageService: MessageService,
    private confirmationService: ConfirmationService,
    private amostraService: AmostraService
  )
  
  {
    this.registerOrdemForm = new FormGroup<OrdemForm>({
      data: new FormControl('', [Validators.required]),
      numero: new FormControl('', [Validators.required]),
      planoAnalise: new FormControl('', [Validators.required]),
      responsavel: new FormControl('', [Validators.required]),
      digitador: new FormControl('', [Validators.required]),
      classificacao: new FormControl('', [Validators.required]),
    });
  }
  

 ngOnInit() {
    //this.digitador = this.loginService.getLoggedUser()?.nome || 'Sistema';
    
    // Receber dados da amostra se houver
    this.receberDadosAmostra();
    setTimeout(() => {
      if (!this.amostraData) {
        console.log('Tentando novamente ap√≥s delay...');
        this.receberDadosAmostra();
      }
    }, 100);


    // Carregar dados necess√°rios
    this.loadOrdens();
    this.loadAnalises();
    this.loadPlanosAnalise();
    this.configurarFormularioInicial();
    // this.loadAmostras();
  }

receberDadosAmostra(): void {
    // Tentar receber via navigation state
    if (window.history.state && window.history.state.amostraData) {
      this.amostraData = window.history.state.amostraData;
      console.log('‚úÖ Dados da amostra recebidos via history.state:', this.amostraData);
      
      // Carregar imagens existentes se houver
      if (this.amostraData.imagensExistentes && this.amostraData.imagensExistentes.length > 0) {
        console.log('üì∏ Imagens existentes encontradas:', this.amostraData.imagensExistentes);
        this.imagensExistentes = this.amostraData.imagensExistentes;
      }
      
      this.preencherFormularioComDadosAmostra();
      return;
    }

    // Tentar receber via sessionStorage como fallback
    const amostraDataSession = sessionStorage.getItem('amostraData');
    if (amostraDataSession) {
      try {
        this.amostraData = JSON.parse(amostraDataSession);
        console.log('‚úÖ Dados da amostra recebidos via sessionStorage:', this.amostraData);
        this.preencherFormularioComDadosAmostra();
        // Limpar sessionStorage ap√≥s uso
        sessionStorage.removeItem('amostraData');
        return;
      } catch (error) {
        console.error('‚ùå Erro ao processar dados do sessionStorage:', error);
      }
    }

    console.log('‚ÑπÔ∏è Nenhum dado da amostra foi recebido - criando ordem normal sem amostra pr√©-existente');
  }

  loadPlanosAnalise() {
    this.ensaioService.getPlanoAnalise().subscribe(
      response => {
        this.planosAnalise = response;
      },
      error => {
        console.log('Erro ao carregar planos de an√°lise', error);
      }
    );
  }


   configurarFormularioInicial(): void {
    // Buscar pr√≥ximo n√∫mero de ordem
    this.ordemService.getProximoNumero().subscribe({
      next: (numero) => {
        this.registerOrdemForm.patchValue({
          numero: numero,
          digitador: this.digitador,
          data: new Date(),
          classificacao: 'Controle de Qualidade'
        });
      },
      error: (error) => {
        console.error('Erro ao buscar pr√≥ximo n√∫mero:', error);
      }
    });
  }






onMaterialChange(materialNome: string) {
  console.log('Material selecionado:', materialNome);
  
  if (materialNome) {
    // Normaliza o nome e atualiza o formul√°rio
    const materialNormalizado = this.normalize(materialNome);
    console.log('Material normalizado:', materialNormalizado);
    
    // Atualiza o valor no formul√°rio com a vers√£o normalizada
    // this.registerOrdemForm.get('material')?.setValue(materialNormalizado, { emitEvent: false });
    
    // Usa a vers√£o normalizada para todas as opera√ß√µes
    this.amostraService.getProximoSequencialPorNome(materialNormalizado).subscribe({
      next: (sequencial) => {
        console.log('Sequencial recebido do backend:', sequencial);
        const numero = this.gerarNumero(materialNormalizado, sequencial);
        this.registerOrdemForm.get('numero')?.setValue(numero);
        console.log('N√∫mero da amostra gerado:', numero);
        this.loadProdutosPorMaterial(materialNormalizado);
      },
      error: (err) => {
        console.error('Erro ao buscar sequencial:', err);
        const sequencialFallback = this.gerarSequencialFallback(materialNormalizado);
        const numero = this.gerarNumero(materialNormalizado, sequencialFallback);
        this.registerOrdemForm.get('numero')?.setValue(numero);
        this.messageService.add({ 
          severity: 'warn', 
          summary: 'Aviso', 
          detail: 'Usando numera√ß√£o local. Verifique a conectividade.' 
        });
      }
    });
  }
}

private gerarSequencialFallback(materialNome: string): number {
  // Voc√™ pode usar timestamp + hash do nome do material
  const timestamp = Date.now();
  const hash = materialNome.split('').reduce((a, b) => {
    a = ((a << 5) - a) + b.charCodeAt(0);
    return a & a;
  }, 0);
  
  // Combina timestamp com hash para gerar um n√∫mero √∫nico
  return Math.abs((timestamp + hash) % 999999) + 1;
}

loadProdutosPorMaterial(materialNome: string): void {
  if (!materialNome) {
    this.produtosFiltrados = [];
    return;
  }

  this.amostraService.getProdutosPorMaterial(materialNome).subscribe({
    next: (response) => {
      this.produtosFiltrados = response;
      console.log('Produtos filtrados por material:', this.produtosFiltrados);
    },
    error: (err) => {
      console.error('Erro ao carregar produtos por material:', err);
      this.produtosFiltrados = [];
      this.messageService.add({ 
        severity: 'error', 
        summary: 'Erro', 
        detail: 'Erro ao carregar produtos para o material selecionado.' 
      });
    }
  });
}

gerarNumero(materialNome: string, sequencial: number): string {
  //const ano = new Date().getFullYear().toString().slice(-2); // 
  const sequencialFormatado = sequencial.toString().padStart(6, '0'); // Ex: '000008'
  // Formata como 08.392 
  const parte1 = sequencialFormatado.slice(0, 2); // '08'
  const parte2 = sequencialFormatado.slice(2);    // '0008' 
  return `${materialNome} ${parte1}.${parte2}`;
}

private normalize(str: string): string {
  if (!str) return '';
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
}



  analisesFiltradas: any[] = []; // array para exibir na tabela
  materiaisSelecionados: string[] = []; // valores escolhidos no multiselect
  loadAnalises(): void {
    this.analiseService.getAnalises().subscribe(
      (response: any[]) => {
        // Mapeia e cria campos "planos" para facilitar o filtro global
        this.analises = response.map((analise: any) => ({
          ...analise,
          material: analise.amostra_detalhes?.material ?? '',
          fornecedor: analise.amostra_detalhes?.fornecedor ?? '',
          numero: analise.amostra_detalhes?.numero ?? '',
          status: analise.amostra_detalhes?.status ?? '',
          responsavel: analise.amostra_detalhes?.expressa_detalhes?.responsavel ?? '',
          data_entrada: analise.amostra_detalhes?.data_entrada ?? '',
          data_coleta: analise.amostra_detalhes?.data_coleta ?? ''
        }));

        // Inicializa a lista filtrada
        this.analisesFiltradas = [...this.analises];

        // Cria op√ß√µes √∫nicas para o MultiSelect
        this.materiaisFiltro = this.analises
          .map((analise) => ({
            label: analise.material,
            value: analise.material
          }))
          .filter(
            (item, index, self) =>
              index === self.findIndex((opt) => opt.value === item.value)
          );
      },
      (error) => {
        console.error('Erro ao carregar an√°lises', error);
      }
    );
  }

  // Filtro Global
  filterTable(): void {
    if (this.dt1) {
      this.dt1.filterGlobal(this.inputValue, 'contains');
    }
  }

  // Filtro pelo MultiSelect
  filtrarPorMateriais(): void {
    if (this.materiaisSelecionados.length === 0) {
      this.analisesFiltradas = [...this.analises];
    } else {
      this.analisesFiltradas = this.analises.filter((analise) =>
        this.materiaisSelecionados.includes(analise.material)
      );
    }
  }

  loadOrdens():void{
    this.ordemService.getOrdens().subscribe(
      response => {
        this.ordens = response;
        console.log("Resposta: ", this.ordens);
      }, error => {
        console.log('Mensagem', error);
      }
    )
  }



  imprimirCalculoPDF(analise: any) {

  const doc = new jsPDF({ unit: "mm", format: "a4" });
  const logoBase64 = 'data:image/jpeg;base64,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RAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERBT31Tj7DeL/CqL5nVLW2tknqnH2G8X+FUXzOqWttejw303PqeoREW6giIgIiICIiAiIgL4qPaJPxD+xfa+Kj2iT8Q/sQb3rR9aaL8nj/2heVl3tFN/wBQ/sXq2j600X5PH/tC8zK45JIKcRxuds878oJ8S8zR9cOqWLouXvap/q8vxCne1T/V5fiFehmFXEi5e9qn+ry/EKd7VP8AV5fiFMwOJFy97VP9Xl+IU72qf6vL8QpmBxIuXvap/q8vxCne1T/V5fiFMwOJFztoqx2wbSTHf/2yuxDYrrMelI5o8ryGqJtWN5S6C7dtt81wqWxRtPKDu93iAXr0mJncOragbfcR/wASvepqWno4xFTRNY3zeP31hqcRERiphytAaA0eIbL9RFxLIf0I9vyv4XX75/KpgUP6Ee35X8Lr98/lUwK1t0RsIiKqRUSl1p4nNauIPOMG0Vzmis9rxMVRpYZKCCSKU07hFyve9hJMkocA7fYAjpt1VzNRMqp8GwLIsxquXudltdTXEE+yMcbnBvvkgD86qH6mdidRLZs11NucXdKm6V0dviqnHwn8oMkwPvvewrbTiIrN5Ut1mIS1wy8Tr9VZ67TjUe2tx/UewF8dfb3NMbaoMOzpImnsIPsmddt9xuOywaqfxmaE3iU03EZpIZaHNcTLaqr71b4dZTRj2zYeyfG3fcH2UfM077AGXOHDXey6/adU2U0Yip7tS8tNeKFrt+96kDqR4+R/smnybjckFResTHPXZMT1xKVERdW53O32W3VV3utXHS0VFE6eonkOzY42jdzifIAFksxrVbVPEtHMKrc5zKtMNFSANjiZsZamY78kMbftnu294AEnYAlUrzjXXi+u+llw4i6G+UmG4oK6CC0WaK3xTTVEEknJ3Zz5GEloO3hHYO6kABd2w09549NdpL/eIaiHSXB5yynpnEtbWv6EMO328mwc8jq2PlbuC4FWv15wamy/QvLcKooIKaOSyzR0rGxAMhMTOZga0DptyADbsXREV0piJ3+6k5t1h2NBdRJtVdIcXzyrdEay6UDH1gibs1tQ3wZAB4vCBWfqn/qaWZm8aR3nDKh+02PXVz44z2thqG8497+cEo/MrgLLUry3mFqzmMiIviaaKnifUVErIoo2l73v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arF7hfJGeO53GV7SfOyMsaf0Ka8T0+wXBKUUeGYhZ7JEG8pFDRxwlw/vFo3d+clUtxVY2haNKfu1w6M+p+arZ5UxXHUVrsMsu4c5s4a+vmHkbEDtH779iPuSthWlOkGCaMYxHiuCWdlJTjZ9RO8809VJtsZJX9rj/oPEAs0Rc2pq21N2laxXYUIcUf1lsP5ZL+7U3rC9TNNafUmjoaOou0tAKGV0odHEH8/M3bbqRsr8LqV0tat7bQrq1m1JiFPUVhPWt2z3Y1f6oz0k9a3bPdjV/qjPSXt/EOH/ADe0uHy+p2V7RWE9a3bPdjV/qjPST1rds92NX+qM9JPiHD/m9pPL6nZXtFYT1rds92NX+qM9JPWt2z3Y1f6oz0k+IcP+b2k8vqdle0VhPWt2z3Y1f6oz0k9a3bPdjV/qjPST4hw/5vaTy+p2V7RWLh4X8fa4Goyi4yAdoZFG3f8AavftfD1pxbnB9RSVlwcPFU1J5T+ZnKFW34loRtmf2Wjhryq9QW6vutUyitlFPVVEhAbHCwvcSfMFPmkmhVTaK2DJ8yYwVMBD6WhBDgx3ifIezceIDsUw2fHrHj8He1ktNJQx+MQRBm/vkdT+deguDiPxG2rHLSMR7t9Ph4pObdRERea6UQaEtc2fK+ZpG+W349Rt/wCvlUvrjZBBG8vZCxrnHckN2JK5FMzmcgiIoBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERB//Z';

  doc.addImage(logoBase64, 'PNG', 175, 3, 20, 5); // x, y, largura, altura

  let contadorLinhas = 45;
  autoTable(doc, {
    startY: 10,
    body: [
      [
        { content: "Ordem de Servi√ßo", styles: { halign: "left", fontStyle: "bold" } },
        { content: analise.numero, styles: { halign: "left", fontStyle: "bold" } },
        { content: "Data de Entrada: "+analise.data_entrada, styles: { halign: "left" } },
      ],
      [
        { content: "Material da Amostra: "+analise.material, colSpan: 2, styles: { halign: "left" } },
        { content: "Data de Amostra: "+analise.data_coleta, styles: { halign: "left" } }
      ],
      [
        { content: "Tipo: "+analise?.tipo_amostragem, styles: { halign: "left" } },
        { content: "Sub-tipo: "+analise?.subtipo, styles: { halign: "left" } },
        { content: "Data de Conclus√£o: ", styles: { halign: "left" } }
      ],
      [
        { content: "Local da Coleta: "+analise.local_coleta, colSpan: 2, styles: { halign: "left" } },
        { content: "Data de Descarte: ", styles: { halign: "left", fontStyle: "bold" } }
      ]
    ],
    theme: "grid",
    styles: {
      fontSize: 9,
      cellPadding: 2
    }
  });

  const body: any[] = [];
  const linha: any[] = [];

  linha.push({ content: "Ensaios", styles: { halign: "center",  fillColor: [128, 128, 128], textColor: [255, 255, 255], fontStyle: "bold" } });
  body.push(linha);


  autoTable(doc, {
    startY: contadorLinhas,
    body,
    theme: "grid",
    styles: { fontSize: 8, cellPadding: 2 }
  });

  contadorLinhas+=10;

  if(analise.expressa_detalhes){
    
    analise.expressa_detalhes.ensaio_detalhes.forEach((ensaio_detalhes: any) => {
      // monta a linha de forma din√¢mica
      const body: any[] = [];
      const linha: any[] = [];
      const linhaVazia: any[] = [];

      // primeira c√©lula: descri√ß√£o
      linha.push({ content: ensaio_detalhes.descricao, styles: { halign: "center",  } });
      linha.push({ content: 'T√©cnico', styles: { halign: "center" } });

      linhaVazia.push({ content: '', styles: { halign: "center" } });
      linhaVazia.push({ content: '', styles: { halign: "center" } });

      // adiciona cada vari√°vel como coluna
      ensaio_detalhes.variavel_detalhes.forEach((variavel_detalhes: any) => {
        linha.push({ content: variavel_detalhes.nome, styles: { halign: "center",  } });
        linhaVazia.push({ content: '', styles: { halign: "center" } });
      });

      // √∫ltima c√©lula: descri√ß√£o novamente (ou resultado final)
      linha.push({ content: ensaio_detalhes.descricao, styles: { halign: "center", fontStyle: "bold" } });
      linhaVazia.push({ content: '', styles: { halign: "center" } });

      // adiciona a linha no body
      body.push(linha);
      body.push(linhaVazia);
      // gera a tabela
      autoTable(doc, {
        startY: contadorLinhas,
        body,
        theme: "grid",
        styles: { fontSize: 8, cellPadding: 2 }
      });
      contadorLinhas+=20;
    });

  }else{
    analise.ordem_detalhes.plano_detalhes.forEach((plano_detalhes: any) => {
            
      //aqui √© o ennsaio_detalhes
      plano_detalhes.ensaio_detalhes.forEach((ensaio_detalhes: any) => {
        const body: any[] = [];
        const linha: any[] = [];
        const linhaVazia: any[] = [];
        
        linha.push({ content: ensaio_detalhes.descricao, styles: { halign: "center",  } });
        linha.push({ content: 'T√©cnico', styles: { halign: "center" } });

        linhaVazia.push({ content: '', styles: { halign: "center" } });
        linhaVazia.push({ content: '', styles: { halign: "center" } });

        ensaio_detalhes.variavel_detalhes.forEach((variavel_detalhes: any) => {
          linha.push({ content: variavel_detalhes.nome, styles: { halign: "center",  } });
          linhaVazia.push({ content: '', styles: { halign: "center" } });
        });    

        linha.push({ content: ensaio_detalhes.descricao, styles: { halign: "center",  } });
        linhaVazia.push({ content: '', styles: { halign: "center" } });
        
        body.push(linha);
        body.push(linhaVazia);

        autoTable(doc, {
          startY: contadorLinhas,
          body,
          theme: "grid",
          styles: { fontSize: 8, cellPadding: 2 }
        });

        contadorLinhas+=20;
      });

      if(plano_detalhes.calculo_ensaio_detalhes){
        const body: any[] = [];
        const linha: any[] = [];

        linha.push({ content: "C√°lculos", styles: { halign: "center",  fillColor: [128, 128, 128], textColor: [255, 255, 255], fontStyle: "bold" } });
        body.push(linha);

    
        autoTable(doc, {
          startY: contadorLinhas,
          body,
          theme: "grid",
          styles: { fontSize: 8, cellPadding: 2 }
        });

        contadorLinhas+=10;
          
        plano_detalhes.calculo_ensaio_detalhes.forEach((calculo_ensaio_detalhes: any) => {
          const body: any[] = [];
          const linha: any[] = [];

          linha.push({ content: calculo_ensaio_detalhes.descricao, styles: { halign: "center",  fillColor: [128, 128, 128], textColor: [255, 255, 255], fontStyle: "bold" } });
          body.push(linha);

      
          autoTable(doc, {
            startY: contadorLinhas,
            body,
            theme: "grid",
            styles: { fontSize: 8, cellPadding: 2 }
          });

          contadorLinhas+=7;

          calculo_ensaio_detalhes.ensaios_detalhes.forEach((ensaio_detalhes: any) => {
            const body: any[] = [];
            const linha: any[] = [];
            const linhaVazia: any[] = [];

            linha.push({ content: ensaio_detalhes.descricao, styles: { halign: "center",  } });
            linha.push({ content: 'T√©cnico', styles: { halign: "center" } });

            linhaVazia.push({ content: '', styles: { halign: "center" } });
            linhaVazia.push({ content: '', styles: { halign: "center" } });

            ensaio_detalhes.variavel_detalhes.forEach((variavel_detalhes: any) => {
              linha.push({ content: variavel_detalhes.nome, styles: { halign: "center",  } });
              linhaVazia.push({ content: '', styles: { halign: "center" } });
            });

            linha.push({ content: ensaio_detalhes.descricao, styles: { halign: "center",  } });
            linhaVazia.push({ content: '', styles: { halign: "center" } });

            body.push(linha);
            body.push(linhaVazia);
        
            autoTable(doc, {
              startY: contadorLinhas,
              body,
              theme: "grid",
              styles: { fontSize: 8, cellPadding: 2 }
            });

            contadorLinhas+=20;
          });
          
        });
      }
      
    });
  }
  
    const blobUrl = doc.output("bloburl");
    window.open(blobUrl, "_blank");
  
  //   // doc.save("Etiqueta.pdf");
  }

  getMenuItems(analise: any) {
    return [
      // { label: 'Visualizar', icon: 'pi pi-eye'},
      { label: 'Imprimir An√°lises', icon: 'pi pi-print', command: () => this.imprimirCalculoPDF(analise) },
      { label: 'Abrir OS', icon: 'pi pi-folder-open'},
      { label: 'Editar', icon: 'pi pi-pencil'},
      { label: 'Excluir', icon: 'pi pi-trash'},
      { label: 'Imagens', icon: 'pi pi-image'},
    ];
  }
  
  getSeverity(materialNome: string): 'success' | 'info' | 'warn' | 'danger' | 'secondary' | 'contrast' | undefined {
    if (!materialNome) {
      return 'secondary';
    }

    switch (materialNome.toLowerCase()) {
      case 'calcario':
        return 'warn';
      case 'acabamento':
        return 'success';
      case 'argamassa':
        return 'info';
      case 'cal':
        return 'danger';
      case 'mineracao':
        return 'contrast';
      default:
        return 'secondary';
    }

  }

  hasGroup(groups: string[]): boolean {
    return this.loginService.hasAnyGroup(groups);
  } 

  // M√©todo para preencher formul√°rio com dados da amostra
  preencherFormularioComDadosAmostra(): void {
    if (this.amostraData) {
      console.log('üìù Preenchendo formul√°rio com dados da amostra recebida');
      
      // Buscar pr√≥ximo n√∫mero e preencher com dados da amostra
      this.ordemService.getProximoNumero().subscribe({
        next: (numero) => {
          this.registerOrdemForm.patchValue({
            numero: numero,
            data: new Date(),
            digitador: this.digitador,
            classificacao: this.amostraData.finalidade || 'Controle de Qualidade',
            // responsavel ser√° selecionado pelo usu√°rio
            // planoAnalise ser√° selecionado pelo usu√°rio
          });
          
          console.log('‚úÖ Formul√°rio preenchido com dados da amostra');
        }
      });
    }
  }

// M√©todo principal para criar ordem e vincular amostra
  criarOrdemComAmostra(): void {
   if (!this.amostraData) {
      this.messageService.add({ 
        severity: 'error', 
        summary: 'Erro', 
        detail: 'Nenhum dado da amostra foi recebido' 
      });
      return;
    }

    // Validar se o formul√°rio est√° v√°lido
    if (!this.registerOrdemForm.valid) {
      this.messageService.add({ 
        severity: 'error', 
        summary: 'Erro', 
        detail: 'Preencha todos os campos obrigat√≥rios' 
      });
      return;
    }

    console.log('üöÄ Iniciando cria√ß√£o da ordem - Fluxo: Ordem ‚Üí Amostra ‚Üí An√°lise');

    //Criar ordem expressa
    let dataFormatada = '';
    const dataValue = this.registerOrdemForm.value.data;
    if (dataValue instanceof Date && !isNaN(dataValue.getTime())) {
      dataFormatada = formatDate(dataValue, 'yyyy-MM-dd', 'en-US');
    }

    console.log('üìù Criando ordem expressa...');

    console.log('üöÄ Iniciando cria√ß√£o de Ordem Normal');
    console.log('üìã Dados da ordem:', this.registerOrdemForm.value);
    console.log('üìã Dados da amostra recebida:', this.amostraData);

    // Criar a ordem de servi√ßo normal
    this.ordemService.registerOrdem(
      dataFormatada,
      this.registerOrdemForm.value.numero,
      this.registerOrdemForm.value.planoAnalise,
      this.registerOrdemForm.value.responsavel,
      this.registerOrdemForm.value.digitador,
      this.registerOrdemForm.value.classificacao
    ).subscribe({
      next: (ordemSalva) => {
        console.log('‚úÖ Ordem Normal criada:', ordemSalva);
        
        if (this.amostraData) {
          // Vincular amostra EXISTENTE √† ordem rec√©m-criada
          this.vincularAmostraExistenteAOrdem(ordemSalva.id);
        } else {
          this.finalizarComErro('Nenhuma amostra foi recebida para vincular √† ordem');
        }
      },
      error: (err) => {
        this.isCreatingOrdem = false;
        console.error('‚ùå Erro ao criar ordem normal:', err);
        this.tratarErroOperacao(err, 'criar ordem de servi√ßo normal');
      }
    });
  }

  private vincularAmostraExistenteAOrdem(ordemId: number): void {
  console.log('üîó Vinculando amostra EXISTENTE √† ordem:', ordemId);
  console.log('üìã Dados da amostra para vincular:', this.amostraData);

  // Verificar se temos o ID da amostra nos dados recebidos
  if (!this.amostraData.id) {
    console.error('‚ùå ID da amostra n√£o encontrado nos dados recebidos');
    this.finalizarComErro('ID da amostra n√£o encontrado para vincular √† ordem');
    return;
  }

  // Atualizar amostra DIRETAMENTE com o ID que j√° temos
  const dadosAtualizacao = {
    ordem: ordemId
  };
  
  console.log('üîÑ Atualizando amostra ID', this.amostraData.id, 'com ordem ID:', ordemId);
  
  this.amostraService.updateAmostra(this.amostraData.id, dadosAtualizacao).subscribe({
    next: (amostraAtualizada) => {
      console.log('‚úÖ Amostra vinculada √† ordem:', amostraAtualizada);
      this.amostraRecebida = amostraAtualizada;
      
      // Criar an√°lise para a amostra vinculada
      this.criarAnaliseParaAmostra(amostraAtualizada.id);
    },
    error: (err) => {
      console.error('‚ùå Erro ao vincular amostra √† ordem:', err);
      this.finalizarComErro('Erro ao vincular amostra √† ordem');
    }
  });
} 

private buscarAmostraPorIdAlternativo(ordemId: number): void {
    console.log('üîç Buscando amostra por m√©todo alternativo...');
    
    // Se voc√™ tiver o ID da amostra nos dados recebidos
    if (this.amostraData.id) {
      console.log('üÜî Usando ID da amostra dos dados recebidos:', this.amostraData.id);
      
      const dadosAtualizacao = {
        ordem: ordemId
      };
      
      this.amostraService.updateAmostra(this.amostraData.id, dadosAtualizacao).subscribe({
        next: (amostraAtualizada) => {
          console.log('‚úÖ Amostra vinculada √† ordem (m√©todo alternativo):', amostraAtualizada);
          this.amostraRecebida = amostraAtualizada;
          
          // Criar an√°lise para a amostra vinculada
          this.criarAnaliseParaAmostra(amostraAtualizada.id);
        },
        error: (err) => {
          console.error('‚ùå Erro ao vincular amostra (m√©todo alternativo):', err);
          this.finalizarComErro('Erro ao vincular amostra √† ordem');
        }
      });
    } else {
      // Buscar todas as amostras e filtrar
      this.amostraService.getAmostras().subscribe({
        next: (amostras) => {
          const amostraEncontrada = amostras.find((a: { numero: any; }) => a.numero === this.amostraData.numero);
          
          if (amostraEncontrada) {
            console.log('üìã Amostra encontrada por busca geral:', amostraEncontrada);
            
            const dadosAtualizacao = {
              ordem: ordemId
            };
            
            this.amostraService.updateAmostra(amostraEncontrada.id, dadosAtualizacao).subscribe({
              next: (amostraAtualizada) => {
                console.log('‚úÖ Amostra vinculada √† ordem:', amostraAtualizada);
                this.amostraRecebida = amostraAtualizada;
                
                // Criar an√°lise para a amostra vinculada
                this.criarAnaliseParaAmostra(amostraAtualizada.id);
              },
              error: (err) => {
                console.error('‚ùå Erro ao vincular amostra:', err);
                this.finalizarComErro('Erro ao vincular amostra √† ordem');
              }
            });
          } else {
            console.error('‚ùå Amostra n√£o encontrada na lista geral');
            this.finalizarComErro('Amostra n√£o encontrada para vincular √† ordem');
          }
        },
        error: (err) => {
          console.error('‚ùå Erro ao buscar lista de amostras:', err);
          this.finalizarComErro('Erro ao buscar amostra para vincular √† ordem');
        }
      });
    }
  }
criarOSDoFormulario() {
  console.log('üöÄ Iniciando cria√ß√£o de OS do formul√°rio');

  // Valida√ß√£o para campos  m√≠nimos
  const camposEssenciais = {
    'material': 'Material',
    'tipoAmostra': 'Tipo de Amostra', 
    'dataColeta': 'Data de Coleta',
    'dataEntrada': 'Data de Entrada',
    'finalidade': 'Finalidade',
    'fornecedor': 'Fornecedor',
    'status': 'Status'
  };
}

private criarAnaliseParaAmostra(amostraId: number): void {
    console.log('üìä Criando an√°lise para amostra:', amostraId);
    
    this.isCreatingAnalise = true;

    this.analiseService.registerAnalise(amostraId, 'PENDENTE').subscribe({
      next: (analiseCriada) => {
        console.log('‚úÖ An√°lise criada:', analiseCriada);
        
        // Navegar para a p√°gina de an√°lise
        this.navegarParaAnalise(analiseCriada.id);
      },
      error: (err) => {
        console.error('‚ùå Erro ao criar an√°lise:', err);
        this.finalizarComErro('Ordem criada e amostra vinculada, mas erro ao criar an√°lise');
      }
    });
  }

  // M√©todo para navegar para a an√°lise
  private navegarParaAnalise(analiseId: number): void {
    console.log('üîÑ Navegando para an√°lise:', analiseId);
    
    this.messageService.add({
      severity: 'success',
      summary: 'Sucesso',
      detail: `Ordem Normal criada, amostra vinculada e an√°lise criada! Redirecionando...`
    });
    
    // Redirecionar para a p√°gina de an√°lise ap√≥s delay
    setTimeout(() => {
      this.router.navigate(['/welcome/controleQualidade/analise'], {
        queryParams: { id: analiseId }
      });
    }, 2000);
    
    this.finalizarProcesso();
  }

  // M√©todo para finalizar com sucesso (sem an√°lise)
  private finalizarComSucesso(ordemId: number, amostraId: number | null): void {
    this.messageService.add({
      severity: 'success',
      summary: 'Sucesso',
      detail: 'Ordem de Servi√ßo criada e amostra vinculada com sucesso!'
    });
    
    this.finalizarProcesso();
  }

  // M√©todo para finalizar com erro
  private finalizarComErro(mensagem: string): void {
    this.messageService.add({
      severity: 'error',
      summary: 'Erro',
      detail: mensagem
    });
    
    this.finalizarProcesso();
  }

  // M√©todo para finalizar processo
  private finalizarProcesso(): void {
    this.isCreatingOrdem = false;
    this.isCreatingAnalise = false;
    
    // Limpar dados da amostra
    this.amostraData = null;
    this.amostraRecebida = null;
    this.imagensExistentes = [];
    
    // Resetar formul√°rio
    this.registerOrdemForm.reset();
    this.configurarFormularioInicial();
  }

  // M√©todo auxiliar para formatar datas
  private formatarData(data: any): string | null {
    if (!data) return null;
    
    if (data instanceof Date && !isNaN(data.getTime())) {
      return formatDate(data, 'yyyy-MM-dd', 'en-US');
    }
    
    if (typeof data === 'string') {
      return data;
    }
    
    return null;
  }

  // M√©todo para tratar erros
  private tratarErroOperacao(err: any, operacao: string): void {
    console.error(`Erro ao ${operacao}:`, err);
    
    if (err.status === 401) {
      this.messageService.add({ 
        severity: 'error', 
        summary: 'Timeout!', 
        detail: 'Sess√£o expirada! Por favor fa√ßa o login novamente.' 
      });
    } else if (err.status === 403) {
      this.messageService.add({ 
        severity: 'error', 
        summary: 'Erro!', 
        detail: 'Acesso negado! Voc√™ n√£o tem autoriza√ß√£o para esta opera√ß√£o.' 
      });
    } else if (err.status === 400) {
      this.messageService.add({ 
        severity: 'error', 
        summary: 'Erro!', 
        detail: 'Dados inv√°lidos. Verifique o preenchimento e tente novamente.' 
      });
    } else {
      this.messageService.add({ 
        severity: 'error', 
        summary: 'Falha!', 
        detail: `Erro interno ao ${operacao}. Contate o administrador.` 
      });
    }
  }





}
